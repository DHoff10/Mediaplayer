/*
  Javascript port of CubicVR 3D engine for WebGL
  by Charles J. Cliffe
  http://www.cubicvr.org/

  May be used under the terms of the MIT license.
  http://www.opensource.org/licenses/mit-license.php
*/

/*globals alert: false */
try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(e$$5){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(t,y,s,o,r){function m(a,b){w.registry[a]=!0;var g=b(w),q;for(q in g)g.hasOwnProperty(q)&&(d[q]=g[q])}var c="";try{for(var h=y.querySelectorAll("script"),a=0,b=h.length;a<b;a++){var e=h[a].src.lastIndexOf("/CubicVR.js");e>-1&&(c=h[a].src.substr(0,e)+"/")}}catch(g){}var d=t.CubicVR={},q={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,resize_active:!1,
emptyLight:null,resizeList:[],canvasSizeFactor:1},n;try{n=console!==void 0&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(v){n=o}var C={quality:{LOW:0,MEDIUM:1,HIGH:2}},w={undef:r,scriptLocation:c,GLCore:q,Textures:[],Textures_obj:[],Textures_ref:[],Images:[],ShaderPool:[],log:n,registry:{},enums:C,MAX_LIGHTS:6,features:{},quality:C.HIGH},O={low:{antiAlias:!1,lightPerPixel:!1,lightShadows:!1,texturePerPixel:!1,postProcess:!1},medium:{antiAlias:!1,lightPerPixel:!0,lightShadows:!1,
texturePerPixel:!1,postProcess:!1},high:{antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0}};w.features=O.high;q.init=function(a,b,g){var e,h=d.util;b&&g?(b=h.getScriptContents(b),g=h.getScriptContents(g)):d.CubicVRCoreVS&&d.CubicVRCoreFS?(b=d.CubicVRCoreVS,g=d.CubicVRCoreFS):(b=h.getScriptContents(c+"CubicVR_Core.vs"),g=h.getScriptContents(c+"CubicVR_Core.fs"));if(a===r){a=y.createElement("canvas");e||(e=a.getContext("experimental-webgl",{antialias:w.features.antiAlias}));
q.gl=e;if(q.fixed_size!==null)q.width=q.fixed_size[0],q.height=q.fixed_size[1],q.resizeElement(a,q.width,q.height);else if(q.addResizeable(a),q.canvasSizeFactor!==1&&a.getContext!==r){var h=s.round(t.innerWidth*q.canvasSizeFactor),v=s.round(t.innerHeight*q.canvasSizeFactor);q.resizeElement(a,h,v);a.style.top=t.innerHeight/2-v/2+"px";a.style.left=t.innerWidth/2-h/2+"px";a.style.position="absolute"}else q.resizeElement(a,t.innerWidth,t.innerHeight);y.body.appendChild(a)}if(a.getContext!==r&&a.width!==
r&&a.height!==r){try{e||(e=a.getContext("experimental-webgl")),e.viewport(0,0,a.width,a.height),q.canvas=a,q.width=a.width,q.height=a.height,e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL)}catch(m){}if(!e)return null}else e=a;q.gl=e;q.CoreShader_vs=b;q.CoreShader_fs=g;e.enable(e.CULL_FACE);e.cullFace(e.BACK);e.frontFace(e.CCW);for(b=C.light.type.NULL;b<C.light.type.MAX;b++)w.ShaderPool[b]=[];g=new d.Texture;a=new d.Material;for(b=0;b<C.texture.map.MAX;b++)b!==C.texture.map.BUMP&&
a.setTexture(g,b);a.opacity=0.5;b=1;try{for(;;){a.use(C.light.type.POINT,b);if(b===8){w.MAX_LIGHTS=b;break}b++}}catch(o){w.MAX_LIGHTS=b}a=q.emptyLight=new d.Light(C.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;n("Calibrated maximum lights per pass to: "+b);for(b=C.light.type.NULL;b<C.light.type.MAX;b++)w.ShaderPool[b]=[];if(q.resizeList.length)t.addEventListener("resize",function(){d.GLCore.onResize()},!1),q.resize_active=!0;return e};q.addResizeable=
function(a){d.GLCore.resizeList.push(a)};q.onResize=function(){var a=t.innerWidth,b=t.innerHeight;q.fixed_size!==null&&(a=d.GLCore.fixed_size[0],b=d.GLCore.fixed_size[1]);for(var g=0,e=d.GLCore.resizeList.length;g<e;g++)q.resizeElement(d.GLCore.resizeList[g],a,b)};q.setFixedAspect=function(a){d.GLCore.fixed_aspect=a};q.setFixedSize=function(a,b){d.GLCore.fixed_size=[a,b]};q.getCanvas=function(){return d.GLCore.canvas};q.resizeElement=function(a,b,g){var e=q.gl;if(q.fixed_aspect!==0){var n=b*(1/d.GLCore.fixed_aspect);
n>g&&(n=g,b=g*d.GLCore.fixed_aspect);g=n}if(a.getContext!==r){a.width=b;a.height=g;if(!d.GLCore.fixed_size)a.style.left=(t.innerWidth/2-b/2|0)+"px",a.style.top=(t.innerHeight/2-g/2|0)+"px",a.style.position="absolute";e.viewport(0,0,b,g)}else a.resize(b,g)};q.setDepthAlpha=function(a,d,b){q.depth_alpha=a;q.depth_alpha_near=d;q.depth_alpha_far=b};q.setDefaultFilter=function(a){q.default_filter=a};q.setSoftShadows=function(a){q.soft_shadow=a};q.setCanvasSizeFactor=function(a){q.canvasSizeFactor=a};q.setQuality=
function(a){if(a===C.quality.HIGH)w.features=O.high;else if(a===C.quality.MEDIUM)w.features=O.medium;else if(a===C.quality.LOW)w.features=O.low;w.quality=a;return w.features};q.getQuality=function(){return w.features};var E={GLCore:q,init:q.init,addResizeable:q.addResizeable,setFixedAspect:q.setFixedAspect,setFixedSize:q.setFixedSize,setCanvasSizeFactor:q.setCanvasSizeFactor,getCanvas:q.getCanvas,enums:C,IdentityMatrix:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Textures:w.Textures,Textures_obj:w.Textures_obj,
Images:w.Images,globalAmbient:[0.1,0.1,0.1],setGlobalAmbient:function(a){d.globalAmbient=a},setGlobalDepthAlpha:q.setDepthAlpha,setDefaultFilter:q.setDefaultFilter,setSoftShadows:q.setSoftShadows,setQuality:q.setQuality,getQuality:q.getQuality,RegisterModule:m,getScriptLocation:function(){return c}};m("Core",function(){return E})})(window,window.document,Math,function(){});
(function(){function t(){for(var m=0;m<y.length;m++)importScripts(CubicVR.getScriptLocation()+"/source/CubicVR."+y[m]+".js")}var y=["Math","Utility","Shader","MainLoop","Texture","Material","Mesh","UVMapper","Renderer","Light","Camera","Motion","Scene","PostProcess","Layout","Primitives","COLLADA","GML","Particles","Landscape","Octree","CVRXML","Worker","Polygon","ScenePhysics","CollisionMap"];try{for(var s=0;s<y.length;s++)document.write('<script type="text/javascript" src="'+CubicVR.getScriptLocation()+
"/source/CubicVR."+y[s]+'.js"><\/script>')}catch(o){var r=function(m){var c=m.data.data+"";CubicVR.getScriptLocation=function(){return c};t();self.removeEventListener("message",r,!1);CubicVR.InitWorker()};self.addEventListener("message",r,!1)}})();CubicVR.RegisterModule("COLLADA",function(t){function y(h,a){function b(a){if(!a.color)return!1;return(a=a.color)?g.floatDelimArray(a.$," "):!1}function e(a){var L;if(!a["float"])return!1;return L=(a=a["float"])?parseFloat(a.$):0,a=L}var g=CubicVR.util;new CubicVR.Mesh;new CubicVR.Scene;var d,q,n,v,C;cl=typeof h=="object"?h:h.indexOf(".js")!=-1?g.getJSON(h):CubicVR.util.xml2badgerfish(g.getXML(h));var w,r,E,B,x,A,z,u,t,D=cl;cl=null;if(!D.COLLADA)throw Error(h+" does not appear to be a valid COLLADA file.");
var D=D.COLLADA,H={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(D.asset){var y=D.asset.up_axis.$;if(y==="X_UP")H.up_axis=0;else if(y==="Y_UP")H.up_axis=1;else if(y==="Z_UP")H.up_axis=2}y=H.up_axis;if(D.library_images){if(D.library_images.image&&!D.library_images.image.length)D.library_images.image=[D.library_images.image];if(D.library_images.image.length){q=D.library_images.image;x=0;for(var F=q.length;x<F;x++){var J=q[x],G=J["@id"];d=J["@name"];
J=J.init_from;if(J.$)J=J.$,a!==s&&J.lastIndexOf("/")!==-1&&(J=J.substr(J.lastIndexOf("/")+1)),a!==s&&J.lastIndexOf("\\")!==-1&&(J=J.substr(J.lastIndexOf("\\")+1)),H.images[G]={source:J,id:G,name:d}}}}var I,K,N,S;if(D.library_effects){var M=D.library_effects.effect;M&&!M.length&&(M=[M]);J=0;for(I=M.length;J<I;J++){x=M[J];G=x["@id"];C={};C.id=G;C.surfaces=[];C.samplers=[];(F=x.profile_COMMON.newparam)&&!F.length&&(F=[F]);if(F){q=0;for(n=F.length;q<n;q++){var P=F[q];d=P["@sid"];if(P.surface){if(C.surfaces[d]=
{},P=P.surface.init_from.$,typeof H.images[P]==="object")C.surfaces[d].source=a+"/"+H.images[P].source}else if(P.sampler2D){C.samplers[d]={};C.samplers[d].source=P.sampler2D.source.$;if(P.sampler2D.minfilter)C.samplers[d].minfilter=P.sampler2D.minfilter.$;if(P.sampler2D.magfilter)C.samplers[d].magfiter=P.sampler2D.magfilter.$}}}(q=x.profile_COMMON.technique)&&!q.length&&(q=[q]);C.material={textures_ref:[]};x=0;for(F=q.length;x<F;x++){d=q[x].blinn;if(!d)d=q[x].phong;if(!d)d=q[x].lambert;if(d)for(u in d){var U=
d[u];n=b(U);P=e(U);U=U.texture?U.texture["@texture"]:!1;n!==!1&&n.length>3&&n.pop();if(u=="emission"){if(n!==!1)C.material.ambient=n}else if(u!="ambient")if(u=="diffuse"){if(n!==!1)C.material.color=n}else if(u=="specular"){if(n!==!1)C.material.specular=n}else if(u=="shininess"&&P!==!1)C.material.shininess=P;if(U!==!1)n=C.surfaces[C.samplers[U].source].source,u=="emission"?C.material.textures_ref.push({image:n,type:o.texture.map.AMBIENT}):u=="ambient"?C.material.textures_ref.push({image:n,type:o.texture.map.AMBIENT}):
u=="diffuse"?C.material.textures_ref.push({image:n,type:o.texture.map.COLOR}):u=="specular"?C.material.textures_ref.push({image:n,type:o.texture.map.SPECULAR}):u!="shininess"&&(u=="reflective"?C.material.textures_ref.push({image:n,type:o.texture.map.REFLECT}):u!="reflectivity"&&u=="transparent"&&C.material.textures_ref.push({image:n,type:o.texture.map.ALPHA}))}H.effects[G]=C}}}x=c.getAllOf(D.library_visual_scenes,"instance_material");u=[];if(x.length){n=0;for(q=x.length;n<q;n++)G=x[n],F=G["@symbol"],
G=G["@target"].substr(1),u[F]=G}q=D.library_materials;if(q.material){(F=q.material)&&!F.length&&(F=[F]);q=0;for(x=F.length;q<x;q++)if(G=F[q],d=G["@id"],J=G["@name"],G=G.instance_effect)G=G["@url"].substr(1),H.materials.push({id:d,name:J,mat:H.effects[G].material})}q=D.library_geometries;var W;if(q&&((G=q.geometry)&&!G.length&&(G=[G]),G.length)){d=0;for(J=G.length;d<J;d++){I={id:s,points:[],parts:[]};var V=G[d].mesh;if(V){W=G[d]["@id"];C=G[d]["@name"];(x=V.source)&&!x.length&&(x=[x]);M=[];F=0;for(n=
x.length;F<n;F++){P=x[F];q=P["@id"];var U=P["@name"],Y=P.float_array;Y&&(M[q]={id:q,name:U,data:g.floatDelimArray(Y.$?Y.$:""," ")});if(P=P.technique_common.accessor)if(M[q].count=P["@count"]|0,M[q].stride=P["@stride"]|0,M[q].count)M[q].data=g.repackArray(M[q].data,M[q].stride,M[q].count)}q=V.vertices;var Z=Y=U=P=null,$=null;if(q&&(U=q["@id"],(n=q.input)&&!n.length&&(n=[n]),n)){E=0;for(w=n.length;E<w;E++)K=n[E],K["@semantic"]==="POSITION"&&(P=K["@source"].substr(1))}var T=V.triangles;T&&!T.length&&
(T=[T]);if(T){x=0;for(F=T.length;x<F;x++){S={material:0,faces:[],normals:[],texcoords:[],colors:[]};q=parseInt(T[x]["@count"],10);(n=T[x].input)&&!n.length&&(n=[n]);N=[];if(n.length){E=0;for(w=n.length;E<w;E++)K=n[E],B=parseInt(K["@offset"],10),v=K["@source"].substr(1),K["@semantic"]==="VERTEX"?(v===U&&(v=P),N[B]=0):K["@semantic"]==="NORMAL"?(Y=v,M[Y].count&&(N[B]=1)):K["@semantic"]==="TEXCOORD"?($=v,M[$].count&&(N[B]=2)):K["@semantic"]==="COLOR"?(Z=v,M[Z].count&&(N[B]=3)):N[B]=4}E=N.length;n=T[x]["@material"];
n===null?S.material=0:u[n]===s?(m("missing material ["+n+"]@"+C+"?"),S.material=0):S.material=u[n];n=T[x].p;E=[];n&&(E=g.intDelimArray(n.$," "));if(E.length&&(n=E.length/N.length/3,n===q)){if(I.points.length===0)I.points=M[P].data;n=B=0;q=E.length;for(B=N.length;n<q;n+=B*3){w=[];v=[];r=[];K=[];for(A=0;A<B*3;A++)z=A%B,N[z]===0?v.push(E[n+A]):N[z]===1?w.push(E[n+A]):N[z]===2?r.push(E[n+A]):N[z]===3&&K.push(E[n+A]);v.length&&(S.faces.push(v),w.length===3&&S.normals.push([c.fixuaxis(H.up_axis,M[Y].data[w[0]]),
c.fixuaxis(H.up_axis,M[Y].data[w[1]]),c.fixuaxis(H.up_axis,M[Y].data[w[2]])]),r.length===3&&S.texcoords.push([M[$].data[r[0]],M[$].data[r[1]],M[$].data[r[2]]]),K.length===3&&S.colors.push([M[Z].data[K[0]],M[Z].data[K[1]],M[Z].data[K[2]]]))}}I.parts.push(S)}}C=V.polylist;if(!C)C=V.polygons;C&&!C.length&&(C=[C]);if(C){x=0;for(F=C.length;x<F;x++){S={material:0,faces:[],normals:[],texcoords:[],colors:[]};r=parseInt(C[x]["@count"],10);(n=C[x].input)&&!n.length&&(n=[n]);N=[];if(n.length){E=0;for(w=n.length;E<
w;E++)K=n[E],q=K["@offset"],q===null&&(q=K["@idx"]),B=parseInt(q,10),v=K["@source"].substr(1),K["@semantic"]==="VERTEX"?(v===U&&(v=P),N[B]=0):K["@semantic"]==="NORMAL"?(Y=v,N[B]=1):K["@semantic"]==="TEXCOORD"?($=v,N[B]=2):K["@semantic"]==="COLOR"?(Z=v,N[B]=3):N[B]=4}q=C[x].vcount;V=[];q&&(V=g.intDelimArray(q.$," "));n=C[x]["@material"];S.material=n===s?0:u[n];K=C[x].p;E=N.length;T=[];if(K.length>1&&!V.length){q=0;for(n=K.length;q<n;q++)B=g.intDelimArray(K[q].$," "),V[q]=parseInt(B.length/E,10),T.splice(T.length,
0,B)}else K&&(T=g.intDelimArray(K.$," "));if(T.length)if(n=V.length,n!==r)m("poly vcount data doesn't add up, skipping object load: "+n+" !== "+r);else{if(I.points.length===0)I.points=M[P].data;n=B=0;for(q=V.length;n<q;n++){w=[];v=[];r=[];K=[];A=0;for(z=V[n]*E;A<z;A++)N[A%E]===0?v.push(T[B]):N[A%E]===1?w.push(T[B]):N[A%E]===2?r.push(T[B]):N[A%E]===3&&K.push(T[B]),B++;if(v.length){S.faces.push(v);if(w.length){v=[];A=0;for(z=w.length;A<z;A++)v.push(c.fixuaxis(H.up_axis,M[Y].data[w[A]]));S.normals.push(v)}if(r.length){w=
[];A=0;for(z=r.length;A<z;A++)w.push(M[$].data[r[A]]);S.texcoords.push(w)}if(K.length){w=[];A=0;for(z=K.length;A<z;A++)w.push(M[Z].data[K[A]]);S.colors.push(w)}}}}I.parts.push(S)}}if(y!==1){n=0;for(q=I.points.length;n<q;n++)I.points[n]=c.fixuaxis(H.up_axis,I.points[n])}I.id=W;H.meshes.push(I)}}}if(u=D.library_cameras){(G=u.camera)&&!G.length&&(G=[G]);u=0;for(x=G.length;u<x;u++){q=G[u];d=q["@id"];I=J=F=0;if(q.optics&&q.optics.technique_common&&q.optics.technique_common.perspective)F=q.optics.technique_common.perspective.yfov,
J=q.optics.technique_common.perspective.znear,I=q.optics.technique_common.perspective.zfar;var R,X;if(!F&&!J&&!I){(F=q.param)&&!F.length&&(F=[F]);n=0;for(q=F.length;n<q;n++)J=F[n].$,I=F[n]["@name"],I=="YFOV"?R=parseFloat(J):I=="ZNEAR"?X=parseFloat(J):I=="ZFAR"&&(t=parseFloat(J))}else R=F?parseFloat(F.$):60,X=J?parseFloat(J.$):0.1,t=I?parseFloat(I.$):1E3;H.cameras.push({id:d,targeted:!1,fov:parseFloat(R),nearclip:parseFloat(X),farclip:parseFloat(t)})}}if(R=D.library_lights)if((R=R.light)&&!R.length&&
(R=[R]),R){X=0;for(t=R.length;X<t;X++)if(cl_light=R[X],x=(u=cl_light.technique_common.point)?u:null,u=cl_light["@id"],x!==null)q=(q=x.intensity)?parseFloat(q.$):1,F=(F=x.distance)?parseFloat(F.$):10,x=x.color,K=[1,1,1],x&&(K=g.floatDelimArray(x.$," ")),H.lights.push({id:u,name:u,type:o.light.type.POINT,method:o.light.method.STATIC,diffuse:K,specular:[0,0,0],distance:F,intensity:q})}if(X=D.library_visual_scenes){R=null;(R=X.visual_scene)&&!R.length&&(R=[R]);X=0;for(t=R.length;X<t;X++){q=R[X];u={id:q["@id"],
sceneObjects:[],cameras:[],lights:[],parentMap:[]};x={};F=[];for(G=[q];G.length;)if(d=G.pop(),d.node&&((v=d.node)&&!v.length&&(v=[v]),v)){n=0;for(q=v.length;n<q;n++)v[n].parentNode=d,F.push(v[n]),G.push(v[n])}if(F.length){G=0;for(d=F.length;G<d;G++){P=F[G];C=P.instance_geometry;cl_light=F[G].instance_light;q=F[G].instance_camera;J=P["@id"];I=P["@name"];M=c.cl_getInitalTransform(H.up_axis,P);if(y===2)M.rotation=c.quaternionFilterZYYZ(M.rotation,q?[-90,0,0]:s);n={};C?(C=C["@url"].substr(1),n.name=n.id=
I?I:J,n.position=M.position,n.rotation=M.rotation,n.scale=M.scale,n.meshId=W,n.meshName=C,u.sceneObjects.push(n),x[n.id]=!0,P.parentNode&&(q=P.parentNode["@id"])&&x[q]&&u.parentMap.push({parent:q,child:n.id})):q?(q=q["@url"].substr(1),u.cameras.push({name:I?I:J,id:I?I:J,source:q,position:M.position,rotation:M.rotation})):cl_light?(q=cl_light["@url"].substr(1),u.lights.push({name:I?I:J,id:I?I:J,source:q,position:M.position})):u.sceneObjects.push({id:I!==null?I:J,name:I!==null?I:J,position:M.position,
rotation:M.rotation,scale:M.scale})}}H.scenes.push(u)}}if(W=D.library_animations)if((y=W.animation)&&!y.length&&(y=[y]),y){R=0;for(X=y.length;R<X;R++){x=y[R];W=x["@id"];H.animations[W]={};H.animations[W].sources=[];(F=x.source)&&!F.length&&(F=[F]);if(F.length){t=0;for(u=F.length;t<u;t++){d=F[t];q=d["@id"];C=d.technique_common;J=G=null;d.name_array?G=g.textDelimArray(d.name_array.$," "):d.Name_array?G=g.textDelimArray(d.Name_array.$," "):d.float_array&&(J=g.floatDelimArray(d.float_array.$," "));d=
0;M="";I=1;if(C)d=C,C=d.accessor,d=parseInt(C["@count"],10),M=C["@source"].substr(1),(C=C["@stride"])&&(I=parseInt(C,10));H.animations[W].sources[q]={data:G?G:J,count:d,source:M,stride:I};if(I!==1)H.animations[W].sources[q].data=g.repackArray(H.animations[W].sources[q].data,I,d)}}(F=x.sampler)&&!F.length&&(F=[F]);if(F){H.animations[W].samplers=[];t=0;for(u=F.length;t<u;t++)if(q=F[t],G=q["@id"],(n=q.input)&&!n.length&&(n=[n]),n){J=[];d=0;for(q=n.length;d<q;d++)K=n[d],J[K["@semantic"]]=K["@source"].substr(1);
H.animations[W].samplers[G]=J}}(t=x.channel)&&!t.length&&(t=[t]);if(t){H.animations[W].channels=[];u=0;for(x=t.length;u<x;u++)F=t[u],q=F["@source"].substr(1),F=F["@target"],d=F.split("/"),G=d[0],d=d[1].split("."),H.animations[W].channels.push({source:q,target:F,targetName:G,paramName:d[0],typeName:d[1]})}}}if(D=D.scene)if(q=D.instance_visual_scene)D=q["@url"].substr(1),H.scene=D;return H}var s=t.undef,o=CubicVR.enums,r=t.GLCore,m=t.log,c={fixuaxis:function(c,a){if(c===0)return[a[1],a[0],a[2]];else if(c===
1)return a;else if(c===2)return[a[0],a[2],-a[1]]},fixscaleaxis:function(c,a){if(c===0)return[a[1],a[0],a[2]];else if(c===1)return a;else if(c===2)return[a[0],a[2],a[1]]},fixukaxis:function(c,a,b,e){if(a===o.motion.POS&&b===o.motion.Z&&c===o.motion.Z)return-e;return e},getAllOf:function(c,a){for(var b=[c],e=[],g,d,q,n;b.length;)for(d in g=b.pop(),g)if(g.hasOwnProperty(d)){if(d===a)if(g[d].length){q=0;for(n=g[d].length;q<n;q++)e.push(g[d][q])}else e.push(g[d]);if(typeof g[d]=="object")if(g[d].length){q=
0;for(n=g[d].length;q<n;q++)b.push(g[d][q])}else b.push(g[d])}return e},quaternionFilterZYYZ:function(c,a){var b=CubicVR.vec3,e=c,g=new CubicVR.Quaternion;a!==s&&(e=b.add(c,a));g.fromEuler(e[0],e[2],-e[1]);return g.toEuler()},cl_getInitalTransform:function(h,a){var b=CubicVR.util,e={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},g=a.translate,d=a.rotate,q=a.scale;if(g)e.position=c.fixuaxis(h,b.floatDelimArray(g.$," "));if(d)for(var g=0,n=d.length;g<n;g++){var v=d[g],C=v["@sid"],v=b.floatDelimArray(v.$,
" ");if(C=="rotateX"||C=="rotationX")e.rotation[0]=v[3];else if(C=="rotateY"||C=="rotationY")e.rotation[1]=v[3];else if(C=="rotateZ"||C=="rotationZ")e.rotation[2]=v[3]}if(q)e.scale=c.fixscaleaxis(h,b.floatDelimArray(q.$," "));return e}};return{loadCollada:function(h,a,b){var a=y(h,a,b),e=a.up_axis,g=[],d,q,n,v,C,m,O,E;q=0;for(n=a.materials.length;q<n;q++){C=a.materials[q];O=new CubicVR.Material(C.mat);m=0;for(v=C.mat.textures_ref.length;m<v;m++){E=C.mat.textures_ref[m];var B=null,B=t.Textures_ref[E.image]===
void 0?new CubicVR.Texture(E.image,r.default_filter,b,h):t.Textures_obj[t.Textures_ref[E.image]];O.setTexture(B,E.type)}g[C.id]=O}m=[];q=0;for(n=a.meshes.length;q<n;q++){var B=a.meshes[q],x=new CubicVR.Mesh(B.id);x.points=B.points;O=0;for(E=B.parts.length;O<E;O++){var A=B.parts[O];A.material!==0&&x.setFaceMaterial(g[A.material]);var z=A.normals.length?!0:!1,u=A.texcoords.length?!0:!1,Q=A.colors.length?!0:!1;if(Q)g[A.material].color_map=!0;v=0;for(C=A.faces.length;v<C;v++){var D=x.addFace(A.faces[v]);
if(z)x.faces[D].point_normals=A.normals[v];if(u)x.faces[D].uvs=A.texcoords[v];if(Q)x.faces[D].point_colors=A.colors[v]}}b?b.addMesh(h,h+":"+meshId,x):(x.triangulateQuads(),x.compile());m[B.id]=x}n=[];h=0;for(v=a.cameras.length;h<v;h++)n[a.cameras[h].id]=a.cameras[h];B=[];v=0;for(C=a.lights.length;v<C;v++)B[a.lights[v].id]=a.lights[v];b={};g={};q={};h={};O=0;for(E=a.scenes.length;O<E;O++){x=a.scenes[O];A=new CubicVR.Scene;v=0;for(C=x.sceneObjects.length;v<C;v++)z=x.sceneObjects[v],u=new CubicVR.SceneObject(z),
u.obj=(m[z.meshName]?m[z.meshName]:m[z.meshId])||null,b[z.id]=u,A.bindSceneObject(u);v=0;for(C=x.lights.length;v<C;v++)z=x.lights[v],u=new CubicVR.Light(B[z.source]),u.position=z.position,g[z.id]=u,A.bindLight(u);if(x.cameras.length)v=x.cameras[0],C=new CubicVR.Camera(n[v.source]),C.position=v.position,C.rotation=v.rotation,q[v.id]=C,A.camera=C;v=0;for(C=x.parentMap.length;v<C;v++)z=x.parentMap[v],b[z.parent].bindChild(b[z.child]);h[x.id]=A}for(var H in a.animations)if(a.animations.hasOwnProperty(H)&&
(m=a.animations[H],m.channels.length)){cCount=0;for(v=m.channels.length;cCount<v;cCount++){n=m.channels[cCount];z=m.samplers[n.source];C=m.sources[z.INPUT];O=m.sources[z.OUTPUT];E=m.sources[z.INTERPOLATION];var B=m.sources[z.IN_TANGENT],x=m.sources[z.OUT_TANGENT],A=z.IN_TANGENT!==s,z=z.OUT_TANGENT!==s,u=null,D=b[n.targetName],Q=q[n.targetName],L=g[n.targetName];if(D){if(D.motion===null)D.motion=new CubicVR.Motion;u=D.motion}else if(Q){if(Q.motion===null)Q.motion=new CubicVR.Motion;u=Q.motion}else if(L){if(L.motion===
null)L.motion=new CubicVR.Motion;u=L.motion}if(u!==null){var D=o.motion.POS,F=o.motion.X;if(e===2)u.yzflip=!0;d=n.paramName;if(d==="rotateX"||d==="rotationX")D=o.motion.ROT,F=o.motion.X;else if(d==="rotateY"||d==="rotationY")D=o.motion.ROT,F=o.motion.Y;else if(d==="rotateZ"||d==="rotationZ")D=o.motion.ROT,F=o.motion.Z;else if(d==="location"){D=o.motion.POS;if(n.typeName==="X")F=o.motion.X;if(n.typeName==="Y")F=o.motion.Y;if(n.typeName==="Z")F=o.motion.Z}else if(d==="translate"){D=o.motion.POS;if(n.typeName===
"X")F=o.motion.X;if(n.typeName==="Y")F=o.motion.Y;if(n.typeName==="Z")F=o.motion.Z}else if(d==="LENS")continue;else if(d==="FOV")D=o.motion.FOV,F=3;else if(d==="ZNEAR")D=o.motion.NEARCLIP,F=3;else if(d==="ZFAR")D=o.motion.FARCLIP,F=3;else if(d==="intensity")D=o.motion.INTENSITY,F=3;if(L&&D<3)L.method=o.light.method.DYNAMIC;mCount=0;for(n=C.data.length;mCount<n;mCount++)if(k=null,typeof O.data[mCount]==="object"){i=0;for(iMax=O.data[mCount].length;i<iMax;i++)if(L=i,e===2&&i===2?L=1:e===2&&i===1&&(L=
2),k=u.setKey(D,L,C.data[mCount],c.fixukaxis(a.up_axis,D,L,O.data[mCount][i])),E)if(d=E.data[mCount][i],d==="LINEAR")k.shape=o.envelope.shape.LINE;else if(d==="BEZIER")k.shape=!A&&!z?o.envelope.shape.LINEAR:o.envelope.shape.BEZI}else if(L=F,ofs=0,Q&&D===o.motion.ROT&&e===2&&L===0&&(ofs=-90),D===o.motion.ROT?k=u.setKey(D,L,C.data[mCount],O.data[mCount]+ofs):(e===2&&F===2?L=1:e===2&&F===1&&(L=2),k=u.setKey(D,L,C.data[mCount],c.fixukaxis(a.up_axis,D,L,O.data[mCount]))),E)if(d=E.data[mCount],d==="LINEAR")k.shape=
o.envelope.shape.LINE;else if(d==="BEZIER")if(!A&&!z)k.shape=o.envelope.shape.LINEAR,k.continutity=1;else{k.shape=o.envelope.shape.BEZ2;d=B.data[mCount][0];var J,G=x.data[mCount][0];D===o.motion.ROT?(J=B.data[mCount][1],L=x.data[mCount][1],k.param[0]=d-k.time,k.param[1]=J-k.value+ofs,k.param[2]=G-k.time,k.param[3]=L-k.value+ofs):(J=c.fixukaxis(a.up_axis,D,L,B.data[mCount][1]),L=c.fixukaxis(a.up_axis,D,L,x.data[mCount][1]),k.param[0]=d-k.time,k.param[1]=J-k.value,k.param[2]=G-k.time,k.param[3]=L-k.value)}}}}H=
null;return H=a.scene?h[a.scene]:h.pop()},parseCollada:y}});CubicVR.RegisterModule("CVRXML",function(t){function y(a,g,d,q){var n=CubicVR.util,c=null,h=null;q.triangles&&(h=n.intDelimArray(b.getTextNode(q,"triangles")," "));if(h&&(q.segments&&(c=n.intDelimArray(b.getTextNode(q,"segments")," ")),c===null&&(c=[0,parseInt(h.length/3,10)]),q=0,a.setFaceMaterial(g),h.length)){p=0;for(pMax=c.length;p<pMax;p+=2){g=c[p+1]*3;a.setSegment(c[p]);j=q;for(jMax=q+g;j<jMax;j+=3)n=a.addFace([h[j],h[j+1],h[j+2]]),d&&a.faces[n].setUV([d[j],d[j+1],d[j+2]]);q+=g}}}function s(a){var g=
CubicVR.util,d=new CubicVR.UVMapper,q=null,n=null;if(a.type)switch(q=b.getTextNode(a,"type"),q){case "planar":d.projection_mode=h.uv.projection.PLANAR;break;case "cylindrical":d.projection_mode=h.uv.projection.CYLINDRICAL;break;case "spherical":d.projection_mode=h.uv.projection.SPHERICAL;break;case "cubic":d.projection_mode=h.uv.projection.CUBIC}if(!q)return null;q==="uv"&&a.uv&&(n=b.getPoints(a,"uv"));if(a.axis)switch(b.getTextNode(a,"axis")){case "x":d.projection_axis=h.uv.axis.X;break;case "y":d.projection_axis=
h.uv.axis.Y;break;case "z":d.projection_axis=h.uv.axis.Z}if(a.center)d.center=g.floatDelimArray(b.getTextNode(a,"center"));if(a.rotation)d.rotation=g.floatDelimArray(b.getTextNode(a,"rotation"));if(a.scale)d.scale=g.floatDelimArray(b.getTextNode(a,"scale"));if(a.wrap_w)d.wrap_w_count=parseFloat(b.getTextNode(a,"wrap_w"));if(a.wrap_h)d.wrap_h_count=parseFloat(b.getTextNode(a,"wrap_h"));return q!==""&&q!=="uv"?d:n}function o(e,g){if(a[e]!==c)return a[e];var d=CubicVR.util,q,n,v,m;q=null;q=typeof e==
"object"?e:e.indexOf(".js")!=-1?d.getJSON(e):CubicVR.util.xml2badgerfish(d.getXML(e));if(q.root)q=q.root;if(q.properties)q=q.properties;d=new CubicVR.Mesh;q.points&&(v=b.getPoints(q,"points"))&&d.addPoint(v);var w=q.material;w&&!w.length&&(w=[w]);var r=[];if(w){q=0;for(v=w.length;q<v;q++){var o=w[q],B;B=o;var x=g,A=new CubicVR.Material(B.name?B.name.$:null);if(B.shininess)A.shininess=b.getFloatNode(B,"shininess",A.shininess)/100;A.opacity=b.getFloatNode(B,"alpha",A.opacity);A.max_smooth=b.getFloatNode(B,
"max_smooth",A.max_smooth);A.color=b.getFloatDelimNode(B,"color",A.color);A.ambient=b.getFloatDelimNode(B,"ambient",A.ambient);A.diffuse=b.getFloatDelimNode(B,"diffuse",A.diffuse);A.specular=b.getFloatDelimNode(B,"specular",A.specular);n=void 0;if(n=b.getTextNode(B,"texture"))n=(x?x:"")+n,tex=t.Textures_ref[n]!==c?t.Textures_obj[t.Textures_ref[n]]:new CubicVR.Texture(n),A.setTexture(tex,h.texture.map.COLOR);if(n=b.getTextNode(B,"texture_luminosity"))n=(x?x:"")+n,tex=t.Textures_ref[n]!==c?t.Textures_obj[t.Textures_ref[n]]:
new CubicVR.Texture(n),A.setTexture(tex,h.texture.map.AMBIENT);if(n=b.getTextNode(B,"texture_normal"))n=(x?x:"")+n,tex=t.Textures_ref[n]!==c?t.Textures_obj[t.Textures_ref[n]]:new CubicVR.Texture(n),A.setTexture(tex,h.texture.map.NORMAL);if(n=b.getTextNode(B,"texture_specular"))n=(x?x:"")+n,tex=t.Textures_ref[n]!==c?t.Textures_obj[t.Textures_ref[n]]:new CubicVR.Texture(n),A.setTexture(tex,h.texture.map.SPECULAR);if(n=b.getTextNode(B,"texture_bump"))n=(x?x:"")+n,tex=t.Textures_ref[n]!==c?t.Textures_obj[t.Textures_ref[n]]:
new CubicVR.Texture(n),A.setTexture(tex,h.texture.map.BUMP);if(n=b.getTextNode(B,"texture_envsphere"))n=(x?x:"")+n,tex=t.Textures_ref[n]!==c?t.Textures_obj[t.Textures_ref[n]]:new CubicVR.Texture(n),A.setTexture(tex,h.texture.map.ENVSPHERE);if(n=b.getTextNode(B,"texture_alpha"))n=(x?x:"")+n,tex=t.Textures_ref[n]!==c?t.Textures_obj[t.Textures_ref[n]]:new CubicVR.Texture(n),A.setTexture(tex,h.texture.map.ALPHA);B=A;var z=null;n=x=null;o.uvmapper&&((x=s(o.uvmapper))&&!x.length?r.push([x,B]):n=x);(A=o.part)&&
!A.length&&(A=[A]);if(A&&A.length){var u=null,Q=null;n=0;for(m=A.length;n<m;n++){var D=A[n],u=null;if(z=D.uvmapper)if(u=s(z),o.triangles)Q=z=d.faces.length,u&&!u.length?(y(d,B,null,D),Q=d.faces.length-1,d.calcFaceNormals(z,Q),u.apply(d,B,c,z,Q)):u&&u.length?y(d,B,u,D):x&&!x.length&&(y(d,B,null,D),Q=d.faces.length-1,d.calcFaceNormals(z,Q),x.apply(d,B,c,z,Q));if(D.procedural){(z=D.uvmapper)&&(u=s(z));var Q=D.transform?b.getTransform(D.transform):c,z=c,D=D.procedural,H=b.getTextNode(D,"type");Q&&(z=
new CubicVR.Transform,z.translate(Q.position),z.pushMatrix(),z.rotate(Q.rotation),z.pushMatrix(),z.scale(Q.scale));x||(x=c);u={material:B,uvmapper:x||u};if(H==="box"||H==="cube")u.size=b.getFloatNode(D,"size"),d.booleanAdd(CubicVR.primitives.box(u),z);else if(H==="sphere")u.radius=b.getFloatNode(D,"radius"),u.lat=b.getIntNode(D,"lat"),u.lon=b.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.sphere(u),z);else if(H==="cone")u.base=b.getFloatNode(D,"base"),u.height=b.getFloatNode(D,"height"),u.lon=
b.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.cone(u),z);else if(H==="plane")u.size=b.getFloatNode(D,"size"),d.booleanAdd(CubicVR.primitives.plane(u),z);else if(H==="cylinder")u.radius=b.getFloatNode(D,"radius"),u.height=b.getFloatNode(D,"height"),u.lon=b.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.cylinder(u),z);else if(H==="torus")u.innerRadius=b.getFloatNode(D,"innerRadius"),u.outerRadius=b.getFloatNode(D,"outerRadius"),u.lat=b.getIntNode(D,"lat"),u.lon=b.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.torus(u),
z);else if(H==="lathe")u.points=b.getPoints(D,"p"),u.lon=b.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.lathe(u),z);else if(H==="polygon"){Q=b.getPoints(D,"p");Q=new CubicVR.Polygon(Q);(H=D.cut)&&!H.length&&(H=[H]);if(H.length){n=0;for(v=H.length;n<m;n++)Q.cut(new CubicVR.Polygon(b.getPoints(H[n])))}u.front=0;u.back=0;u.frontShift=0;u.backShift=0;u.frontDepth=0;u.backDepth=0;if(D.extrude){D=D.extrude;u.front=b.getFloatNode(D,"front",0);u.back=b.getFloatNode(D,"back",0);u.frontShift=b.getFloatNode(D,
"frontBevelShift",0);u.backShift=b.getFloatNode(D,"backBevelShift",0);u.frontDepth=b.getFloatNode(D,"frontBevelDepth",0);u.backDepth=b.getFloatNode(D,"backBevelDepth",0);u.depth=b.getFloatNode(D,"depth",0);u.shift=b.getFloatNode(D,"shift",0);u.bevel=b.getFloatNode(D,"bevel",0);if(u.depth&&!u.backDepth&&!u.frontDepth)u.front=-u.depth/2,u.back=u.depth/2;if(u.shift&&!u.backShift&&!u.frontShift)u.frontShift=u.shift,u.backShift=u.shift;if(u.bevel&&!u.backDepth&&!u.frontDepth)u.frontDepth=u.bevel,u.backDepth=
u.bevel}D=Q.toExtrudedBeveledMesh(new CubicVR.Mesh,u);D.setFaceMaterial(u.material);d.booleanAdd(D,z)}}}}else y(d,B,n,o)}}d.triangulateQuads();d.calcNormals();q=0;for(v=r.length;q<v;q++)r[q][0].apply(d,r[q][1]);d.compile();return a[e]=d}function r(a){if(a===null)return!1;return a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function m(a,b,d){var q=CubicVR.util,n=[];n[0]=a.getElementsByTagName("x");n[1]=
a.getElementsByTagName("y");n[2]=a.getElementsByTagName("z");n[3]=a.getElementsByTagName("fov");var v,m,w,r,o,s;for(s in n)if(n.hasOwnProperty(s)&&n[s]!==c&&n[s].length){v=n[s][0].getElementsByTagName("time");m=n[s][0].getElementsByTagName("value");w=n[s][0].getElementsByTagName("in");r=n[s][0].getElementsByTagName("out");o=n[s][0].getElementsByTagName("tcb");var x=null,A=null,z=null,u=a=null;w.length&&(a=q.collectTextNode(w[0]));r.length&&(u=q.collectTextNode(r[0]));v.length&&(x=q.floatDelimArray(q.collectTextNode(v[0]),
" "));m.length&&(A=q.floatDelimArray(q.collectTextNode(m[0])," "));o.length&&(z=q.floatDelimArray(q.collectTextNode(o[0])," "));if(x!==null&&A!==null){v=0;for(m=x.length;v<m;v++)if(w=d.setKey(b,s,x[v],A[v]),z)w.tension=z[v*3],w.continuity=z[v*3+1],w.bias=z[v*3+2]}A=x=h.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":x=h.envelope.behavior.RESET;break;case "constant":x=h.envelope.behavior.CONSTANT;break;case "repeat":x=h.envelope.behavior.REPEAT;break;case "oscillate":x=h.envelope.behavior.OSCILLATE;
break;case "offset":x=h.envelope.behavior.OFFSET;break;case "linear":x=h.envelope.behavior.LINEAR}if(u)switch(u){case "reset":A=h.envelope.behavior.RESET;break;case "constant":A=h.envelope.behavior.CONSTANT;break;case "repeat":A=h.envelope.behavior.REPEAT;break;case "oscillate":A=h.envelope.behavior.OSCILLATE;break;case "offset":A=h.envelope.behavior.OFFSET;break;case "linear":A=h.envelope.behavior.LINEAR}d.setBehavior(b,s,x,A)}}var c=t.undef,h=CubicVR.enums,a=[],b={getPoints:function(a,g,d){a=g?
b.getTextNode(a,g):a.$;if(!a)return c;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);d&&(a[i][2]=0)}return a},getTransform:function(a){var b=CubicVR.util;if(!a)return null;var d={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},q;postition=a.position;q=a.rotation;a=a.scale;if(q)d.rotation=b.floatDelimArray(q.$);if(a)d.scale=b.floatDelimArray(a.$);if(q||a)return d;return null},getTextNode:function(a,b,d){a=a[b];
if(!a)return d;a.length&&(a=a[0]);if(a.$)return a.$;return d},getFloatNode:function(a,g,d){if(a=b.getTextNode(a,g)){a=parseFloat(a);if(a!=a)return d;return a}return d},getIntNode:function(a,g,d){if(a=b.getTextNode(a,g)){a=parseInt(a,10);if(a!=a)return d;return a}return d},getFloatDelimNode:function(a,g,d,q){var n=CubicVR.util;if(a=b.getTextNode(a,g))return n.floatDelimArray(a,q);return d},getIntDelimNode:function(a,g,d,q){var n=CubicVR.util;if(a=b.getTextNode(a,g))return n.intDelimArray(a,q);return d}};
return{loadMesh:o,loadScene:function(a,b,d){var q=CubicVR.util;b===c&&(b="");d===c&&(d="");for(var n=new CubicVR.Mesh,v=q.getXML(a),a=new CubicVR.Scene,C=[],w=v.getElementsByTagName("sceneobjects"),s,E,B,x=0,A=w[0].childNodes.length;x<A;x++){var z=w[0].childNodes[x];if(z.tagName==="sceneobject"){var u="unnamed",t="",D="",n=z.getElementsByTagName("name");n.length&&(u=q.collectTextNode(n[0]));n=z.getElementsByTagName("parent");n.length&&(t=q.collectTextNode(n[0]));n=z.getElementsByTagName("model");
n.length&&(D=q.collectTextNode(n[0]));B=E=s=null;n=z.getElementsByTagName("position");n.length&&(s=n[0]);n=z.getElementsByTagName("rotation");n.length&&(E=n[0]);n=z.getElementsByTagName("scale");n.length&&(B=n[0]);n=null;D!==""&&(n=o(b+D,d));n=new CubicVR.SceneObject(n,u);if(r(s)){if(!n.motion)n.motion=new CubicVR.Motion;m(s,h.motion.POS,n.motion)}else if(s)n.position=q.floatDelimArray(q.collectTextNode(s));if(r(E)){if(!n.motion)n.motion=new CubicVR.Motion;m(E,h.motion.ROT,n.motion)}else n.rotation=
q.floatDelimArray(q.collectTextNode(E));if(r(B)){if(!n.motion)n.motion=new CubicVR.Motion;m(B,h.motion.SCL,n.motion)}else n.scale=q.floatDelimArray(q.collectTextNode(B));a.bindSceneObject(n);t!==""&&C.push([n,t])}}for(var y in C)C.hasOwnProperty(y)&&a.getSceneObject(C[y][1]).bindChild(C[y][0]);b=v.getElementsByTagName("camera");if(b.length){E=s=null;d="";n=b[0].getElementsByTagName("name");y=a.camera;v=null;if(n.length)d=n[0].firstChild.nodeValue;n=b[0].getElementsByTagName("target");if(n.length)d=
n[0].firstChild.nodeValue;if(d!=="")y.targetSceneObject=a.getSceneObject(d);n=b[0].getElementsByTagName("position");n.length&&(s=n[0]);n=b[0].getElementsByTagName("rotation");n.length&&(E=n[0]);n=b[0].getElementsByTagName("fov");n.length&&(v=n[0]);if(r(s)){if(!y.motion)y.motion=new CubicVR.Motion;m(s,h.motion.POS,y.motion)}else if(s)y.position=q.floatDelimArray(s.firstChild.nodeValue);if(r(E)){if(!y.motion)y.motion=new CubicVR.Motion;m(E,h.motion.ROT,y.motion)}else if(E)y.rotation=q.floatDelimArray(E.firstChild.nodeValue);
if(r(v)){if(!y.motion)y.motion=new CubicVR.Motion;m(v,h.motion.FOV,y.motion)}else if(v)y.fov=parseFloat(v.firstChild.nodeValue)}return a}}});CubicVR.RegisterModule("Camera",function(t){function y(a,b,e,g,d){var q=CubicVR.mat4;this.frustum=new CubicVR.Frustum;typeof a=="object"?(this.position=a.position?a.position:[0,0,0],this.rotation=a.rotation?a.rotation:[0,0,0],this.target=a.target?a.target:[0,0,0],this.fov=a.fov?a.fov:60,this.nearclip=a.nearclip?a.nearclip:0.1,this.farclip=a.farclip?a.farclip:400,this.targeted=a.targeted?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix?a.calcNormalMatrix:!0,this.name=a.name||"camera"+h,b=a.height?
a.height:r,a=a.width?a.width:r):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=e!==r?e:60,this.nearclip=g!==r?g:0.1,this.farclip=d!==r?d:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+h);this.motion=this.targetSceneObject=null;this.transform=new CubicVR.Transform;this.manual=!1;this.setDimensions(a!==r?a:512,b!==r?b:512);this.mvMatrix=q.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=
null;++h}function s(a){this.position=a!==r?a:[0,0,0]}function o(a,b,e){this.camPath=new CubicVR.Motion;this.targetPath=new CubicVR.Motion;this.start_position=a!==r?a:[8,8,8];this.target=b!==r?b:[0,0,0];this.bounds=e!==r?e:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var r=t.undef,m=CubicVR.enums,c=[1,
0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],h=0;y.prototype={setParent:function(a){this.parent=a},setOrtho:function(a,b,e,g){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=b;this.ortho_view.bottom=e;this.ortho_view.top=g},control:function(a,b,e){a===m.motion.ROT?this.rotation[b]=e:a===m.motion.POS?this.position[b]=e:a===m.motion.FOV?this.setFOV(e):a===m.motion.LENS?this.setLENS(e):a===m.motion.NEARCLIP?this.setClip(e,this.farclip):a===m.motion.FARCLIP&&this.setClip(this.nearclip,e)},makeFrustum:function(a,
b,e,g,d,q){return[2*d/(b-a),0,0,0,0,2*d/(g-e),0,0,(b+a)/(b-a),(g+e)/(g-e),-(q+d)/(q-d),-1,0,0,-2*q*d/(q-d),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=CubicVR.mat4,b=CubicVR.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);if(!this.targeted)a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],
-this.rotation[2],this.mvMatrix),a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent!==null&&a.multiply(this.mvMatrix.slice(0),a.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),b.transpose_inline(this.nMatrix)):a.identity(this.nMatrix);this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,b){this.nearclip=a;this.farclip=b;this.calcProjection()},setDimensions:function(a,b){this.width=
a;this.height=b;this.aspect=a/b;this.calcProjection()},resize:function(a,b){this.setDimensions(a,b)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},setLENS:function(a){this.setFOV(2*Math.atan(16/a)*(180/Math.PI))},lookat:function(a,b,e,g,d,q,n,h,m){var w=CubicVR.mat4,r=CubicVR.mat3;if(typeof a=="object")this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0);else{this.mvMatrix=w.lookat(a,b,e,g,d,q,n,h,m);if(this.rotation[2])this.transform.clearStack(),
this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult();this.calc_nmatrix?(this.nMatrix=w.inverse_mat3(this.mvMatrix),r.transpose_inline(this.nMatrix)):this.nMatrix=c;this.frustum.extract(this,this.mvMatrix,this.pMatrix)}},unProject:function(a,b,e){var g=CubicVR.mat4,d=[0,0,this.width,this.height];if(e===r)e=this.farclip;a=g.vec4_multiply(g.vec4_multiply([(a-d[0])/d[2]*2-1,-((b-d[1])/d[3]*2-1),(e-this.nearclip)/(this.farclip-
this.nearclip),1],g.inverse(this.pMatrix)),g.inverse(this.mvMatrix));return[a[0]/a[3],a[1]/a[3],a[2]/a[3]]},project:function(a,b,e){var g=CubicVR.mat4,a=g.vec4_multiply(g.vec4_multiply([a,b,e,1],this.mvMatrix),this.pMatrix);return[(a[0]/a[3]+1)/2*this.width,(-a[1]/a[3]+1)/2*this.height,a[2]/a[3]*(this.farclip-this.nearclip)+this.nearclip]}};s.prototype={control:function(a,b,e){a===m.motion.POS&&(this.position[b]=e)}};o.prototype={inBounds:function(a){var b=CubicVR.vec3;if(!(a[0]>this.bounds[0][0]&&
a[1]>this.bounds[0][1]&&a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var e=0,g=this.avoid_sphere.length;e<g;e++)if(b.length(a,this.avoid_sphere[e][0])<this.avoid_sphere[e][1])return!1;return!0},findNextNode:function(a,b){var e=CubicVR.vec3,g=[0,0,0],d=[0,0,0],q=g=0,n=!1;do if(d[0]=Math.random()-0.5,d[1]=Math.random()-0.5,d[2]=Math.random()-0.5,d=e.normalize(d),g=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,g=
e.add(b.position,e.multiply(d,g)),n=this.inBounds(g),q++,q>30){g=b.position;break}while(!n);return g},run:function(a){this.current_time=a;if(this.path_time===0)this.path_time=this.current_time,this.camPath.setKey(m.motion.POS,m.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(m.motion.POS,m.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(m.motion.POS,m.motion.Z,this.path_time,this.start_position[2]);for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=
this.segment_time;var b=new s,e=new s;this.path_length&&this.camPath.apply(this.path_time-this.segment_time*2,b);this.camPath.apply(this.path_time-this.segment_time,e);b=this.findNextNode(b,e);this.camPath.setKey(m.motion.POS,m.motion.X,this.path_time,b[0]);this.camPath.setKey(m.motion.POS,m.motion.Y,this.path_time,b[1]);this.camPath.setKey(m.motion.POS,m.motion.Z,this.path_time,b[2]);this.path_length++}b=new s;this.camPath.apply(a,b);return b.position},addSafeBound:function(a,b){this.safe_bb.push([a,
b])},addAvoidSphere:function(a,b){this.avoid_sphere.push([a,b])}};return{Camera:y,AutoCamera:o}});CubicVR.RegisterModule("CollisionMap",function(){CubicVR.enums.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6}};var t=function(t){this.shapes=[];t&&!t.length&&(t=[t]);for(var s=0,o=t.length;s<o;s++)this.addShape(t[s])};t.prototype={addShape:function(t){t.position=t.position||[0,0,0];t.rotation=t.rotation||[0,0,0];t.size=t.size||[1,1,1];t.radius=t.radius||1;t.height=t.height||1;t.margin=t.margin||0;t.mesh=t.mesh||null;this.shapes.push(t)},getShapes:function(){return this.shapes}};
return{CollisionMap:t}});CubicVR.RegisterModule("GML",function(t){function y(o){var r=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(o!==s){var o=r.getXML(o),m=o.getElementsByTagName("header");if(!m.length)return null;var c=m[0],m=o.getElementsByTagName("environment");if(!m.length)return null;this.name=null;c=c.getElementsByTagName("name");if(c.length)this.name=r.collectTextNode(c[0]);c=m[0].getElementsByTagName("screenBounds");if(c.length)this.bounds=
[parseFloat(r.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(r.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(r.collectTextNode(c[0].getElementsByTagName("z")[0]))];c=m[0].getElementsByTagName("origin");if(c.length)this.origin=[parseFloat(r.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(r.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(r.collectTextNode(c[0].getElementsByTagName("z")[0]))];m=m[0].getElementsByTagName("up");if(m.length)this.upvector=
[parseFloat(r.collectTextNode(m[0].getElementsByTagName("x")[0])),parseFloat(r.collectTextNode(m[0].getElementsByTagName("y")[0])),parseFloat(r.collectTextNode(m[0].getElementsByTagName("z")[0]))];o=o.getElementsByTagName("drawing");m=0;for(c=o.length;m<c;m++)for(var h=o[m].getElementsByTagName("stroke"),a=0,b=0,e=0,g=0,d=0,q=h.length;d<q;d++){for(var n=h[d].getElementsByTagName("pt"),v=n.length,C=Array(v),w,O,E,B=0,x=v;B<x;B++)E=n[B],v=parseFloat(r.collectTextNode(E.getElementsByTagName("x")[0])),
w=parseFloat(r.collectTextNode(E.getElementsByTagName("y")[0])),O=parseFloat(r.collectTextNode(E.getElementsByTagName("z")[0])),E=parseFloat(r.collectTextNode(E.getElementsByTagName("time")[0])),this.upvector[0]===1?C[B]=[w!==w?0:w,v!==v?0:-v,O!==O?0:O,E]:this.upvector[1]===1?C[B]=[v!==v?0:v,w!==w?0:w,O!==O?0:O,E]:this.upvector[2]===1&&(C[B]=[v!==v?0:v,O!==O?0:-O,w!==w?0:w,E]),a<v&&(a=v),b<w&&(b=w),e<O&&(e=O),g<E&&(g=E);if(e>g){n=0;for(B=C.length;n<B;n++)v=C[n][3],C[n][3]=C[n][2],C[n][2]=v/this.bounds[2]}this.strokes[d]=
C}}}var s=t.undef;y.prototype={addStroke:function(o,r){var m=[];r===s&&(r=0.1);for(var c=0,h=o.length;c<h;c++){var a=[o[c][0],o[c][1],o[c][2]];this.manual_pos+=r;a.push(this.manual_pos);m.push(a)}this.strokes.push(m)},recenter:function(){var o=CubicVR.vec3,r=[0,0,0],m=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],c,h,a,b;a=0;for(b=this.strokes.length;a<b;a++){c=0;for(h=this.strokes[a].length;c<h;c++)r[0]>this.strokes[a][c][0]&&(r[0]=this.strokes[a][c][0]),r[1]>this.strokes[a][c][1]&&
(r[1]=this.strokes[a][c][1]),r[2]>this.strokes[a][c][2]&&(r[2]=this.strokes[a][c][2]),m[0]<this.strokes[a][c][0]&&(m[0]=this.strokes[a][c][0]),m[1]<this.strokes[a][c][1]&&(m[1]=this.strokes[a][c][1]),m[2]<this.strokes[a][c][2]&&(m[2]=this.strokes[a][c][2])}o=o.multiply(o.subtract(m,r),0.5);a=0;for(b=this.strokes.length;a<b;a++){c=0;for(h=this.strokes[a].length;c<h;c++)this.strokes[a][c][0]-=o[0],this.strokes[a][c][1]-=this.upvector[1]?o[1]:-o[1],this.strokes[a][c][2]-=o[2]}},generateObject:function(o,
r,m,c,h){var a=CubicVR.vec3;o===s&&(o=0);r===s&&(r=0);h===s&&(h=!1);c===s&&(c=0.02);m===s&&(m=0.015);for(var b=r!==0,e=0,g=0,d=new CubicVR.Mesh(this.name),q,n,v,C,w,O,E=0,B=this.strokes.length;E<B;E++){O=new CubicVR.Envelope;var x=new CubicVR.Envelope,A=new CubicVR.Envelope,z=this.strokes[E].length,u=0,t=[],D=[],y=0,L=this.strokes[E];for(w=0;w<z;w++){var F=L[w],J=O.addKey(F[3],F[0]),G=x.addKey(F[3],F[1]),I;I=h?A.addKey(F[3],F[2]):A.addKey(F[3],0);J.tension=0.5;G.tension=0.5;I.tension=0.5;w!==0?(q=
F[0]-q,n=F[1]-n,v=F[2]-v,C=F[3]-C,v=Math.sqrt(q*q+n*n+v*v),u+=v,t[w-1]=v,D[w-1]=C):y=F[3];q=F[0];n=F[1];v=F[2];C=F[3]}u=y;z=d.points.length;for(w=0;w<t.length;w++){y=D[w];L=u;F=u+y;for(J=y/Math.ceil(t[w]/c*3);L<F-J;L+=J){L===u&&(q=O.evaluate(L),n=x.evaluate(L),v=A.evaluate(L));var K,G=O.evaluate(L+J);I=x.evaluate(L+J);K=A.evaluate(L+J);var N;N=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([G-q,I-n,K-v]))),m/2);d.addPoint([q-N[0],-(n-N[1]),v-N[2]+(b?r/2:0)]);d.addPoint([q+N[0],-(n+N[1]),
v+N[2]+(b?r/2:0)]);q=G;n=I;v=K}u+=y}x=d.points.length;if(b){w=z;for(O=x;w<O;w++)d.addPoint([d.points[w][0],d.points[w][1],d.points[w][2]-(b?r/2:0)])}w=0;for(O=x-z;w<=O-4;w+=2)e%o===0&&g++,d.setSegment(g),A=[z+w,z+w+1,z+w+3,z+w+2],d.addFace(A),b&&(A=[A[3]+x-z,A[2]+x-z,A[1]+x-z,A[0]+x-z],d.addFace(A),A=[z+w,z+w+2,z+w+2+x-z,z+w+x-z],d.addFace(A),A=[z+w+1+x-z,z+w+3+x-z,z+w+3,z+w+1],d.addFace(A),w===0&&(A=[z+w+x-z,z+w+1+x-z,z+w+1,z+w],d.addFace(A)),w===O-4&&(A=[z+w+2,z+w+3,z+w+3+x-z,z+w+2+x-z],d.addFace(A))),
e++}d.calcFaceNormals();d.triangulateQuads();d.calcNormals();d.compile();return d}};return{GML:y}});CubicVR.RegisterModule("Landscape",function(t){function y(m,c,h,a){this.doTransform=function(){};this.tMatrix=o;this.parent=null;this.position=[0,0,0];this.scale=[1,1,1];this.size=m;this.divisions_w=c;this.divisions_h=h;this.matRef=a;this.children=null;this.obj=new CubicVR.Mesh;this.divisions_w>this.divisions_h?(this.size_w=m,this.size_h=m/this.divisions_w*this.divisions_h):(this.size_w=this.divisions_h>this.divisions_w?m/this.divisions_h*this.divisions_w:m,this.size_h=m);for(c=-(this.size_h/2);c<
this.size_h/2;c+=this.size_h/this.divisions_h)for(m=-(this.size_w/2);m<this.size_w/2;m+=this.size_w/this.divisions_w)this.obj.addPoint([m+this.size_w/this.divisions_w/2,0,c+this.size_h/this.divisions_h/2]);this.obj.setFaceMaterial(this.matRef);for(c=0;c<this.divisions_h-1;c++)for(m=0;m<this.divisions_w-1;m++)this.obj.addFace([m+(c+1)*this.divisions_w,m+1+c*this.divisions_w,m+c*this.divisions_w]),this.obj.addFace([m+(c+1)*this.divisions_w,m+1+(c+1)*this.divisions_w,m+1+c*this.divisions_w])}var s=t.undef,
o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],r=Math.PI/2;y.prototype={getMesh:function(){return this.obj},setIndexedHeight:function(m,c,h){obj.points[m+c*this.divisions_w][1]=h},mapGen:function(m,c,h,a,b){if(c!==s&&h!==s&&a!==s&&b!==s){if(!(c>=this.divisions_w)&&!(h>=this.divisions_h)&&(c+a>=this.divisions_w&&(a=this.divisions_w-1-c),h+b>=this.divisions_h&&(b=this.divisions_h-1-h),!(a<=0||b<=0)))for(var e=c,a=c+a;e<a;e++)for(var g=h,d=h+b;g<d;g++)c=this.obj.points[e+g*this.divisions_w],c[1]=m(c[0],c[2])}else{h=
0;for(b=this.obj.points.length;h<b;h++)c=this.obj.points[h],c[1]=m(c[0],c[2])}},getFaceAt:function(m,c){if(typeof m==="object")return this.getFaceAt(m[0],m[2]);var h=this.size_h/2-this.size_h/this.divisions_h/2,a=parseInt(Math.floor((m+(this.size_w/2-this.size_w/this.divisions_w/2))/this.size_w*this.divisions_w),10),h=parseInt(Math.floor((c+h)/this.size_h*this.divisions_h),10);if(a<0)return-1;if(a>=this.divisions_w-1)return-1;if(h<0)return-1;if(h>=this.divisions_h-1)return-1;var a=parseInt(a+h*(this.divisions_w-
1),10)*2,h=parseInt(a+1,10),b=this.obj.points[this.obj.faces[a].points[0]];return Math.abs(c-b[2])/Math.abs(m-b[0])>=1?a:h},getHeightValue:function(m,c){var h=CubicVR.triangle;if(typeof m==="object")return this.getHeightValue(m[0],m[2]);var a,b=this.getFaceAt(m,c);if(b===-1)return 0;a=this.obj.points[this.obj.faces[b].points[0]];var e=h.normal(this.obj.points[this.obj.faces[b].points[0]],this.obj.points[this.obj.faces[b].points[1]],this.obj.points[this.obj.faces[b].points[2]]),h=e[0],b=e[1],e=e[2];
return(h*m+e*c+(-(h*a[0])-b*a[1]-e*a[2]))/-b},orient:function(m,c,h,a,b,e){e===s&&(e=0);var g,d,q=[];g=h/2;var n=a/2;d=Math.sqrt(n*n+g*g);n=Math.atan2(n,g);b*=Math.PI/180;g=m+Math.sin(b)*e;e=c+Math.cos(b)*e;q[0]=this.getHeightValue([g+d*Math.cos(-n-r+b),0,e+d*-Math.sin(-n-r+b)]);q[1]=this.getHeightValue([g+d*Math.cos(n-r+b),0,e+d*-Math.sin(n-r+b)]);q[2]=this.getHeightValue([g+d*Math.cos(-n+r+b),0,e+d*-Math.sin(-n+r+b)]);q[3]=this.getHeightValue([g+d*Math.cos(n+r+b),0,e+d*-Math.sin(n+r+b)]);d=-Math.atan2(q[1]-
q[2],h);e=-Math.atan2(q[0]-q[1],a);d+=-Math.atan2(q[0]-q[3],h);e+=-Math.atan2(q[3]-q[2],a);d/=2;e/=2;return[[m,(q[2]+q[3]+q[1]+q[0])/4,c],[d*(180/Math.PI),b,e*(180/Math.PI)]]}};return{Landscape:y}});CubicVR.RegisterModule("Layout",function(){function t(s){this.texture=s.texture?s.texture:null;this.width=s.width?s.width:128;this.height=s.height?s.height:128;this.x=s.x?s.x:0;this.y=s.y?s.y:0;this.blend=s.blend?s.blend:!1;this.opacity=typeof s.opacity!=="undefined"?s.opacity:1;this.tint=s.tint?s.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function y(s){this.texture=s.texture?s.texture:null;this.width=s.width?s.width:128;this.height=s.height?s.height:128;
this.x=s.x?s.x:0;this.y=s.y?s.y:0;this.blend=s.blend?s.blend:!1;this.opacity=typeof s.opacity!=="undefined"?s.opacity:1;this.tint=s.tint?s.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}t.prototype={addSubview:function(s){this.childViews.push(s);s.superView=this},makePanel:function(s){return this.superView.makePanel(s)}};y.prototype={setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(s){s.setInt("srcTex",0);s.addVector("screen");s.addVector("position");s.addVector("tint");s.addVector("size")}})},addSubview:function(s){this.childViews.push(s);s.superView=this},removeSubview:function(s){s=this.childViews.indexOf(s);s>-1&&this.childViews.splice(s,
1)},makePanel:function(s){var o=CubicVR.GLCore.gl,r={};r.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);r.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);r.gl_points=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,r.gl_points);o.bufferData(o.ARRAY_BUFFER,r.vbo_points,o.STATIC_DRAW);r.gl_uvs=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,r.gl_uvs);o.bufferData(o.ARRAY_BUFFER,r.vbo_uvs,o.STATIC_DRAW);s.panel=r},renderPanel:function(s){if(!s.texture)return!1;s.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(s){if(s.texture){var o=CubicVR.GLCore.gl,r=s.offsetLeft,m=s.offsetTop;r||(r=0);m||(m=0);var c=this.shader.shader;c.use();c.setVector("screen",[this.width,this.height,0]);c.setVector("position",[s.x+r,s.y+m,0]);c.setVector("size",[s.width,s.height,0]);c.setVector("tint",s.tint);s.blend&&(o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA));s.texture.use(o.TEXTURE0);o.drawArrays(o.TRIANGLES,0,6);s.blend&&(o.disable(o.BLEND),o.blendFunc(o.ONE,o.ZERO))}},render:function(){var s=
CubicVR.GLCore.gl;s.disable(s.DEPTH_TEST);this.texture&&this.renderView(this);var o=[];this.offsetTop=this.offsetLeft=0;o.push(this);shader=this.shader.shader;shader.use();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null);s.bindBuffer(s.ARRAY_BUFFER,this.panel.gl_points);s.vertexAttribPointer(shader.uniforms.aVertex,3,s.FLOAT,!1,0,0);s.enableVertexAttribArray(shader.uniforms.aVertex);s.bindBuffer(s.ARRAY_BUFFER,this.panel.gl_uvs);s.vertexAttribPointer(shader.uniforms.aTex,2,s.FLOAT,!1,0,0);s.enableVertexAttribArray(shader.uniforms.aTex);
for(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null);o.length;){var r=o.pop();this.renderView(r);if(r.childViews.length)for(var m=r.childViews.length-1;m>=0;m--)r.childViews[m].offsetLeft=r.x+r.offsetLeft,r.childViews[m].offsetTop=r.y+r.offsetTop,o.push(r.childViews[m])}s.disableVertexAttribArray(shader.uniforms.aTex);s.enable(s.DEPTH_TEST)}};return{Layout:y,View:t}});CubicVR.RegisterModule("Light",function(t){function y(c,h){var a=CubicVR.aabb;if(c===r)c=o.light.type.POINT;if(h===r)h=o.light.method.DYNAMIC;typeof c=="object"?(this.light_type=c.type!==r?c.type:o.light.type.POINT,this.diffuse=c.diffuse!==r?c.diffuse:[1,1,1],this.specular=c.specular!==r?c.specular:[1,1,1],this.intensity=c.intensity!==r?c.intensity:1,this.position=c.position!==r?c.position:[0,0,0],this.direction=c.direction!==r?c.direction:[0,0,0],this.distance=c.distance!==r?c.distance:this.light_type===
o.light.type.AREA?30:10,this.cutoff=c.cutoff!==r?c.cutoff:60,this.map_res=c.map_res!==r?c.map_res:this.light_type===o.light.type.AREA?2048:512,this.map_res=c.mapRes!==r?c.mapRes:this.map_res,this.method=c.method!==r?c.method:h,this.areaCam=c.areaCam!==r?c.areaCam:null,this.areaCeiling=c.areaCeiling!==r?c.areaCeiling:40,this.areaFloor=c.areaFloor!==r?c.areaFloor:-40,this.areaAxis=c.areaAxis!==r?c.areaAxis:[1,1,0],this.projectorTex=c.projector!==r?c.projector:null):(this.light_type=c,this.diffuse=[1,
1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===o.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===o.light.type.AREA?2048:512,this.method=h,this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=
!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=CubicVR.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===o.light.type.SPOT_SHADOW||this.light_type===o.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===o.light.type.AREA&&t.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var s=t.GLCore,o=CubicVR.enums,r=t.undef,m=[1,0,
0,0,0,1,0,0,0,0,1,0,0,0,0,1];o.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};y.prototype={setType:function(c){if(c===o.light.type.AREA&&!t.features.lightShadows)this.dummyCam=new CubicVR.Camera,this.areaCam=new CubicVR.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,c=o.light.type.DIRECTIONAL;else if((c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR)&&!t.features.lightShadows)c=
o.light.type.SPOT;this.light_type=c},setParent:function(c){this.parent=c},setMethod:function(c){this.method=c},setDiffuse:function(c){this.diffuse=c},setSpecular:function(c){this.specular=c},setIntensity:function(c){this.intensity=c},setPosition:function(c){this.position=c},setDistance:function(c){this.distance=c},setCutoff:function(c){this.cutoff=c},prepare:function(c){var h=CubicVR.mat4,a=CubicVR.mat3,b=this.light_type;if(this.parent)if(b===o.light.type.SPOT||b===o.light.type.SPOT_SHADOW||b===o.light.type.SPOT_SHADOW_PROJECTOR)b=
h.inverse_mat3(this.parent.tMatrix),a.transpose_inline(b),this.lDir=a.vec3_multiply(this.direction,b),this.lDir=a.vec3_multiply(this.lDir,c.nMatrix),this.lPos=h.vec3_multiply(this.position,h.multiply(c.mvMatrix,this.parent.tMatrix));else{if(b===o.light.type.POINT)this.lPos=h.vec3_multiply(this.position,h.multiply(c.mvMatrix,this.parent.tMatrix))}else if(b===o.light.type.DIRECTIONAL)this.lDir=a.vec3_multiply(this.direction,c.nMatrix);else if(b===o.light.type.SPOT||b===o.light.type.SPOT_SHADOW||b===
o.light.type.SPOT_SHADOW_PROJECTOR)this.lDir=a.vec3_multiply(this.direction,c.nMatrix),this.lPos=h.vec3_multiply(this.position,c.mvMatrix);else if(b===o.light.type.POINT)this.lPos=h.vec3_multiply(this.position,c.mvMatrix);else if(b===o.light.type.AREA)this.lDir=a.vec3_multiply(this.direction,c.nMatrix)},control:function(c,h,a){if(c===o.motion.POS)this.position[h]=a;else if(c===o.motion.INTENSITY)this.intensity=a},getAABB:function(){var c=CubicVR.vec3,h=CubicVR.aabb,a=[[0,0,0],[0,0,0]];h.engulf(a,
[this.distance,this.distance,this.distance]);h.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=c.add(a[0],this.position);a[1]=c.add(a[1],this.position);return this.aabb=a},setDirection:function(c,h,a){var b=CubicVR.vec3;if(typeof c==="object")this.setDirection(c[0],c[1],c[2]);else return this.direction=b.normalize([c,h,a]),this},lookat:function(c,h,a){var b=CubicVR.vec3;if(typeof c==="object")this.lookat(c[0],c[1],c[2]);else return this.direction=b.normalize(b.subtract([c,h,a],this.position)),
this},setRotation:function(c,h,a){var b=CubicVR.mat4,e=CubicVR.vec3;if(typeof c==="object")this.setRotation(c[0],c[1],c[2]);else{var g=new CubicVR.Transform;g.rotate([-c,-h,-a]);g.pushMatrix();this.direction=e.normalize(b.vec3_multiply([1,0,0],g.getResult()));this.rotation=[c,h,a];return this}},setupShader:function(c,h){var a=s.gl;a.uniform3fv(c.lDiff[h],this.diffuse);a.uniform3fv(c.lSpec[h],this.specular);this.lPos&&a.uniform3fv(c.lPos[h],this.lPos);this.lDir&&a.uniform3fv(c.lDir[h],this.lDir);a.uniform1f(c.lInt[h],
this.intensity);a.uniform1f(c.lDist[h],this.distance);(this.light_type===o.light.type.SPOT_SHADOW||this.light_type===o.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===o.light.type.SPOT)&&a.uniform1f(c.lCut[h],this.cutoff);if(this.light_type===o.light.type.SPOT_SHADOW||this.light_type===o.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===o.light.type.AREA)this.light_type===o.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(s.gl.TEXTURE0+h*2),a.uniform1i(c.lDepthTex[h],h*2),this.projectorTex.use(s.gl.TEXTURE0+
h*2+1),a.uniform1i(c.lProjTex[h],h*2+1)):(this.shadowMapTex.texture.use(s.gl.TEXTURE0+h),a.uniform1i(c.lDepthTex[h],h)),a.uniform3fv(c.lDepth[h],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(c.spMatrix[h],!1,this.spMatrix)},setShadow:function(c){if(t.features.lightShadows)this.map_res=c,this.shadowMapTex=new CubicVR.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(o.texture.filter.NEAREST),this.dummyCam=new CubicVR.Camera(this.map_res,
this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0},hasShadow:function(){return has_shadow},setProjector:function(c){this.projectorTex=c},hasProjector:function(){return this.projectorTex!==null?!0:!1},shadowBegin:function(){var c=s.gl,h=CubicVR.mat4,a=CubicVR.mat3;this.shadowMapTex.use();c.viewport(0,0,this.map_res,this.map_res);c.clear(c.DEPTH_BUFFER_BIT|c.COLOR_BUFFER_BIT);this.light_type!==o.light.type.AREA?(this.dummyCam.setClip(0.1,
this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var b=h.inverse_mat3(this.parent.tMatrix);a.transpose_inline(b);a.vec3_multiply(this.direction,b);h.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);h.multiply(this.dummyCam.mvMatrix.slice(0),h.inverse(this.parent.tMatrix),
this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);c.cullFace(c.FRONT)},shadowEnd:function(){var c=s.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.cullFace(c.BACK);this.setupTexGen()},setupTexGen:function(){var c=CubicVR.mat4;this.spMatrix=c.multiply(m,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=c.multiply(this.spMatrix,
this.dummyCam.pMatrix);this.spMatrix=c.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(c){this.areaAxis=c},updateAreaLight:function(){var c=CubicVR.vec3,h=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),b=c.subtract(this.areaCam.target,this.areaCam.position);b[1]=0;b=c.normalize(b);c.normalize(c.cross(b,[0,1,0]));var e=-Math.atan2(b[2],b[0]),a=this.distance/2*Math.abs(a)-this.distance/2;
a<this.distance/3/2&&(a=this.distance/3/2);b=c.multiply(b,a);a=[Math.tan(this.areaAxis[1]*(Math.PI/180)),0,Math.tan(this.areaAxis[0]*(Math.PI/180))];e-=Math.atan2(a[0],a[2]);this.position=c.add(c.add(this.areaCam.position,b),c.multiply(a,h));this.position[1]=this.areaCeiling;this.target=c.add(c.add(this.areaCam.position,b),c.multiply(a,-h));this.target[1]=this.areaFloor;this.direction=c.normalize(c.subtract(this.target,this.position));this.dummyCam.rotation[2]=e*(180/Math.PI);c=this.dummyCam.nearclip;
h=this.dummyCam.farclip*Math.abs(this.direction[1])*h;c=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);c=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);c[1][1]>this.areaFloor&&(c=c[1][1]-this.areaFloor,h+=c/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=h;this.dummyCam.setOrtho(-this.distance/2,this.distance/
2,-this.distance/2,this.distance/2)},orthoBounds:function(c,h,a,b,e,g){var b=CubicVR.vec3,d=b.normalize([e[0],e[4],e[8]]),q=b.normalize([e[1],e[5],e[9]]),e=b.normalize(b.cross(q,d)),n;n=a/2;a=[];h=b.multiply(d,h/2);d=b.multiply(q,n);g=b.multiply(e,g);a[0]=b.add(b.subtract(c,h),b.add(d,g));a[1]=b.add(b.add(c,h),b.add(d,g));a[2]=b.subtract(b.subtract(c,h),b.add(d,g));a[3]=b.subtract(b.add(c,h),b.add(d,g));aabb1=a[0];aabb2=a[0];for(c=1;c<4;c++)aabb1[0]>a[c][0]&&(aabb1[0]=a[c][0]),aabb1[1]>a[c][1]&&(aabb1[1]=
a[c][1]),aabb1[2]>a[c][2]&&(aabb1[2]=a[c][2]),aabb2[0]<a[c][0]&&(aabb2[0]=a[c][0]),aabb2[1]<a[c][1]&&(aabb2[1]=a[c][1]),aabb2[2]<a[c][2]&&(aabb2[2]=a[c][2]);return[aabb1,aabb2]}};return{Light:y}});CubicVR.RegisterModule("MainLoop",function(t){function y(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function s(){CubicVR.GLCore.mainloop!==null&&(window.requestAnimationFrame&&window.requestAnimationFrame(s),CubicVR.GLCore.mainloop.interval())}function o(h,a,b){if(window.requestAnimationFrame===m)window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null;if(CubicVR.GLCore.mainloop!==null)!window.requestAnimationFrame&&CubicVR.GLCore.mainloop&&clearInterval(CubicVR.GLCore.mainloop.interval),CubicVR.GLCore.mainloop=null;if(h===null)CubicVR.GLCore.mainloop=null;else{this.renderList=[];var e=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],g=new y;g.start();this.timer=g;this.func=h;this.doclear=a!==m?a:!0;CubicVR.GLCore.mainloop=this;if(c.resizeList.length&&!CubicVR.GLCore.resize_active)window.addEventListener("resize",
function(){CubicVR.GLCore.onResize()},!1),CubicVR.GLCore.resize_active=!0;a=function(){return function(){var a=CubicVR.GLCore.gl;g.update();CubicVR.GLCore.mainloop.doclear&&a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);h(g,CubicVR.GLCore.gl);var b=e[e.length-1],n=b.scenes;b.update&&b.update(g,a);if(n){a=0;for(b=n.length;a<b;++a){var c=n[a];c.paused||(c.update&&c.update(g,CubicVR.GLCore.gl),c.render())}}}}();b?this.loopFunc=a:window.requestAnimationFrame?(this.interval=a,window.requestAnimationFrame(s)):
this.interval=setInterval(a,20)}}function r(c,a,b){this.canvas=c;this.camera=a;this.mpos=[0,0];this.mdown=!1;var e=this;this.mEvents={};this.keyState=[];this.onMouseDown=function(){return function(a){e.mdown=!0;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseDown&&e.mEvents.mouseDown(e,e.mpos,e.keyState)}}();this.onMouseUp=function(){return function(a){e.mdown=!1;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseUp&&e.mEvents.mouseUp(e,e.mpos,
e.keyState)}}();this.onMouseMove=function(){return function(a){var d=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d[0]=a[0]-e.mpos[0];d[1]=a[1]-e.mpos[1];e.mpos=a;e.mEvents.mouseMove&&e.mEvents.mouseMove(e,e.mpos,d,e.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:-a.detail*100;e.mEvents.mouseWheel&&e.mEvents.mouseWheel(e,e.mpos,a,e.keyState)}}();this.onKeyDown=function(){return function(){}}();this.onKeyUp=function(){return function(){}}();
this.eventDefaults={mouseMove:function(a,d,b){a.mdown&&a.orbitView(b)},mouseWheel:function(a,d,b){a.zoomView(b)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null};b!==!1&&this.setEvents(b===m?this.eventDefaults:b);this.bind()}var m=t.undef,c=t.GLCore;y.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},
reset:function(){this.start()},lockFramerate:function(){this.lock_rate=1/this.f_rate;this.lock_state=!0},unlock:function(){var c=this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=c-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.lock_state?this.system_milliseconds+=lock_rate*1E3|0:this.system_milliseconds=
Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(c){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-c},setSeconds:function(c){this.setMilliseconds(c*1E3|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/
1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(c){this.paused_state=c},getPaused:function(){return this.paused_state}};o.prototype={setPaused:function(c){this.timer.setPaused(c)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(c){this.timer.setSeconds(c)},
getTimerSeconds:function(){return this.timer.getSeconds()},resetTimer:function(){this.timer.reset()},addScene:function(c){this.renderStack[this.renderStack.length-1].scenes.push(c);return c},pushSceneGroup:function(c){c.scenes=c.scenes||[];this.renderStack.push(c);for(var a=0;a<c.scenes.length;++a)c.scenes[a].enable();c.start&&c.start()},popSceneGroup:function(){for(var c=this.renderStack[this.renderStack.length-1],a=0;a<c.scenes.length;++a)c.scenes[a].disable();this.renderStack.length>1&&this.renderStack.pop();
c.stop&&c.stop()},getScene:function(c){for(var a=renderStack[renderStack.length-1],b,e=0,g=a.scenes.length;e<g;++e)if(a.scenes[e].scene.name===c){b=a.scenes[e];break}return b},resumeScene:function(c){typeof c==="string"&&(c=this.getScene(c));c.enable();c.paused=!1},pauseScene:function(c){typeof c==="string"&&(c=this.getScene(c));c.paused=!0;c.disable()},removeScene:function(c){var a=renderStack[renderStack.length-1];typeof c==="string"&&(c=this.getScene(c));var b=a.scenes.indexOf(c);b>-1&&a.scenes.splice(b,
1);return c},runOnce:function(){this.loopFunc()}};r.prototype={setEvents:function(c){this.mEvents={};for(var a in c)this.bindEvent(a,c[a])},orbitView:function(c){var a=CubicVR.vec3,b=a.subtract(this.camera.target,this.camera.position),b=a.length(b);this.camera.position=a.moveViewRelative(this.camera.position,this.camera.target,-b*c[0]/300,0);this.camera.position[1]+=b*c[1]/300;this.camera.position=a.add(this.camera.target,a.multiply(a.normalize(a.subtract(this.camera.position,this.camera.target)),
b))},panView:function(c,a){var b=CubicVR.vec3;a||(a=!1);var e=b.subtract(this.camera.target,this.camera.position),e=b.length(e),g=this.camera.position;a?this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*c[0]/300,-e*c[1]/300):(this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*c[0]/300,0),this.camera.position[1]+=e*c[1]/300);e=b.subtract(this.camera.position,g);this.camera.target=b.add(this.camera.target,e)},zoomView:function(c,a,b){var e=
CubicVR.vec3,g=e.subtract(this.camera.target,this.camera.position),g=e.length(g);g-=c/1E3;a||(a=0.1);b||(b=1E3);g<a&&(g=a);g>b&&(g=b);this.camera.position=e.add(this.camera.target,e.multiply(e.normalize(e.subtract(this.camera.position,this.camera.target)),g))},bindEvent:function(c,a){this.mEvents[c]=a===m?this.eventDefaults[c]:a},unbindEvent:function(c){this.bindEvent(c,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,
!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);this.canvas.addEventListener("keydown",this.onKeyDown,!1);this.canvas.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,
!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);this.canvas.removeEventListener("keydown",this.onKeyDown,!1);this.canvas.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(c){this.camera=c},getMousePosition:function(){return this.mpos}};return{Timer:y,MainLoop:o,MouseViewController:r,setMainLoop:function(c){CubicVR.GLCore.mainloop=c}}});CubicVR.RegisterModule("Texture",function(t){function y(a){var d=CubicVR.GLCore.gl;if(a.nodeName==="CANVAS"||a.nodeName==="IMG")this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(a.width===void 0||a.height===void 0)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;this.canvasSource.height=a.height;this.canvasContext=this.canvasSource.getContext("2d")}var b=this.canvasSource,n=b.width,b=b.height,e=!0;if(n===
1||b===1)e=!1;else{if(n!==1)for(;n%2===0;)n/=2;if(b!==1)for(;b%2===0;)b/=2;n>1&&(e=!1);b>1&&(e=!1)}this.updateFunction=a.update;this.texture=new CubicVR.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;e?(this.setFilter(h.texture.filter.LINEAR_MIP),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT)):(this.setFilter(h.texture.filter.LINEAR),
d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE));a.nodeName==="IMG"&&this.update()}function s(a,d,b){var n=CubicVR.GLCore.gl;this.texture=new CubicVR.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=d;this.canvas.height=b;this.pjs=new Processing(this.canvas,CubicVR.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();a=this.canvas.width;d=this.canvas.height;b=!0;if(a===1||d===1)b=!1;else{if(a!==1)for(;a%
2===0;)a/=2;if(d!==1)for(;d%2===0;)d/=2;a>1&&(b=!1);d>1&&(b=!1)}this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;b?this.setFilter(h.texture.filter.LINEAR_MIP):(this.setFilter(h.texture.filter.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE))}function o(a,d,b){var n=c.gl;this.width=d;this.height=b;this.srcTex=
a;this.outTex=new CubicVR.RenderBuffer(d,b);var a=d,e=b;if(!(a===1||e===1)){if(a!==1)for(;a%2===0;)a/=2;if(e!==1)for(;e%2===0;)e/=2}a=[1/d,1/b,0];this.outputBuffer=new CubicVR.RenderBuffer(d,b,!1);this.fsQuad=CubicVR.fsQuad.make(d,b);shaderNMap=new CubicVR.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",a);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(n.TEXTURE0);this.setFilter(h.texture.filter.LINEAR);
n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT)}function r(a,d,b){var n=c.gl;this.width=a;this.height=d;this.outTex=new CubicVR.RenderBuffer(a,d,b);this.texture=this.outTex.texture;var e=a,m=d,w=!0;if(e===1||m===1)w=!1;else{if(e!==1)for(;e%2===0;)e/=2;if(m!==1)for(;m%2===0;)m/=2;e>1&&(w=!1);m>1&&(w=!1)}this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;
this.filterType=this.outTex.texture.filterType;this.texture.use(n.TEXTURE0);w?(this.setFilter(h.texture.filter.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT)):(this.setFilter(h.texture.filter.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE));this.dims=[a,d];this.depth=b?!0:!1}function m(a,d){this.scene=a;this.renderTex=new r(d?d.width:a.camera.width,
d?d.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var c=t.GLCore,h=CubicVR.enums,a=t.undef;h.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var b=function(a,d){this.img_path=a;this.filter_type=d};b.prototype=
{getTexture:function(a,d){return new e(this.img_path,this.filter_type,a,d)}};var e=function(b,d,q,n,e){var m=c.gl;this.tex_id=t.Textures.length;this.filterType=-1;this.onready=e;this.loaded=!1;t.Textures[this.tex_id]=m.createTexture();t.Textures_obj[this.tex_id]=this;if(b)typeof b==="string"?t.Images[this.tex_id]=new Image:typeof b==="object"&&b.nodeName==="IMG"&&(t.Images[this.tex_id]=b),t.Textures_ref[b]=this.tex_id;m.bindTexture(m.TEXTURE_2D,t.Textures[this.tex_id]);m.texParameteri(m.TEXTURE_2D,
m.TEXTURE_MAG_FILTER,m.LINEAR);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.LINEAR);if(b){var w=this.tex_id,r=d!==a?d:c.default_filter,o=this;t.Images[this.tex_id].onload=function(){m.bindTexture(m.TEXTURE_2D,t.Textures[w]);m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!0);m.pixelStorei(m.UNPACK_COLORSPACE_CONVERSION_WEBGL,m.NONE);var a=t.Images[w];m.texImage2D(m.TEXTURE_2D,0,m.RGBA,m.RGBA,m.UNSIGNED_BYTE,a);var d=a.width,a=a.height,b=!0;if(d===1||a===1)b=!1;else{if(d!==1)for(;d%2===0;)d/=2;if(a!==1)for(;a%
2===0;)a/=2;d>1&&(b=!1);a>1&&(b=!1)}b||(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE));if(t.Textures_obj[w].filterType===-1){if(!b&&r===h.texture.filter.LINEAR_MIP)r=h.texture.filter.LINEAR;t.Textures_obj[w].filterType===-1&&t.Textures_obj[w].setFilter(r)}else t.Textures_obj[w].setFilter(t.Textures_obj[w].filterType);m.bindTexture(m.TEXTURE_2D,null);if(o.onready)o.onready();o.loaded=!0};if(q)t.Images[this.tex_id].deferredSrc=
b,q.addImage(n,b,t.Images[this.tex_id]);else if(typeof b==="string")t.Images[this.tex_id].src=b}this.active_unit=-1};e.prototype={setFilter:function(a){var d=CubicVR.GLCore.gl;d.bindTexture(d.TEXTURE_2D,t.Textures[this.tex_id]);a===h.texture.filter.LINEAR?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR)):a===h.texture.filter.LINEAR_MIP?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,
d.LINEAR_MIPMAP_NEAREST),d.generateMipmap(d.TEXTURE_2D)):a===h.texture.filter.NEAREST?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST)):a===h.texture.filter.NEAREST_MIP&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST_MIPMAP_LINEAR),d.generateMipmap(d.TEXTURE_2D));this.filterType=a},use:function(a){c.gl.activeTexture(a);c.gl.bindTexture(c.gl.TEXTURE_2D,
t.Textures[this.tex_id]);this.active_unit=a},clear:function(){if(this.active_unit!==-1)c.gl.activeTexture(this.active_unit),c.gl.bindTexture(c.gl.TEXTURE_2D,null),this.active_unit=-1}};y.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=CubicVR.GLCore.gl;a.bindTexture(a.TEXTURE_2D,t.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===
h.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};s.prototype={update:function(){var a=CubicVR.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,t.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===h.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};o.prototype={update:function(){var a=c.gl,d=a.getParameter(a.VIEWPORT);
this.outputBuffer.use();a.viewport(0,0,this.width,this.height);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);this.srcTex.use(a.TEXTURE0);CubicVR.fsQuad.render(this.shaderNorm,this.fsQuad);a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(d[0],d[1],d[2],d[3])}};r.prototype={begin:function(){var a=c.gl;this.dims=a.getParameter(a.VIEWPORT);this.outTex.use();a.viewport(0,0,this.width,this.height);this.depth?a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT):a.clear(a.COLOR_BUFFER_BIT)},end:function(){var a=
c.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};m.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:e,DeferredLoadTexture:b,CanvasTexture:y,TextTexture:function(b,d){var q=d&&d.color||"#fff",n=d&&d.bgcolor,e=d&&d.font||"18pt Arial",c=d&&d.align||"start",h=d&&d.y||0,m=d&&d.width||a,r=d&&d.height||a,o,s=document.createElement("CANVAS"),A=s.getContext("2d"),
z=0,z=typeof b==="string"?1:b.length;A.font=e;var u=d&&d.lineHeight||A.measureText("OO").width,t;if(z===1)t=A.measureText(b).width;else for(o=t=0;o<z;++o){var D=A.measureText(b[o]).width;D>t&&(t=D)}s.width=m||t;s.height=r||u*z;if(n)A.fillStyle=n,A.fillRect(0,0,s.width,s.height);A.fillStyle=q;A.font=e;A.textAlign=c;A.textBaseline="top";if(z===1)q=d&&d.x||c==="center"?s.width/2:c==="right"?s.width:0,A.fillText(b,q,h);else for(o=0;o<z;++o)q=d&&d.x||c==="center"?s.width/2:c==="right"?s.width:0,A.fillText(b[o],
q,h+o*u);A.fill();this.use=y.prototype.use;this.clear=y.prototype.clear;this.update=y.prototype.update;y.apply(this,[s]);this.update();this.canvasSource=null},PJSTexture:s,NormalMapGen:o,RenderTexture:r,SceneRenderTexture:m}});CubicVR.RegisterModule("Material",function(t){function y(c){this.initialized=!1;this.textures=[];this.shader=[];this.customShader=null;typeof c==="object"?(this.diffuse=c.diffuse===s?[1,1,1]:c.diffuse,this.specular=c.specular===s?[0.1,0.1,0.1]:c.specular,this.color=c.color===s?[1,1,1]:c.color,this.ambient=c.ambient===s?[0,0,0]:c.ambient,this.opacity=c.opacity===s?1:c.opacity,this.shininess=c.shininess===s?1:c.shininess,this.max_smooth=c.max_smooth===s?60:c.max_smooth,this.env_amount=c.env_amount===
s?0.75:c.env_amount,this.morph=c.morph===s?!1:c.morph,this.color_map=c.colorMap===s?!1:c.colorMap,this.name=c.name===s?s:c.name,typeof c.textures==="object"&&(c.textures.color!==s&&this.setTexture(c.textures.color,r.texture.map.COLOR),c.textures.envsphere!==s&&this.setTexture(c.textures.envsphere,r.texture.map.ENVSPHERE),c.textures.normal!==s&&this.setTexture(c.textures.normal,r.texture.map.NORMAL),c.textures.bump!==s&&this.setTexture(c.textures.bump,r.texture.map.BUMP),c.textures.reflect!==s&&this.setTexture(c.textures.reflect,
r.texture.map.REFLECT),c.textures.specular!==s&&this.setTexture(c.textures.specular,r.texture.map.SPECULAR),c.textures.ambient!==s&&this.setTexture(c.textures.ambient,r.texture.map.AMBIENT),c.textures.alpha!==s&&this.setTexture(c.textures.alpha,r.texture.map.ALPHA))):(this.diffuse=[1,1,1],this.specular=[0.1,0.1,0.1],this.color=[1,1,1],this.ambient=[0,0,0],this.shininess=this.opacity=1,this.max_smooth=60,this.name=c,this.color_map=this.morph=!1)}var s=t.undef,o=t.GLCore,r=CubicVR.enums,m=[r.texture.map.REFLECT,
r.texture.map.SPECULAR,r.texture.map.NORMAL,r.texture.map.BUMP];y.prototype={setTexture:function(c,h){h===s&&(h=0);if(t.features.texturePerPixel||m.indexOf(h)===-1)this.textures[h]=c},calcShaderMask:function(){var c=0;c+=typeof this.textures[r.texture.map.COLOR]==="object"?r.shader.map.COLOR:0;c+=typeof this.textures[r.texture.map.SPECULAR]==="object"?r.shader.map.SPECULAR:0;c+=typeof this.textures[r.texture.map.NORMAL]==="object"?r.shader.map.NORMAL:0;c+=typeof this.textures[r.texture.map.BUMP]===
"object"?r.shader.map.BUMP:0;c+=typeof this.textures[r.texture.map.REFLECT]==="object"?r.shader.map.REFLECT:0;c+=typeof this.textures[r.texture.map.ENVSPHERE]==="object"?r.shader.map.ENVSPHERE:0;c+=typeof this.textures[r.texture.map.AMBIENT]==="object"?r.shader.map.AMBIENT:0;c+=typeof this.textures[r.texture.map.ALPHA]==="object"?r.shader.map.ALPHA:0;c+=this.opacity!==1?r.shader.map.ALPHA:0;return c},getShaderHeader:function(c,h){return(h!==s?"#define loopCount "+h+"\n":"")+"#define hasColorMap "+
(typeof this.textures[r.texture.map.COLOR]==="object"?1:0)+"\n#define hasSpecularMap "+(typeof this.textures[r.texture.map.SPECULAR]==="object"?1:0)+"\n#define hasNormalMap "+(typeof this.textures[r.texture.map.NORMAL]==="object"?1:0)+"\n#define hasBumpMap "+(typeof this.textures[r.texture.map.BUMP]==="object"?1:0)+"\n#define hasReflectMap "+(typeof this.textures[r.texture.map.REFLECT]==="object"?1:0)+"\n#define hasEnvSphereMap "+(typeof this.textures[r.texture.map.ENVSPHERE]==="object"?1:0)+"\n#define hasAmbientMap "+
(typeof this.textures[r.texture.map.AMBIENT]==="object"?1:0)+"\n#define hasAlphaMap "+(typeof this.textures[r.texture.map.ALPHA]==="object"?1:0)+"\n#define hasAlpha "+(this.opacity!==1?1:0)+"\n#define lightPoint "+(c===r.light.type.POINT?1:0)+"\n#define lightDirectional "+(c===r.light.type.DIRECTIONAL?1:0)+"\n#define lightSpot "+(c===r.light.type.SPOT||c===r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define hasShadow "+(c===r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR||
c===r.light.type.AREA?1:0)+"\n#define hasProjector "+(c===r.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define softShadow "+(o.soft_shadow?1:0)+"\n#define lightArea "+(c===r.light.type.AREA?1:0)+"\n#define depthPack "+(c===r.light.type.DEPTH_PACK?1:0)+"\n#define alphaDepth "+(o.depth_alpha?1:0)+"\n#define hasMorph "+(this.morph?1:0)+"\n#define hasVertexColorMap "+(this.color_map?1:0)+"\n#define perPixel "+(t.features.lightPerPixel?1:0)+"\n\n"},bindObject:function(c,h){var a=o.gl,b=h.aVertexPosition,
e=h.aTextureCoord,g=h.aNormal,d=h.aColor;a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_points);a.vertexAttribPointer(b,3,a.FLOAT,!1,0,0);a.enableVertexAttribArray(b);e!==null&&c.compiled.gl_uvs!==null&&e!==-1&&(a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_uvs),a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(e));g!==null&&c.compiled.gl_normals!==null&&g!==-1&&(a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_normals),a.vertexAttribPointer(g,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(g));d!==
null&&c.compiled.gl_colors!==null&&d!==-1&&(a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_colors),a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(d));if(c.morphTarget)b=h.amVertexPosition,g=h.amNormal,a.bindBuffer(a.ARRAY_BUFFER,c.morphTarget.gl_points),a.vertexAttribPointer(b,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(b),g!==null&&c.morphTarget.gl_normals!==null&&g!==-1&&(a.bindBuffer(a.ARRAY_BUFFER,c.morphTarget.gl_normals),a.vertexAttribPointer(g,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(g)),
a.uniform1f(h.morphWeight,c.morphWeight);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.compiled.gl_elements)},clearObject:function(c,h){var a=o.gl,b=h.aTextureCoord,e=h.aNormal,g=h.aColor;b!==null&&c.compiled.gl_uvs!==null&&b!==-1&&a.disableVertexAttribArray(b);e!==null&&c.compiled.gl_normals!==null&&e!==-1&&a.disableVertexAttribArray(e);g!==null&&c.compiled.gl_colors!==null&&g!==-1&&a.disableVertexAttribArray(g);if(c.morphTarget)up=h.amVertexPosition,a.disableVertexAttribArray(up),e=h.amNormal,e!==null&&
c.compiled.gl_normals!==null&&e!==-1&&a.disableVertexAttribArray(e)},use:function(c,h){h===s&&(h=0);if(this.customShader!==null)this.customShader.use();else{c===s&&(c=0);var a,b=this.textures;this.shader[c]===s&&(this.shader[c]=[]);if(this.shader[c][h]===s){var e=this.calcShaderMask(c);t.ShaderPool[c][e]===s&&(t.ShaderPool[c][e]=[]);if(t.ShaderPool[c][e][h]===s){a=this.getShaderHeader(c,h);var g=new CubicVR.Shader(a+o.CoreShader_vs,a+o.CoreShader_fs);t.ShaderPool[c][e][h]=g;a=0;if(c!==r.light.type.DEPTH_PACK){if(c===
r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR||c===r.light.type.AREA)a+=h,c===r.light.type.SPOT_SHADOW_PROJECTOR&&(a+=h);typeof b[r.texture.map.COLOR]==="object"&&g.addInt("colorMap",a++);typeof b[r.texture.map.ENVSPHERE]==="object"&&g.addInt("envSphereMap",a++);typeof b[r.texture.map.NORMAL]==="object"&&g.addInt("normalMap",a++);typeof b[r.texture.map.BUMP]==="object"&&g.addInt("bumpMap",a++);typeof b[r.texture.map.REFLECT]==="object"&&g.addInt("reflectMap",a++);typeof b[r.texture.map.SPECULAR]===
"object"&&g.addInt("specularMap",a++);typeof b[r.texture.map.AMBIENT]==="object"&&g.addInt("ambientMap",a++)}typeof b[r.texture.map.ALPHA]==="object"&&g.addInt("alphaMap",a++);g.addMatrix("uMVMatrix");g.addMatrix("uPMatrix");g.addMatrix("uOMatrix");g.addMatrix("uNMatrix");g.addVertexArray("aVertexPosition");g.addVertexArray("aNormal");this.color_map&&g.addVertexArray("aColor");this.morph&&(g.addVertexArray("amVertexPosition"),g.addVertexArray("amNormal"),g.addFloat("morphWeight",0));for(a=0;a<h;a++)if(g.addVector("lDiff["+
a+"]"),g.addVector("lSpec["+a+"]"),g.addFloat("lInt["+a+"]"),g.addFloat("lDist["+a+"]"),g.addVector("lPos["+a+"]"),g.addVector("lDir["+a+"]"),(c===r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR||c===r.light.type.SPOT)&&g.addFloat("lCut["+a+"]"),c===r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR||c===r.light.type.AREA)g.addInt("lDepthTex["+a+"]"),c===r.light.type.SPOT_SHADOW_PROJECTOR&&g.addInt("lProjTex["+a+"]"),g.addVector("lDepth["+a+"]"),g.addMatrix("spMatrix["+
a+"]");c!==r.light.type.DEPTH_PACK&&(g.addVector("lAmb"),g.addVector("mDiff"),g.addVector("mColor"),g.addVector("mAmb"),g.addVector("mSpec"),g.addFloat("mShine"),g.addFloat("envAmount"));g.addFloat("mAlpha");(o.depth_alpha||c===r.light.type.DEPTH_PACK||c===r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR||c===r.light.type.AREA)&&g.addVector("depthInfo");g.addUVArray("aTextureCoord")}this.shader[c][h]=t.ShaderPool[c][e][h]}e=this.shader[c][h];g=o.gl;e.use();a=0;var d;if(c!==r.light.type.DEPTH_PACK){if(c===
r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR||c===r.light.type.AREA)a+=h,c===r.light.type.SPOT_SHADOW_PROJECTOR&&(a+=h);if(d=b[r.texture.map.COLOR])d.use(o.gl.TEXTURE0+a),a++;if(d=b[r.texture.map.ENVSPHERE])d.use(o.gl.TEXTURE0+a),a++,g.uniform1f(e.envAmount,this.env_amount);if(d=b[r.texture.map.NORMAL])d.use(o.gl.TEXTURE0+a),a++;if(d=b[r.texture.map.BUMP])d.use(o.gl.TEXTURE0+a),a++;if(d=b[r.texture.map.REFLECT])d.use(o.gl.TEXTURE0+a),a++;if(d=b[r.texture.map.SPECULAR])d.use(o.gl.TEXTURE0+
a),a++;if(d=b[r.texture.map.AMBIENT])d.use(o.gl.TEXTURE0+a),a++}(d=b[r.texture.map.ALPHA])&&d.use(o.gl.TEXTURE0+a);c!==r.light.type.DEPTH_PACK?(g.uniform3fv(e.mColor,this.color),g.uniform3fv(e.mDiff,this.diffuse),g.uniform3fv(e.mAmb,this.ambient),g.uniform3fv(e.mSpec,this.specular),g.uniform1f(e.mShine,this.shininess*128),g.uniform3fv(e.lAmb,CubicVR.globalAmbient),(o.depth_alpha||c===r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR||c===r.light.type.AREA)&&g.uniform3fv(e.depthInfo,
[o.depth_alpha_near,o.depth_alpha_far,0])):g.uniform3fv(e.depthInfo,[o.shadow_near,o.shadow_far,0]);this.opacity!==1&&g.uniform1f(e.mAlpha,this.opacity)}}};return{Material:y}});CubicVR.RegisterModule("Math",function(t){function y(a){return this.clearStack(a)}function s(){if(arguments.length===1)this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3];if(arguments.length===4)this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3]}var o=t.undef,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],m=Math.PI/2,c={length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*
a[1]+a[2]*a[2]);if(b===0)return[0,0,0];return[a[0]/b,a[1]/b,a[2]/b]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,b){return[a[0]-
b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,e){e===o&&(e=1.0E-7);if(a===o&&b===o)return!0;if(a===o||b===o)return!1;return Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e&&Math.abs(a[2]-b[2])<e},moveViewRelative:function(a,b,e,g,d){var q=Math.sqrt(e*e+g*g),b=Math.atan2(b[2]-a[2],b[0]-a[0])+Math.atan2(g,e)+m;if(typeof d==="object")return[d[0]+q*Math.cos(b),d[1],d[2]+q*Math.sin(b)];return[a[0]+q*Math.cos(b),a[1],a[2]+q*Math.sin(b)]},trackTarget:function(a,b,e,g){var b=c.subtract(b,a),d=c.length(b),q;
q=c.normalize(b);q=c.multiply(q,e*(1/(1/(d-g))));d>g?a=c.add(a,q):d<g?(q=c.normalize(b),q=c.multiply(q,e*(1/(1/Math.abs(d-g)))),a=c.subtract(a,q)):a=[a[0],a[1]+q[2],a[2]];return a},getClosestTo:function(a,b,e){b=c.subtract(b,a);e=c.subtract(e,a);return c.add(c.multiply(b,c.dot(b,e)/c.dot(b,b)),a)},linePlaneIntersect:function(a,b,e,g){var d=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(g[0]-e[0])+a[1]*(g[1]-e[1])+a[2]*(g[2]-e[2]);if(Math.abs(b)<0.0010)return!1;a=-(d+a[0]*e[0]+a[1]*e[1]+a[2]*e[2])/b;return[e[0]+
a*(g[0]-e[0]),e[1]+a*(g[1]-e[1]),e[2]+a*(g[2]-e[2])]}},h={lookat:function(a,b,e,g,d,q,n,v,h){var m=[],r=[],o=[],r=[];m[0]=g-a;m[1]=d-b;m[2]=q-e;o[0]=n;o[1]=v;o[2]=h;m=c.normalize(m);r=c.cross(m,o);r=c.normalize(r);o=c.cross(r,m);r=[r[0],o[0],-m[0],0,r[1],o[1],-m[1],0,r[2],o[2],-m[2],0,0,0,0,1];g=new CubicVR.Transform(r);g.translate([-a,-b,-e]);return g.getResult()},multiply:function(a,b,e){e===o&&(e=[]);e[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];e[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3];e[2]=
a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3];e[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];e[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];e[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];e[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];e[7]=a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];e[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];e[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];e[10]=a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11];e[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11];e[12]=a[0]*b[12]+a[4]*b[13]+a[8]*
b[14]+a[12]*b[15];e[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];e[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];e[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return e},vec4_multiply:function(a,b,e){e===o&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];e[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];return e},vec3_multiply:function(a,b,e){e===o&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+
b[12];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return e},perspective:function(a,b,e,g){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(g+e)/(g-e),-1,0,0,-(2*g*e)/(g-e),0]},ortho:function(a,b,e,g,d,q){return[2/(b-a),0,0,0,0,2/(g-e),0,0,0,0,-2/(q-d),0,-(a+b)/(b-a),-(g+e)/(g-e),-(q+d)/(q-d),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*
a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],e=a[0],g=a[1],d=a[2],q=a[4],n=a[5],c=a[6],h=a[8],m=a[9],a=a[10],r=a*n-c*m,o=-a*q+c*h,s=m*q-n*h,x=e*r+g*o+d*s;if(!x)return null;x=1/x;b[0]=r*x;b[1]=(-a*g+d*m)*x;b[2]=(c*
g-d*n)*x;b[3]=o*x;b[4]=(a*e-d*h)*x;b[5]=(-c*e+d*q)*x;b[6]=s*x;b[7]=(-m*e+g*h)*x;b[8]=(n*e-g*q)*x;return b},inverse:function(a,b){var e=a[0]*a[5]-a[1]*a[4],g=a[0]*a[6]-a[2]*a[4],d=a[0]*a[7]-a[3]*a[4],q=a[1]*a[6]-a[2]*a[5],n=a[1]*a[7]-a[3]*a[5],c=a[2]*a[7]-a[3]*a[6],h=a[8]*a[13]-a[9]*a[12],m=a[8]*a[14]-a[10]*a[12],r=a[8]*a[15]-a[11]*a[12],E=a[9]*a[14]-a[10]*a[13],s=a[9]*a[15]-a[11]*a[13],x=a[10]*a[15]-a[11]*a[14],A=e*x-g*s+d*E+q*r-n*m+c*h;if(A!==0)return b===o&&(b=[]),b[0]=0+a[5]*x-a[6]*s+a[7]*E,b[4]=
0-a[4]*x+a[6]*r-a[7]*m,b[8]=0+a[4]*s-a[5]*r+a[7]*h,b[12]=0-a[4]*E+a[5]*m-a[6]*h,b[1]=0-a[1]*x+a[2]*s-a[3]*E,b[5]=0+a[0]*x-a[2]*r+a[3]*m,b[9]=0-a[0]*s+a[1]*r-a[3]*h,b[13]=0+a[0]*E-a[1]*m+a[2]*h,b[2]=0+a[13]*c-a[14]*n+a[15]*q,b[6]=0-a[12]*c+a[14]*d-a[15]*g,b[10]=0+a[12]*n-a[13]*d+a[15]*e,b[14]=0-a[12]*q+a[13]*g-a[14]*e,b[3]=0-a[9]*c+a[10]*n-a[11]*q,b[7]=0+a[8]*c-a[10]*d+a[11]*g,b[11]=0-a[8]*n+a[9]*d-a[11]*e,b[15]=0+a[8]*q-a[9]*g+a[10]*e,e=1/A,b[0]*=e,b[1]*=e,b[2]*=e,b[3]*=e,b[4]*=e,b[5]*=e,b[6]*=e,
b[7]*=e,b[8]*=e,b[9]*=e,b[10]*=e,b[11]*=e,b[12]*=e,b[13]*=e,b[14]*=e,b[15]*=e,b;return null},identity:function(a){if(a==o)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,b,e,g){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,e,1];if(g===o)return a;h.multiply(g.slice(0),a,g)},rotateAxis:function(a,b,e,g,d){var q=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),b=[a+b*b*(1-a),b*e*
(1-a)-g*q,b*g*(1-a)+e*q,0,e*b*(1-a)+g*q,a+e*e*(1-a),e*g*(1-a)-b*q,0,g*b*(1-a)-e*q,g*e*(1-a)+b*q,a+g*g*(1-a),0,0,0,0,1];if(d===o)return b;h.multiply(d.slice(0),b,d)},rotate:function(a,b,e,g){var d;g===o&&(g=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);e!==0&&(d=Math.sin(e*(Math.PI/180)),e=Math.cos(e*(Math.PI/180)),h.multiply(g.slice(0),[e,d,0,0,-d,e,0,0,0,0,1,0,0,0,0,1],g));b!==0&&(d=Math.sin(b*(Math.PI/180)),e=Math.cos(b*(Math.PI/180)),h.multiply(g.slice(0),[e,0,-d,0,0,1,0,0,d,0,e,0,0,0,0,1],g));a!==0&&(d=
Math.sin(a*(Math.PI/180)),e=Math.cos(a*(Math.PI/180)),h.multiply(g.slice(0),[1,0,0,0,0,e,d,0,0,-d,e,0,0,0,0,1],g));return g},scale:function(a,b,e,g){if(g===o)return[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1];h.multiply(g.slice(0),[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1],g)}};y.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=
0;this.result=null;return this},getResult:function(){var a=CubicVR.mat4;if(!this.c_stack)return this.m_stack[0];var b=r;if(this.valid>this.c_stack-1)this.valid=this.c_stack-1;for(var e=this.valid;e<this.c_stack+1;e++)b=a.multiply(b,this.m_stack[e]),this.m_cache[e]=b;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:r;return this},popMatrix:function(){if(this.c_stack!==0)return this.c_stack--,this},clearStack:function(a){this.m_stack=
[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==o?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,e){var g=CubicVR.mat4;if(typeof a==="object")return this.translate(a[0],a[1],a[2]);var d=this.getIdentity();d[12]=a;d[13]=b;d[14]=e;this.m_stack[this.c_stack]=g.multiply(this.m_stack[this.c_stack],d);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,e){var g=CubicVR.mat4;if(typeof a==="object")return this.scale(a[0],a[1],a[2]);
var d=this.getIdentity();d[0]=a;d[5]=b;d[10]=e;this.m_stack[this.c_stack]=g.multiply(this.m_stack[this.c_stack],d);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,b,e,g){var d=CubicVR.mat4;if(typeof a==="object")return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var q,n;if(b||e||g)q=Math.sin(-a*(Math.PI/180)),n=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=n*b,a[9]=q*b,a[6]=-q*b,a[10]=n*b,this.m_stack[this.c_stack]=d.multiply(a,
this.m_stack[this.c_stack]));e&&(b=this.getIdentity(),b[0]=n*e,b[8]=-q*e,b[2]=q*e,b[10]=n*e,this.m_stack[this.c_stack]=d.multiply(b,this.m_stack[this.c_stack]));g&&(e=this.getIdentity(),e[0]=n*g,e[4]=q*g,e[1]=-q*g,e[5]=n*g,this.m_stack[this.c_stack]=d.multiply(e,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};s.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());
this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromEuler:function(a,b,e){var g=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),d=Math.cos(Math.PI/180*e/2),e=Math.sin(Math.PI/180*e/2),q=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),n=g*d,c=b*e;this.w=n*q-c*a;this.x=n*a+c*q;this.y=b*d*q+g*e*a;this.z=g*e*q-b*d*a},toEuler:function(){var a=this.w*this.w,b=this.x*this.x,e=this.y*this.y,g=this.z*this.z;return[180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-e+g+a),180/Math.PI*Math.asin(-2*
(this.x*this.z-this.y*this.w)),180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-e-g+a)]},multiply:function(a,b){b===o&&(b=a,a=this);return new s(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};return{vec2:{equal:function(a,b,e){e===o&&(e=1.0E-8);if(a===o&&b===o)return!0;if(a===o||b===o)return!1;return Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e}},vec3:c,mat3:{transpose_inline:function(a){var b=a[1],e=a[2],
g=a[5];a[1]=a[3];a[2]=a[6];a[3]=b;a[5]=a[7];a[6]=e;a[7]=g},vec3_multiply:function(a,b,e){e===o&&(e=[]);e[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];e[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];e[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return e}},mat4:h,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>b[2]&&(a[0][2]=b[2]);a[1][0]<b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){b===void 0&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=
b[2];a[1][0]=b[0];a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,b){var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];if(e<0)return-1;else if(e>0)return 1;return 0},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}},sphere:{intersects:function(a,b){var e=CubicVR.vec3.subtract([a[0],
a[1],a[2]],[b[0],b[1],b[2]]),e=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),g=a[3]+b[3];if(e*e<g*g)return!0;return!1}},triangle:{normal:function(a,b,e,g){g===o&&(g=[]);var d=a[0]-b[0],q=a[1]-b[1],a=a[2]-b[2],n=b[0]-e[0],c=b[1]-e[1],b=b[2]-e[2];g[0]=q*b-a*c;g[1]=a*n-d*b;g[2]=d*c-q*n;return g}},Transform:y,Quaternion:s}});CubicVR.RegisterModule("Mesh",function(t){function y(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function s(m){this.points=[];this.faces=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.bb=this.originBuffer=this.compiled=null;this.name=m?m:null;this.materials=[];this.morphTarget=this.morphTargets=this.bb=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1}var o=t.undef,r=t.GLCore;
y.prototype={setUV:function(m,c){c!==o?this.uvs[c]=m:m.length!==2?this.uvs=m:this.uvs.push(m)},setColor:function(m,c){c!==o?this.point_colors[c]=m:typeof colors[0]!=="number"?this.point_colors=m:this.point_colors.push(m)},flip:function(){for(var m=0,c=this.point_normals.length;m<c;m++)this.point_normals[m]=[-this.point_normals[m][0],-this.point_normals[m][1],-this.point_normals[m][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],
-this.normal[2]]}};s.prototype={showAllSegments:function(){for(var m in this.segment_state)this.segment_state.hasOwnProperty(m)&&(this.segment_state[m]=!0)},hideAllSegments:function(){for(var m in this.segment_state)this.segment_state.hasOwnProperty(m)&&(this.segment_state[m]=!1)},setSegment:function(m,c){c!==o?this.segment_state[m]=c:this.currentSegment=m},addPoint:function(m){if(m.length!==3||typeof m[0]==="object")for(var c=0,h=m.length;c<h;c++)this.points.push(m[c]);else this.points.push(m);return this.points.length-
1},getMaterialIndex:function(m){return this.materials.indexOf(m)},setFaceMaterial:function(m,c){typeof m=="number"?mat_id=m:(mat_id=this.materials.indexOf(m),mat_id===-1&&(this.materials.push(m),mat_id=this.materials.length-1));if(c!==o){if(this.faces[c]!==o)this.faces[c].material=mat_id}else this.currentMaterial=mat_id;return this},addFace:function(m,c,h,a){if(typeof m[0]!=="number"){c=0;for(h=m.length;c<h;c++)this.addFace(m[c])}else{c===o?(this.currentFace=this.faces.length,this.faces.push(new y)):
(this.faces[c]===o&&(this.faces[c]=new y),this.currentFace=c);if(typeof m==="object")this.faces[this.currentFace].points=m;h!==o?this.setFaceMaterial(h,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial;this.faces[this.currentFace].segment=a!==o?a:this.currentSegment;return this.currentFace}},flipFaces:function(){for(var m=0,c=this.faces.length;m<c;m++)this.faces[m].flip()},triangulateQuads:function(){for(var m=0,c=this.faces.length;m<c;m++)if(this.faces[m].points.length===
4){var h=this.faces.length;this.addFace([this.faces[m].points[2],this.faces[m].points[3],this.faces[m].points[0]],this.faces.length,this.faces[m].material,this.faces[m].segment);this.faces[m].points.pop();this.faces[h].normal=this.faces[m].normal;this.faces[m].uvs!==o&&this.faces[m].uvs.length===4&&(this.faces[h].setUV(this.faces[m].uvs[2],0),this.faces[h].setUV(this.faces[m].uvs[3],1),this.faces[h].setUV(this.faces[m].uvs[0],2),this.faces[m].uvs.pop());this.faces[m].point_normals.length===4&&(this.faces[h].point_normals[0]=
this.faces[m].point_normals[2],this.faces[h].point_normals[1]=this.faces[m].point_normals[3],this.faces[h].point_normals[2]=this.faces[m].point_normals[0],this.faces[m].point_normals.pop())}return this},booleanAdd:function(m,c){var h=CubicVR.mat4,a=this.points.length,b,e,g,d;if(c!==o){e=c.getResult();b=0;for(g=m.points.length;b<g;b++)this.addPoint(h.vec3_multiply(m.points[b],e))}else{b=0;for(g=m.points.length;b<g;b++)this.addPoint([m.points[b][0],m.points[b][1],m.points[b][2]])}h=[];b=0;for(g=m.materials.length;b<
g;b++)e=this.materials.indexOf(m.materials[b]),e===-1?(this.materials.push(m.materials[b]),h[b]=this.materials.length-1):h[b]=e;b=0;for(g=m.faces.length;b<g;b++){var q=[];e=0;for(d=m.faces[b].points.length;e<d;e++)q.push(m.faces[b].points[e]+a);q=this.faces[this.addFace(q)];q.segment=m.faces[b].segment;q.material=h[m.faces[b].material];if(q.material===o)q.material=0;e=0;for(d=m.faces[b].uvs.length;e<d;e++)q.uvs[e]=[m.faces[b].uvs[e][0],m.faces[b].uvs[e][1]];e=0;for(d=m.faces[b].point_normals.length;e<
d;e++)q.point_normals[e]=[m.faces[b].point_normals[e][0],m.faces[b].point_normals[e][1],m.faces[b].point_normals[e][2]]}return this},calcFaceNormals:function(m,c){var h=CubicVR.vec3,a=CubicVR.triangle,b=0,e=this.faces.length;m&&(b=m);for(c&&(e=c+1);b<e;b++)this.faces[b].normal=this.faces[b].points.length<3?[0,0,0]:h.normalize(a.normal(this.points[this.faces[b].points[0]],this.points[this.faces[b].points[1]],this.points[this.faces[b].points[2]]));return this},getMaterial:function(m){for(var c=0,h=
this.materials.length;c<h;c++)if(this.materials[c].name===m)return this.materials[c];return null},calcNormals:function(m){var c=CubicVR.vec3,h=!1;m!==o&&(h=!0);this.calcFaceNormals();var a,b,e,g,d=Array(this.points.length);a=0;for(g=d.length;a<g;a++)d[a]=[];e=this.faces.length;for(a=0;a<e;a++){g=this.faces[a].points.length;for(b=0;b<g;b++)d[this.faces[a].points[b]].push([a,b])}a=0;for(g=this.points.length;a<g;a++){var q=d[a].length;for(b=0;b<q;b++){var n=1,v=d[a][b][0],C=d[a][b][1],w=this.materials.length?
this.materials[this.faces[v].material].max_smooth:60,r=this.faces[v];h&&(m[v]===o&&(m[v]=[]),m[v][C]===o&&(m[v][C]=[]));var s=Array(3);s[0]=r.normal[0];s[1]=r.normal[1];s[2]=r.normal[2];if(w!==0)for(e=0;e<q;e++)if(b!==e){var B=d[a][e][0],x=this.faces[B],A=c.angle(x.normal,r.normal);if(A!==A||A*(180/Math.PI)<=w)h&&m[v][C].push(B),s[0]+=x.normal[0],s[1]+=x.normal[1],s[2]+=x.normal[2],n++}s[0]/=n;s[1]/=n;s[2]/=n;this.faces[v].point_normals[C]=c.normalize(s)}}return this},recalcNormals:function(m){this.calcFaceNormals();
for(var c=0,h=this.faces.length;c<h;c++)for(var a=this.faces[c],b=0,e=a.points.length;b<e;b++){var g=m[c][b],d=a.point_normals[b];d[0]=a.normal[0];d[1]=a.normal[1];d[2]=a.normal[2];for(var q=g.length,n=0;n<q;n++){var v=this.faces[g[n]];d[0]+=v.normal[0];d[1]+=v.normal[1];d[2]+=v.normal[2]}q!==0&&(d[0]/=q+1,d[1]/=q+1,d[2]/=q+1,g=Math.sqrt(d[0]*d[0]+d[1]*d[1]+d[2]*d[2]),d[0]/=g,d[1]/=g,d[2]/=g)}return this},removeDoubles:function(){var m=[],c=[],h,a,b,e;h=0;for(a=this.points.length;h<a;h++){var g=-1,
d=this.points[h];b=0;for(e=m.length;b<e;b++)if(CubicVR.vec3.equal(d,m[b])){g=b;break}g!=-1?c[h]=g:(c[h]=m.length,m.push(this.points[h]))}this.points=m;h=0;for(a=this.faces.length;h<a;h++){m=this.faces[h];b=0;for(e=m.points.length;b<e;b++)m.points[b]=c[m.points[b]]}},prepare:function(m){m===o&&(m=!0);this.calcNormals().triangulateQuads().compile();m&&this.clean();return this},clean:function(){var m,c;m=0;for(c=this.points.length;m<c;m++)delete this.points[m],this.points[m]=null;this.points=[];m=0;
for(c=this.faces.length;m<c;m++)delete this.faces[m].points,delete this.faces[m].point_normals,delete this.faces[m].uvs,delete this.faces[m].normal,delete this.faces[m],this.faces[m]=null;this.faces=[];return this},compileMap:function(m){var c=CubicVR.vec3,h=CubicVR.vec2;m===o&&(m=1.0E-5);var a={segments:[],bounds:[]},b=[],e,g,d,q,n,v,r,w;this.materials.length||this.materials.push(new CubicVR.Material);e=0;for(v=this.materials.length;e<v;e++)b[e]=[];e=0;for(v=this.faces.length;e<v;e++)if(this.faces[e].points.length===
3)d=this.faces[e].material,q=this.faces[e].segment,b[d][q]===o&&(b[d][q]=[],a.segments.push(q)),b[d][q].push(e);var s=[],E=0,B=!1,x=!1,A=!1,z;e=0;for(v=b.length;e<v;e++)for(g in b[e])if(b[e].hasOwnProperty(g))for(d=0;d<b[e][g].length;d++)z=b[e][g][d],B=B||this.faces[z].uvs.length!==0,x=x||this.faces[z].point_normals.length!==0,A=A||this.faces[z].point_colors.length!==0;if(B)for(e=0;e<this.faces.length;e++)if(!this.faces[e].uvs.length)for(g=0;g<this.faces[e].points.length;g++)this.faces[e].uvs.push([0,
0]);if(x)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_normals.length)for(g=0;g<this.faces[e].points.length;g++)this.faces[e].point_normals.push([0,0,0]);if(A)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_colors.length)for(g=0;g<this.faces[e].points.length;g++)this.faces[e].point_colors.push([0,0,0]);e=0;for(v=b.length;e<v;e++)for(g in b[e])if(b[e].hasOwnProperty(g)){d=0;for(r=b[e][g].length;d<r;d++){z=b[e][g][d];for(q=0;q<3;q++){var u=this.faces[z].points[q],t=-1;if(s[u]!==o){n=
0;for(w=s[u].length;n<w;n++){var D=s[u][n][0],y=s[u][n][1],t=s[u][n][2];x&&(t=c.equal(this.faces[D].point_normals[y],this.faces[z].point_normals[q],m)?t:-1);B&&(t=h.equal(this.faces[D].uvs[y],this.faces[z].uvs[q],m)?t:-1);A&&(t=c.equal(this.faces[D].point_colors[y],this.faces[z].point_colors[q],m)?t:-1)}}if(t!==-1){if(a.elements===o)a.elements=[];a.elements[e]===o&&(a.elements[e]=[]);a.elements[e][g]===o&&(a.elements[e][g]=[]);a.elements[e][g].push(t)}else{if(a.points===o)a.points=[];a.points.push(u);
a.bounds.length===0?(a.bounds[0]=[this.points[u][0],this.points[u][1],this.points[u][2]],a.bounds[1]=[this.points[u][0],this.points[u][1],this.points[u][2]]):(this.points[u][0]<a.bounds[0][0]&&(a.bounds[0][0]=this.points[u][0]),this.points[u][1]<a.bounds[0][1]&&(a.bounds[0][1]=this.points[u][1]),this.points[u][2]<a.bounds[0][2]&&(a.bounds[0][2]=this.points[u][2]),this.points[u][0]>a.bounds[1][0]&&(a.bounds[1][0]=this.points[u][0]),this.points[u][1]>a.bounds[1][1]&&(a.bounds[1][1]=this.points[u][1]),
this.points[u][2]>a.bounds[1][2]&&(a.bounds[1][2]=this.points[u][2]));if(x){if(a.normals===o)a.normals=[];a.normals.push([z,q])}if(A){if(a.colors===o)a.colors=[];a.colors.push([z,q])}if(B){if(a.uvs===o)a.uvs=[];a.uvs.push([z,q])}if(a.elements===o)a.elements=[];a.elements[e]===o&&(a.elements[e]=[]);a.elements[e][g]===o&&(a.elements[e][g]=[]);a.elements[e][g].push(E);s[u]===o&&(s[u]=[]);s[u].push([z,q,E]);E++}}}}return a},compileVBO:function(m,c,h,a,b,e){typeof c=="object"?(c=c.element!==o?c.element:
!0,h=c.vertex!==o?c.vertex:!0,e=c.color!==o?c.color:!0,a=c.normal!==o?c.normal:!0,b=c.uv!==o?c.uv:!0):(c===o&&(c=!0),h===o&&(h=!0),e===o&&(e=!0),a===o&&(a=!0),b===o&&(b=!0));var g={},d,q,n;if(m.points&&h){d=m.points.length;g.vbo_points=new Float32Array(d*3);for(h=q=0;h<d;h++)n=m.points[h],g.vbo_points[q++]=this.points[n][0],g.vbo_points[q++]=this.points[n][1],g.vbo_points[q++]=this.points[n][2]}if(m.normals&&a){d=m.normals.length;g.vbo_normals=new Float32Array(d*3);for(h=q=0;h<d;h++)n=m.normals[h],
g.vbo_normals[q++]=this.faces[n[0]].point_normals[n[1]][0],g.vbo_normals[q++]=this.faces[n[0]].point_normals[n[1]][1],g.vbo_normals[q++]=this.faces[n[0]].point_normals[n[1]][2]}if(m.colors&&e){d=m.colors.length;g.vbo_colors=new Float32Array(d*3);for(h=q=0;h<d;h++)n=m.colors[h],g.vbo_colors[q++]=this.faces[n[0]].point_colors[n[1]][0],g.vbo_colors[q++]=this.faces[n[0]].point_colors[n[1]][1],g.vbo_colors[q++]=this.faces[n[0]].point_colors[n[1]][2]}if(m.uvs&&b){d=m.uvs.length;g.vbo_uvs=new Float32Array(d*
2);for(h=q=0;h<d;h++)n=m.uvs[h],g.vbo_uvs[q++]=this.faces[n[0]].uvs[n[1]][0],g.vbo_uvs[q++]=this.faces[n[0]].uvs[n[1]][1]}if(c){g.elements_ref=[];g.vbo_elements=[];h=0;for(d=m.elements.length;h<d;h++){g.elements_ref[h]=[];var c=0,v;for(v in m.elements[h])if(m.elements[h].hasOwnProperty(v)){a=m.elements[h][v];k=0;for(kMax=a.length;k<kMax;k++)g.vbo_elements.push(a[k]);g.elements_ref[h][c]=[v|0,a.length|0];c++}}g.vbo_elements=new Uint16Array(g.vbo_elements)}g.segments=m.segments;g.bounds=m.bounds;return g},
bufferVBO:function(m,c){var h=r.gl,a={};c===o&&(c={});a.gl_points=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,a.gl_points);h.bufferData(h.ARRAY_BUFFER,m.vbo_points,h.STATIC_DRAW);m.vbo_normals?(a.gl_normals=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,a.gl_normals),h.bufferData(h.ARRAY_BUFFER,m.vbo_normals,h.STATIC_DRAW)):a.gl_normals=c.gl_normals?c.gl_normals:null;m.vbo_uvs?(a.gl_uvs=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,a.gl_uvs),h.bufferData(h.ARRAY_BUFFER,m.vbo_uvs,h.STATIC_DRAW)):a.gl_uvs=
c.gl_uvs?c.gl_uvs:null;m.vbo_colors?(a.gl_colors=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,a.gl_colors),h.bufferData(h.ARRAY_BUFFER,m.vbo_colors,h.STATIC_DRAW)):a.gl_colors=c.gl_colors?c.gl_colors:null;!m.vbo_elements&&c.gl_elements?(a.gl_elements=c.gl_elements,a.elements_ref=c.elements_ref):(a.gl_elements=h.createBuffer(),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,a.gl_elements),h.bufferData(h.ELEMENT_ARRAY_BUFFER,m.vbo_elements,h.STATIC_DRAW),a.elements_ref=m.elements_ref);a.segments=m.segments;a.bounds=
m.bounds;c.elements_ref&&!m.elements_ref&&h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);return a},bindBuffer:function(m){if(this.originBuffer===null)this.originBuffer=m;this.compiled=m;this.segment_state=[];for(var c=0,h=m.segments.length;c<h;c++)this.segment_state[m.segments[c]]=!0;this.bb=m.bounds},compile:function(m){this.bindBuffer(this.bufferVBO(this.compileVBO(this.compileMap(m))));return this},addMorphTarget:function(m){if(this.morphTargets===null)this.morphTargets=[];this.morphTargets.push(m)},
setMorphSource:function(m){if(this.morphSourceIndex!==m)this.morphSourceIndex=m,this.bindBuffer(this.morphTargets[m])},setMorphTarget:function(m){if(this.morphTargetIndex!==m)this.morphTargetIndex=m,this.morphTarget=this.morphTargets[m]},setMorphWeight:function(m){this.morphWeight=m},morphTargetCount:function(){return this.morphTargets!==null?this.morphTargets.length:0}};return{Mesh:s,Face:y}});CubicVR.RegisterModule("Motion",function(t){function y(){this.time=this.value=0;this.shape=m.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function s(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=a.in_behavior?a.in_behavior:m.envelope.behavior.CONSTANT,this.out_behavior=a.out_behavior?a.out_behavior:m.envelope.behavior.CONSTANT):this.out_behavior=this.in_behavior=m.envelope.behavior.CONSTANT}function o(a,d){this.env_init=
a;this.key_init=d;this.controllers=[];this.yzflip=!1}var r=t.undef,m=CubicVR.enums;m.motion={POS:0,ROT:1,SCL:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};m.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var c=function(a,d,b){var n=0,n=b-d;if(n===0)return[d,0];d=a-n*Math.floor((a-d)/n);n=-parseInt((d-a)/n+(d>a?0.5:-0.5),10);return[d,n]},h=function(a,d,b,n,e){var c,h;h=e*e;c=3*(d-a);d=3*(b-d)-c;return(n-
a-c-d)*h*e+d*h+c*e+a},a=function(b,d,q,n,e,c,m){var r,o;o=c+(m-c)*0.5;r=h(b,d,q,n,o);return Math.abs(e-r)>1.0E-4?(r>e?m=o:c=o,a(b,d,q,n,e,c,m)):o},b=function(a,d){var b,n,e,c;a.shape===m.envelope.shape.TCB?(b=(1-a.tension)*(1+a.continuity)*(1+a.bias),n=(1-a.tension)*(1-a.continuity)*(1-a.bias),e=d.value-a.value,a.prev?(c=(d.time-a.time)/(d.time-a.prev.time),b=c*(b*(a.value-a.prev.value)+n*e)):b=n*e):a.shape===m.envelope.shape.LINE?(e=d.value-a.value,a.prev?(c=(d.time-a.time)/(d.time-a.prev.time),
b=c*(a.value-a.prev.value+e)):b=e):a.shape===m.envelope.shape.BEZI||a.shape===m.envelope.shape.HERM?(b=a.param[1],a.prev&&(b*=(d.time-a.time)/(d.time-a.prev.time))):a.shape===m.envelope.shape.BEZ2?(b=a.param[3]*(d.time-a.time),Math.abs(a.param[2])>1.0E-5?b/=a.param[2]:b*=1E5):b=0;return b},e=function(a,d){var b,n,e,c;d.shape===m.envelope.shape.LINE?(e=d.value-a.value,d.next?(c=(d.time-a.time)/(d.next.time-a.time),b=c*(d.next.value-d.value+e)):b=e):d.shape===m.envelope.shape.TCB?(b=(1-d.tension)*(1-
d.continuity)*(1+d.bias),n=(1-d.tension)*(1+d.continuity)*(1-d.bias),e=d.value-a.value,d.next?(c=(d.time-a.time)/(d.next.time-a.time),b=c*(n*(d.next.value-d.value)+b*e)):b*=e):d.shape===m.envelope.shape.HERM||d.shape===m.envelope.shape.BEZI?(b=d.param[0],d.next&&(b*=(d.time-a.time)/(d.next.time-a.time))):d.shape===m.envelope.shape.BEZ2?(b=d.param[1]*(d.time-a.time),Math.abs(d.param[0])>1.0E-5?b/=d.param[0]:b*=1E5):b=0;return b};s.prototype={setBehavior:function(a,d){this.in_behavior=a;this.out_behavior=
d},empty:function(){return this.nKeys===0},addKey:function(a,d,b){var n=typeof a=="object"?a:b;d||(d=0);a||(a=0);n?(n=a,a=n.time,b=this.insertKey(a),b.value=n.value?n.value:d,b.time=n.time?n.time:a,b.shape=n.shape?n.shape:m.envelope.shape.TCB,b.tension=n.tension?n.tension:0,b.continuity=n.continuity?n.continuity:0,b.bias=n.bias?n.bias:0,b.param=n.param?n.param:[0,0,0,0]):(b=this.insertKey(a),b.value=d);return b},insertKey:function(a){var d=new y;d.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=
this.keys=d,this.nKeys++,d;for(var b=this.keys;b;){if(this.firstKey.time>a)this.firstKey=d;else if(this.lastKey.time<a)this.lastKey=d;if(b.time>d.time){d.prev=b.prev;if(d.prev)d.prev.next=d;d.next=b;d.next.prev=d;this.nKeys++;return d}else if(!b.next)return d.prev=b,b.next=d,this.nKeys++,d;b=b.next}return null},evaluate:function(g){var d,q,n,v,r,w=0;if(this.nKeys===0)return 0;if(this.nKeys===1)return this.keys.value;q=this.firstKey;d=this.lastKey;if(g<q.time)if(v=this.in_behavior,v===m.envelope.behavior.RESET)return 0;
else if(v===m.envelope.behavior.CONSTANT)return q.value;else if(v===m.envelope.behavior.REPEAT)v=c(g,q.time,d.time),g=v[0];else if(v===m.envelope.behavior.OCILLATE)v=c(g,q.time,d.time),g=v[0],v=v[1],v%2&&(g=d.time-q.time-g);else if(v===m.envelope.behavior.OFFSET)v=c(g,q.time,d.time),g=v[0],v=v[1],w=v*(d.value-q.value);else{if(v===m.envelope.behavior.LINEAR)return r=b(q,q.next)/(q.next.time-q.time),r*(g-q.time)+q.value}else if(g>d.time)if(v=this.out_behavior,v===m.envelope.behavior.RESET)return 0;
else if(v===m.envelope.behavior.CONSTANT)return d.value;else if(v===m.envelope.behavior.REPEAT)v=c(g,q.time,d.time),g=v[0];else if(v===m.envelope.behavior.OCILLATE)v=c(g,q.time,d.time),g=v[0],v=v[1],v%2&&(g=d.time-q.time-g);else if(v===m.envelope.behavior.OFFSET)v=c(g,q.time,d.time),g=v[0],v=v[1],w=v*(d.value-q.value);else if(v===m.envelope.behavior.LINEAR)return v=e(d.prev,d)/(d.time-d.prev.time),v*(g-d.time)+d.value;if(this.lastKey0)if(g>this.lastKey0.time)d=this.lastKey0;else if(g<this.lastKey0.time)for(d=
this.lastKey;g<d.time&&d.prev;)d=d.prev;else d=this.keys;else d=this.keys;for(;g>d.next.time;)d=d.next;q=d.next;this.lastKey0=d;if(g===d.time)return d.value+w;else if(g===q.time)return q.value+w;n=(g-d.time)/(q.time-d.time);v=q.shape;if(v===m.envelope.shape.TCB||v===m.envelope.shape.BEZI||v===m.envelope.shape.HERM){r=b(d,q);v=e(d,q);var o,s;s=n*n;o=n*s;g=3*s-o-o;o-=s;g=[1-g,g,o-s+n,o];return g[0]*d.value+g[1]*q.value+g[2]*r+g[3]*v+w}else return v===m.envelope.shape.BEZ2?(g=a(d.time,d.shape===m.envelope.shape.BEZ2?
d.time+d.param[2]:d.time+(q.time-d.time)/3,q.time+q.param[0],q.time,g,0,1),w=h(d.value,d.shape===m.envelope.shape.BEZ2?d.value+d.param[3]:d.value+d.param[1]/3,q.param[1]+q.value,q.value,g)+w):w=v===m.envelope.shape.LINE?d.value+n*(q.value-d.value)+w:v===m.envelope.shape.STEP?d.value+w:w,w}};o.prototype={envelope:function(a,d){this.controllers[a]===r&&(this.controllers[a]=[]);this.controllers[a][d]===r&&(this.controllers[a][d]=new s(this.env_init));return this.controllers[a][d]},evaluate:function(a){var d=
[],b;for(b in this.controllers)if(this.controllers.hasOwnProperty(b)){d[b]=[];for(var n in this.controllers[b])this.controllers[b].hasOwnProperty(n)&&(d[b][n]=this.controllers[b][n].evaluate(a))}return d},apply:function(a,d){for(var b in this.controllers)if(this.controllers.hasOwnProperty(b)){var n=parseInt(b,10);if(this.yzflip&&n===m.motion.ROT){if(!this.q)this.q=new CubicVR.Quaternion;var e=this.q,c=this.controllers[b][0].evaluate(a),h=this.controllers[b][1].evaluate(a),r=this.controllers[b][2].evaluate(a);
e.fromEuler(c,r,-h);e=e.toEuler();d.control(n,0,e[0]);d.control(n,1,e[1]);d.control(n,2,e[2])}else for(var o in this.controllers[b])this.controllers[b].hasOwnProperty(o)&&d.control(n,parseInt(o,10),this.controllers[b][o].evaluate(a))}},setKey:function(a,b,q,n,e){return this.envelope(a,b).addKey(q,n,e?e:this.key_init)},setArray:function(a,b,q,n){var e=[],c;for(c in q)if(q.hasOwnProperty(c)){var h=this.envelope(a,c);e[c]=h.addKey(b,q[c],n?n:this.key_init)}return e},setBehavior:function(a,b,q,n){this.envelope(a,
b).setBehavior(q,n)},setBehaviorArray:function(a,b,q){for(var n in this.controllers[a])this.controllers[a].hasOwnProperty(n)&&this.envelope(a,n).setBehavior(b,q)}};return{Motion:o,Envelope:s,EnvelopeKey:y}});CubicVR.RegisterModule("Octree",function(t){function y(a,b,e,g,d){var q=this._children=[];this._dirty=!1;q[0]=null;q[1]=null;q[2]=null;q[3]=null;q[4]=null;q[5]=null;q[6]=null;q[7]=null;this._child_index=d||-1;this._root=e||null;this._max_depth=b||0;a=this._size=a||0;g=this._position=g||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[g[0],g[1],g[2],Math.sqrt(3*(this._size/2*this._size/2))];b=this._bbox=[[0,0,0],[0,0,0]];e=CubicVR.aabb;e.reset(b,g);a/=2;e.engulf(b,[g[0]+
a,g[1]+a,g[2]+a]);e.engulf(b,[g[0]-a,g[1]-a,g[2]-a]);this._debug_visible=!1}function s(){this.position=[0,0,0];this.visible=!1;this._object=null}function o(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;a<6;++a)this._planes[a]=[0,0,0,0]}var r=t.undef,m=CubicVR.plane,c=CubicVR.sphere,h=CubicVR.enums;h.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};h.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};Array_remove=function(a,b,e){e=
a.slice((e||b)+1||a.length);a.length=b<0?a.length+b:b;return a.push.apply(a,e)};y.prototype.destroy=function(){var a,b,e;a=0;for(b=this._static_lights.length;a<b;++a)e=this._static_lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;a=0;for(b=this._lights.length;a<b;++a)e=this._lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(b=this._children.length;a<b;++a)this._children[a]!==null&&this._children[a].destroy();
a=0;for(b=this._nodes.length;a<b;++a)e=this._nodes[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null,e.dynamic_lights=[],e.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};y.prototype.toString=function(){return"[Octree: @"+
this._position+", depth: "+this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};y.prototype.remove=function(a){var b=!1,e=this._nodes.length,g;g=e-1;for(e=this._nodes.length;g>=0;--g)if(a===this._nodes[g]){Array_remove(this._nodes,g);this.dirty_lineage();b=!0;break}if(!b)for(g=e-1;g>=0;--g)if(a===this._lights[g]){Array_remove(this._lights,g);this.dirty_lineage();break}};y.prototype.dirty_lineage=
function(){this._dirty=!0;this._root!==null&&this._root.dirty_lineage()};y.prototype.cleanup=function(){for(var a=this._children.length,b=0,e=0;e<a;++e){var g=this._children[e];if(g!==null){var d=!0;g._dirty===!0&&(d=g.cleanup());d?++b:this._children[e]=null}}if(this._nodes.length===0&&this._static_lights.length===0&&this._lights.length===0&&(b===0||a===0))return!1;return!0};y.prototype.insert_light=function(a){this.insert(a,!0)};y.prototype.propagate_static_light=function(a){var b,e;b=0;for(e=this._nodes.length;b<
e;++b)this._nodes[b].static_lights.indexOf(a)===-1&&this._nodes[b].static_lights.push(a);for(b=0;b<8;++b)this._children[b]!==null&&this._children[b].propagate_static_light(a)};y.prototype.collect_static_lights=function(a){var b,e;b=0;for(e=this._static_lights.length;b<e;++b)a.static_lights.indexOf(this._static_lights[b])===-1&&a.static_lights.push(this._static_lights[b]);for(b=0;b<8;++b)this._children[b]!==null&&this._children[b].collect_static_lights(a)};y.prototype.insert=function(a,b){function e(a,
b,d,g){var q,n;if(d)if(b.method===h.light.method.STATIC){a._static_lights.indexOf(b)===-1&&a._static_lights.push(b);d=0;for(q=a._nodes.length;d<q;++d)a._nodes[d].static_lights.indexOf(b)===-1&&a._nodes[d].static_lights.push(b);for(n=a._root;n!==null;){d=0;for(l=n._nodes.length;d<l;++d)q=n._nodes[d],q.static_lights.indexOf(b)===-1&&q.static_lights.push(b);n=n._root}}else a._lights.indexOf(b)===-1&&a._lights.push(b);else{a._nodes.push(b);d=0;for(q=a._static_lights.length;d<q;++d)b.static_lights.indexOf(a._static_lights[d])===
-1&&b.static_lights.push(a._static_lights[d]);for(n=a._root;n!==null;){d=0;for(q=n._static_lights.length;d<q;++d){var e=n._static_lights[d];b.static_lights.indexOf(e)===-1&&b.static_lights.push(e)}n=n._root}}b.octree_leaves.push(a);b.octree_common_root=g;g=CubicVR.aabb;g.engulf(b.octree_aabb,a._bbox[0]);g.engulf(b.octree_aabb,a._bbox[1])}b===r&&(b=!1);if(this._root===null)a.octree_leaves=[],a.octree_common_root=null;if(this._max_depth===0)e(this,a,b,this._root);else{var g=this._position,d,q,n,c,m,
w,o;q=a.getAABB();o=[q[0][0],q[0][1],q[0][2]];var s=[q[1][0],q[1][1],q[1][2]];d=o[0]<g[0]&&o[1]<g[1]&&o[2]<g[2];q=s[0]>g[0]&&o[1]<g[1]&&o[2]<g[2];m=o[0]<g[0]&&s[1]>g[1]&&o[2]<g[2];w=s[0]>g[0]&&s[1]>g[1]&&o[2]<g[2];n=o[0]<g[0]&&o[1]<g[1]&&s[2]>g[2];c=s[0]>g[0]&&o[1]<g[1]&&s[2]>g[2];o=o[0]<g[0]&&s[1]>g[1]&&s[2]>g[2];g=s[0]>g[0]&&s[1]>g[1]&&s[2]>g[2];if(d&&q&&m&&w&&n&&c&&o&&g)e(this,a,b,this),b?a.method==h.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var s=
0,B=this._static_lights.length;s<B;++s){if(a.static_lights===r)a.static_lights=[];a.static_lights.indexOf(this._static_lights[s])===-1&&a.static_lights.push(this._static_lights[s])}var s=this._size/2,B=this._size/4,x=0,A=this._position[0],t=this._position[1],u=this._position[2];d&&(d=[A-B,t-B,u-B],this._children[h.octree.TOP_NW]===null&&(this._children[h.octree.TOP_NW]=new y(s,this._max_depth-1,this,d,h.octree.TOP_NW)),this._children[h.octree.TOP_NW].insert(a,b),++x);q&&(d=[A+B,t-B,u-B],this._children[h.octree.TOP_NE]===
null&&(this._children[h.octree.TOP_NE]=new y(s,this._max_depth-1,this,d,h.octree.TOP_NE)),this._children[h.octree.TOP_NE].insert(a,b),++x);m&&(d=[A-B,t+B,u-B],this._children[h.octree.BOTTOM_NW]===null&&(this._children[h.octree.BOTTOM_NW]=new y(s,this._max_depth-1,this,d,h.octree.BOTTOM_NW)),this._children[h.octree.BOTTOM_NW].insert(a,b),++x);w&&(d=[A+B,t+B,u-B],this._children[h.octree.BOTTOM_NE]===null&&(this._children[h.octree.BOTTOM_NE]=new y(s,this._max_depth-1,this,d,h.octree.BOTTOM_NE)),this._children[h.octree.BOTTOM_NE].insert(a,
b),++x);n&&(d=[A-B,t-B,u+B],this._children[h.octree.TOP_SW]===null&&(this._children[h.octree.TOP_SW]=new y(s,this._max_depth-1,this,d,h.octree.TOP_SW)),this._children[h.octree.TOP_SW].insert(a,b),++x);c&&(d=[A+B,t-B,u+B],this._children[h.octree.TOP_SE]===null&&(this._children[h.octree.TOP_SE]=new y(s,this._max_depth-1,this,d,h.octree.TOP_SE)),this._children[h.octree.TOP_SE].insert(a,b),++x);o&&(d=[A-B,t+B,u+B],this._children[h.octree.BOTTOM_SW]===null&&(this._children[h.octree.BOTTOM_SW]=new y(s,
this._max_depth-1,this,d,h.octree.BOTTOM_SW)),this._children[h.octree.BOTTOM_SW].insert(a,b),++x);g&&(d=[A+B,t+B,u+B],this._children[h.octree.BOTTOM_SE]===null&&(this._children[h.octree.BOTTOM_SE]=new y(s,this._max_depth-1,this,d,h.octree.BOTTOM_SE)),this._children[h.octree.BOTTOM_SE].insert(a,b),++x);if(x>1||a.octree_common_root===null)a.octree_common_root=this}}};y.prototype.draw_on_map=function(a,b,e){function g(a,g,n,e,c){var m=a<n?a:n,h=g<e?g:e,a=a<n?n-a:a-n,g=g<e?e-g:g-e;b.save();if(c!==void 0)b.fillStyle=
c,b.fillRect(d+m,q+h,a,g);b.strokeRect(d+m,q+h,a,g);b.restore()}var d=a.width/2,q=a.height/2,n,c,h,m,o,s,B;if(e===r||e==="map")b.save(),this._debug_visible!==!1?(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="#FF0000"):(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="rgba(0,0,0,0)"),b.beginPath(),o=this._size/2,n=this._position[0],c=this._position[2],b.moveTo(d+n-o,d+c-o),b.lineTo(d+n-o,d+c+o),b.lineTo(d+n+o,d+c+o),b.lineTo(d+n+o,d+c-o),b.stroke(),b.fill(),b.restore();if(e===r||e==="objects"){b.save();o=0;
for(B=this._nodes.length;o<B;++o)s=this._nodes[o],b.fillStyle="#5500FF",b.strokeStyle=s.visible===!0&&s.culled===!1?"#FFFFFF":"#000000",b.beginPath(),n=s.aabb[0][0],c=s.aabb[0][2],h=s.aabb[1][0]-n,m=s.aabb[1][2]-c,b.rect(d+n,q+c,h,m),b.stroke();b.restore()}if(e===r||e==="lights"){o=0;for(B=this._lights.length;o<B;++o)m=this._lights[o],b.fillStyle=m.culled===!1&&m.visible===!0?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FFFF00",b.beginPath(),s=m.distance,n=m.position[0],c=
m.position[2],b.arc(d+n,q+c,s,0,Math.PI*2,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),n=m.aabb[0][0],c=m.aabb[0][2],h=m.aabb[1][0]-n,m=m.aabb[1][2]-c,b.rect(d+n,q+c,h,m),b.closePath(),b.stroke();o=0;for(B=this._static_lights.length;o<B;++o)m=this._static_lights[o],b.fillStyle=m.culled===!1&&m.visible===!0?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FF66BB",b.beginPath(),s=m.distance,n=m.position[0],c=m.position[2],b.arc(d+n,q+c,s,0,Math.PI*2,!0),b.closePath(),b.stroke(),
b.fill(),b.beginPath(),n=m.aabb[0][0],c=m.aabb[0][2],h=m.aabb[1][0]-n,m=m.aabb[1][2]-c,b.rect(d+n,q+c,h,m),b.closePath(),b.stroke()}if(e!="lights"&&e!="objects"&&e!="map"){b.save();n=this._nodes;o=0;for(m=n.length;o<m;++o)if(s=n[o],s.name==e){b.strokeStyle="#FFFF00";b.lineWidth=3;b.beginPath();n=s.aabb[0][0];c=s.aabb[0][2];h=s.aabb[1][0]-n;m=s.aabb[1][2]-c;b.rect(d+n,q+c,h,m);b.closePath();b.stroke();n=s.octree_aabb;b.strokeStyle="#0000FF";g(n[0][0],n[0][2],n[1][0],n[1][2]);b.lineWidth=1;if(s.common_root!==
null)b.strokeStyle="#00FF00";break}b.lineWidth=1;b.strokeStyle="#FFFF00";g(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");b.fill();b.restore()}o=0;for(B=this._children.length;o<B;++o)this._children[o]!==null&&this._children[o].draw_on_map(a,b,e)};y.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=this._position[1]-
this._size/2&&a[2]>=this._position[2]-this._size/2};y.prototype.get_frustum_hits=function(a,b){var e={objects:[],lights:[]};if((b===r||b===!0)&&!this.contains_point(a.position)){if(c.intersects(a.frustum.sphere,this._sphere)===!1)return e;var g=a.frustum.contains_sphere(this._sphere);if(g===-1)return this._debug_visible=!1,e;else if(g===1)this._debug_visible=2,b=!1;else if(g===0)if(this._debug_visible=!0,g=a.frustum.contains_box(this._bbox),g===-1)return this._debug_visible=!1,e;else if(g===1)this._debug_visible=
3,b=!1}var d,q,g=0;for(d=this._nodes.length;g<d;++g)q=this._nodes[g],e.objects.push(q),q.dynamic_lights=[].concat(this._lights),q.was_culled=q.culled,q.culled=!1,q.drawn_this_frame=!1;this._debug_visible=this._lights.length>0?4:this._debug_visible;g=0;for(d=this._lights.length;g<d;++g)if(q=this._lights[g],q.visible===!0)e.lights.push(q),q.was_culled=q.culled,q.culled=!1;g=0;for(d=this._static_lights.length;g<d;++g)if(q=this._static_lights[g],q.visible===!0)q.culled=!1;for(g=0;g<8;++g)if(this._children[g]!==
null){d=this._children[g].get_frustum_hits(a,b);var n;q=0;for(n=d.objects.length;q<n;++q){e.objects.push(d.objects[q]);for(var m=d.objects[q].dynamic_lights,h=0,o=this._lights.length;h<o;++h)m.indexOf(this._lights[h])<0&&m.push(this._lights[h])}q=0;for(n=d.lights.length;q<n;++q)e.lights.indexOf(d.lights[q])<0&&e.lights.push(d.lights[q])}return e};y.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,b;a=0;for(b=this._nodes.length;a<b;++a)this._nodes[a].culled=!0;a=0;for(b=this._lights.length;a<
b;++a)this._lights[a].culled=!0;a=0;for(b=this._static_lights.length;a<b;++a)this._static_lights[a].culled=!0;a=0;for(b=this._children.length;a<b;++a)this._children[a]!==null&&this._children[a].reset_node_visibility()};s.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};s.prototype.attach=function(a){this._object=a};o.prototype.extract=function(a,b,e){var g=CubicVR.vec3;if(!(b===r||e===r)){var d=CubicVR.mat4.multiply(e,b),b=this._planes;b[h.frustum.plane.LEFT][0]=d[3]+d[0];b[h.frustum.plane.LEFT][1]=
d[7]+d[4];b[h.frustum.plane.LEFT][2]=d[11]+d[8];b[h.frustum.plane.LEFT][3]=d[15]+d[12];b[h.frustum.plane.RIGHT][0]=d[3]-d[0];b[h.frustum.plane.RIGHT][1]=d[7]-d[4];b[h.frustum.plane.RIGHT][2]=d[11]-d[8];b[h.frustum.plane.RIGHT][3]=d[15]-d[12];b[h.frustum.plane.TOP][0]=d[3]-d[1];b[h.frustum.plane.TOP][1]=d[7]-d[5];b[h.frustum.plane.TOP][2]=d[11]-d[9];b[h.frustum.plane.TOP][3]=d[15]-d[13];b[h.frustum.plane.BOTTOM][0]=d[3]+d[1];b[h.frustum.plane.BOTTOM][1]=d[7]+d[5];b[h.frustum.plane.BOTTOM][2]=d[11]+
d[9];b[h.frustum.plane.BOTTOM][3]=d[15]+d[13];b[h.frustum.plane.NEAR][0]=d[3]+d[2];b[h.frustum.plane.NEAR][1]=d[7]+d[6];b[h.frustum.plane.NEAR][2]=d[11]+d[10];b[h.frustum.plane.NEAR][3]=d[15]+d[14];b[h.frustum.plane.FAR][0]=d[3]-d[2];b[h.frustum.plane.FAR][1]=d[7]-d[6];b[h.frustum.plane.FAR][2]=d[11]-d[10];b[h.frustum.plane.FAR][3]=d[15]-d[14];for(var q=0;q<6;++q)m.normalize(b[q]);q=-b[h.frustum.plane.NEAR][3];b=b[h.frustum.plane.FAR][3]-q;e=b*(1/e[5]);e=g.subtract([0,0,q+b*0.5],[e,e,q+b]);e=g.length(e);
d=[d[3],d[9],d[10]];q=g.length(d);d=g.multiply(d,1/q);a=[a.position[0],a.position[1],a.position[2]];a=g.add(a,g.multiply(d,b*0.5));a=g.add(a,g.multiply(d,1));this.sphere=[a[0],a[1],a[2],e]}};o.prototype.contains_sphere=function(a){for(var b=CubicVR.vec3,e=this._planes,g=0;g<6;++g){var d=e[g],d=b.dot([d[0],d[1],d[2]],[a[0],a[1],a[2]])+d.d;this.last_in[g]=1;if(d<-a[3])return-1;if(Math.abs(d)<a[3])return 0}return 1};o.prototype.draw_on_map=function(a,b){var e=a.width/2,g=a.height/2;b.save();for(var d=
this._planes,q=[0,1,4,5],n=0,c=q.length;n<c;++n){var m=d[q[n]];b.strokeStyle="#FF00FF";if(n<this.last_in.length&&this.last_in[n])b.strokeStyle="#FFFF00";var h=-e,o=e,r=(-m[3]-m[0]*o)/m[2];b.moveTo(e+h,g+(-m[3]-m[0]*h)/m[2]);b.lineTo(e+o,g+r);b.stroke()}b.strokeStyle="#0000FF";b.beginPath();b.arc(e+this.sphere[0],g+this.sphere[2],this.sphere[3],0,Math.PI*2,!1);b.closePath();b.stroke();b.restore()};o.prototype.contains_box=function(a){var b=0,e=[];e[0]=a[0];e[1]=[a[0][0],a[0][1],a[1][2]];e[2]=[a[0][0],
a[1][1],a[0][2]];e[3]=[a[0][0],a[1][1],a[1][2]];e[4]=[a[1][0],a[0][1],a[0][2]];e[5]=[a[1][0],a[0][1],a[1][2]];e[6]=[a[1][0],a[1][1],a[0][2]];e[7]=a[1];for(var a=this._planes,g=0;g<6;++g){for(var d=8,q=1,n=0;n<8;++n)m.classifyPoint(a[g],e[n])===-1&&(q=0,--d);this.last_in[g]=q;if(d===0)return-1;b+=q}if(b===6)return 1;return 0};return{Frustum:o,Octree:y}});CubicVR.RegisterModule("Particles",function(t){function y(o,m,c,h,a,b,e){if(o){this.last_particle=this.particles=null;this.pTex=c!==s?c:null;this.vWidth=h;this.vHeight=a;this.alpha=b!==s?b:!1;this.alphaCut=e!==s?e:0;this.pfunc=function(a,b){var q=b-a.start_time;if(q<0)return 0;if(q>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+q*a.velocity[0]+q*q*a.accel[0];a.pos[1]=a.startpos[1]+q*a.velocity[1]+q*q*a.accel[1];a.pos[2]=a.startpos[2]+q*a.velocity[2]+q*q*a.accel[2];this.pgov!==null&&this.pgov(a,
b);return 1};this.pgov=null;this.hasColor=m===s?!1:m;c=this.pTex!==null;this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",c?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",c?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",c?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n");this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",c?"uniform sampler2D pMap;":"","varying vec4 color;",c?"varying vec2 screenPos;":"",c?"uniform vec3 screenDim;":"",c?"varying float pSize;":"","void main(void) {\nvec4 c = color;",c?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",c?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",c?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n");this.maxPoints=o;this.numParticles=0;this.arPoints=new Float32Array(o*3);this.glPoints=null;if(m)this.arColor=new Float32Array(o*3),this.glColor=null;this.shader_particle=new CubicVR.Shader(this.vs,this.fs);this.shader_particle.use();this.shader_particle.addVertexArray("aVertexPosition");
this.hasColor&&this.shader_particle.addVertexArray("aColor");this.shader_particle.addMatrix("uMVMatrix");this.shader_particle.addMatrix("uPMatrix");this.pTex!==null&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[h,a,0]));this.genBuffer()}}var s=t.undef,o=t.GLCore;y.prototype={resizeView:function(o,m){this.vWidth=o;this.vHeight=m;this.pTex!==null&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[o,m,0]))},addParticle:function(o){this.last_particle===null?this.particles=o:this.last_particle.nextParticle=o;this.last_particle=o},genBuffer:function(){var r=o.gl;this.glPoints=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,this.glPoints);r.bufferData(r.ARRAY_BUFFER,this.arPoints,r.DYNAMIC_DRAW);if(this.hasColor)this.glColor=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.glColor),r.bufferData(r.ARRAY_BUFFER,this.arColor,r.DYNAMIC_DRAW)},updatePoints:function(){var r=o.gl;r.bindBuffer(r.ARRAY_BUFFER,
this.glPoints);r.bufferData(r.ARRAY_BUFFER,this.arPoints,r.DYNAMIC_DRAW)},updateColors:function(){var r=o.gl;this.hasColor&&(r.bindBuffer(r.ARRAY_BUFFER,this.glColor),r.bufferData(r.ARRAY_BUFFER,this.arColor,r.DYNAMIC_DRAW))},draw:function(r,m,c){var h=o.gl;this.shader_particle.use();this.pTex!==null&&this.pTex.use(h.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",r);this.shader_particle.setMatrix("uPMatrix",m);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);h.bindBuffer(h.ARRAY_BUFFER,this.glPoints);
h.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,h.FLOAT,!1,0,0);h.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(h.bindBuffer(h.ARRAY_BUFFER,this.glColor),h.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,h.FLOAT,!1,0,0),h.enableVertexAttribArray(this.shader_particle.uniforms.aColor));c===s&&(c=0);if(this.particles===null)h.disable(h.BLEND);else{for(var r=this.particles,m=null,a=this.numParticles=0;r!==null;){var b=this.numParticles*
3,e=this.pfunc(r,c);if(e===1){if(this.arPoints[b]=r.pos[0],this.arPoints[b+1]=r.pos[1],this.arPoints[b+2]=r.pos[2],r.color!==null&&this.arColor!==s&&(this.arColor[b]=r.color[0],this.arColor[b+1]=r.color[1],this.arColor[b+2]=r.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else if(e===-1){if(m!==null)m.nextParticle=r.nextParticle}else e===0&&a++;m=r;r=r.nextParticle}if(!a)this.last_particle=this.particles=null;this.updatePoints();this.hasColor&&this.updateColors();this.alpha&&
(h.enable(h.BLEND),h.enable(h.DEPTH_TEST),h.depthMask(0),h.blendFunc(h.ONE,h.ONE_MINUS_SRC_COLOR));h.drawArrays(h.POINTS,0,this.numParticles);this.alpha&&(h.disable(h.BLEND),h.depthMask(1),h.blendFunc(h.ONE,h.ONE));this.hasColor&&h.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}}};return{ParticleSystem:y,Particle:function(o,m,c,h,a){this.startpos=new Float32Array(o);this.pos=new Float32Array(o);this.velocity=new Float32Array(h!==s?h:[0,0,0]);this.accel=new Float32Array(a!==s?a:[0,
0,0]);this.start_time=m!==s?m:0;this.life_time=c!==s?c:0;this.nextParticle=this.color=null}}});CubicVR.RegisterModule("PostProcess",function(t){function y(a){if(a.shader_vertex===r)return null;if(a.shader_fragment===r)return null;this.outputMode=a.outputMode===r?c.post.output.REPLACE:a.outputMode;this.onresize=a.onresize===r?null:a.onresize;this.onupdate=a.onupdate===r?null:a.onupdate;this.init=a.init===r?null:a.init;this.enabled=a.enabled===r?!0:a.enabled;this.outputDivisor=a.outputDivisor===r?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,a.shader_fragment);this.shader.use();
this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");this.init!==null&&this.init(this.shader)}function s(a,e,g){var d=m.gl;this.width=a;this.height=e;this.accum=g===r?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,e,!0);this.bufferA=new CubicVR.RenderBuffer(a,e,!1);this.bufferB=new CubicVR.RenderBuffer(a,e,!1);this.bufferC=new CubicVR.RenderBuffer(a,
e,!1);this.accumOpacity=1;this.accumIntensity=0.3;if(this.accum)this.accumBuffer=new CubicVR.RenderBuffer(a,e,!1),this.accumBuffer.use(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT),this.blur_shader=new y({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}});this.bufferA.use();d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.bufferB.use();d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new y({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,e)}function o(a,e,g){this.createBuffer(a,e,g)}var r=t.undef,m=t.GLCore,c=CubicVR.enums;c.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var h=[],a=[];s.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,e){var g=m.gl,d=[],q=a/a,n=e/e;d.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);d.vbo_uvs=new Float32Array([0,0,q,0,q,n,0,n,0,0,q,n]);d.gl_points=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,
d.gl_points);g.bufferData(g.ARRAY_BUFFER,d.vbo_points,g.STATIC_DRAW);d.gl_uvs=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,d.gl_uvs);g.bufferData(g.ARRAY_BUFFER,d.vbo_uvs,g.STATIC_DRAW);return d},destroyFSQuad:function(a){var e=m.gl;e.deleteBuffer(a.gl_points);e.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,e){var g=m.gl;a.use();g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.bindBuffer(g.ARRAY_BUFFER,e.gl_points);g.vertexAttribPointer(a.aVertex,3,g.FLOAT,!1,0,0);g.enableVertexAttribArray(a.aVertex);
g.bindBuffer(g.ARRAY_BUFFER,e.gl_uvs);g.vertexAttribPointer(a.aTex,2,g.FLOAT,!1,0,0);g.enableVertexAttribArray(a.aTex);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.drawArrays(g.TRIANGLES,0,6)},addShader:function(b){this.shaders[this.shaders.length]=b;b.shader.use();b.shader.setVector("texel",this.vTexel);if(b.outputDivisor&&b.outputDivisor!=1&&h[b.outputDivisor]===r){var e=this.width/b.outputDivisor|0,g=this.height/b.outputDivisor|0;h[b.outputDivisor]=new CubicVR.RenderBuffer(e,g,!1);a[b.outputDivisor]=
this.makeFSQuad(e,g)}},resize:function(b,e){var g=m.gl;this.width=b;this.height=e;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),g.clearColor(0,0,0,1),g.clear(g.COLOR_BUFFER_BIT));for(var d in h){var g=this.width/d|0,q=this.height/d|0;h[d].destroyBuffer();h[d].createBuffer(g,q,!1);this.destroyFSQuad(a[d]);a[d]=this.makeFSQuad(g,q)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;d=0;for(g=this.shaders.length;d<g;d++)if(this.shaders[d].shader.use(),this.shaders[d].shader.setVector("texel",this.vTexel),this.shaders[d].onresize!==null)this.shaders[d].onresize(this.shaders[d].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(){this.captureBuffer.use()},end:function(){var a=m.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var b=m.gl;this.captureBuffer.texture.use(b.TEXTURE1);this.outputBuffer.use();this.captureBuffer.texture.use(b.TEXTURE0);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);
this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var e=0,g=0,d=this.shaders.length;g<d;g++){var q=this.shaders[g];if(q.enabled){this.swap();this.inputBuffer.texture.use(b.TEXTURE0);var n=q.outputMode;if(n===c.post.output.REPLACE)q.outputDivisor!==1?h[q.outputDivisor].use():this.outputBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);else if(n===c.post.output.ADD||n===c.post.output.BLEND)q.outputDivisor!==1?h[q.outputDivisor].use():this.bufferC.use(),b.clearColor(0,
0,0,1),b.clear(b.COLOR_BUFFER_BIT);q.onupdate!==null&&(q.shader.use(),q.onupdate(q.shader));q.outputDivisor!==1?(b.viewport(0,0,h[q.outputDivisor].width,h[q.outputDivisor].height),this.renderFSQuad(q.shader,a[q.outputDivisor]),q.outputMode===c.post.output.REPLACE?(this.outputBuffer.use(),h[q.outputDivisor].texture.use(b.TEXTURE0),b.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,this.fsQuad)):b.viewport(0,0,this.width,this.height)):this.renderFSQuad(q.shader,this.fsQuad);
n===c.post.output.BLEND?(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(b.TEXTURE0),q.outputDivisor!==1?h[q.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND)):n===c.post.output.ADD&&(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE),q.outputDivisor!==1?h[q.outputDivisor].texture.use(b.TEXTURE0):
this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND));this.end();e++}}e===0?this.captureBuffer.texture.use(b.TEXTURE0):this.outputBuffer.texture.use(b.TEXTURE0);this.accum&&this.accumOpacity!==1?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),b.disable(b.BLEND),
this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(b.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),b.disable(b.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};o.prototype={createBuffer:function(a,e,g){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=
parseInt(e,10);var a=this.sizeParam(a),e=this.sizeParam(e),d=m.gl;this.fbo=d.createFramebuffer();if(g)this.depth=d.createRenderbuffer();d.bindFramebuffer(d.FRAMEBUFFER,this.fbo);g&&(d.bindRenderbuffer(d.RENDERBUFFER,this.depth),navigator.appVersion.indexOf("Windows")!==-1?(d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,a,e),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,this.depth)):(d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_STENCIL,a,e),d.framebufferRenderbuffer(d.FRAMEBUFFER,
d.DEPTH_STENCIL_ATTACHMENT,d.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;d.bindTexture(d.TEXTURE_2D,t.Textures[this.texture.tex_id]);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,a,e,0,d.RGBA,d.UNSIGNED_BYTE,null);d.framebufferTexture2D(d.FRAMEBUFFER,
d.COLOR_ATTACHMENT0,d.TEXTURE_2D,t.Textures[this.texture.tex_id],0);d.bindFramebuffer(d.FRAMEBUFFER,null)},destroyBuffer:function(){var a=m.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(t.Textures[this.texture.tex_id]);t.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=m.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.fbo)}};return{RenderBuffer:o,PostProcessShader:y,PostProcessChain:s,fsQuad:{make:s.prototype.makeFSQuad,
destroy:s.prototype.destroyFSQuad,render:s.prototype.renderFSQuad}}});CubicVR.RegisterModule("Polygon",function(t){function y(a){var b=[],n=a.length;if(n<3)return null;var e=[],c;c=a.length;for(var m=0,h=c-1,o=0;o<c;h=o++)m+=a[h][0]*a[o][1]-a[o][0]*a[h][1];if(0<m*0.5)for(c=0;c<n;c++)e[c]=c;else for(c=0;c<n;c++)e[c]=n-1-c;o=2*n;m=0;for(c=n-1;n>2;){if(0>=o--)return null;var r=c;n<=r&&(r=0);c=r+1;n<=c&&(c=0);h=c+1;n<=h&&(h=0);var s;a:{s=a;var t=r,z=c,u=h,y=n,D=e,H=void 0,L=void 0,F=void 0,J=void 0,G=void 0,I=void 0,K=void 0,N=void 0,S=void 0,L=s[D[t]][0],F=s[D[t]][1],
J=s[D[z]][0],G=s[D[z]][1],I=s[D[u]][0],K=s[D[u]][1];if(g>(J-L)*(K-F)-(G-F)*(I-L))s=!1;else{for(H=0;H<y;H++)if(!(H==t||H==z||H==u)){var N=s[D[H]][0],S=s[D[H]][1],M=void 0,P=void 0,U=void 0,W=void 0,V=void 0,Y=void 0,Z=void 0,$=void 0,T=void 0,R=void 0,X=void 0,aa=void 0,M=U=V=void 0,M=I-J,P=K-G,U=L-I,W=F-K,V=J-L,Y=G-F,Z=N-L,$=S-F,T=N-J,R=S-G,X=N-I,aa=S-K,M=M*R-P*T,V=V*$-Y*Z,U=U*aa-W*X;if(M>=0&&U>=0&&V>=0){s=!1;break a}}s=!0}}if(s){o=e[r];r=e[c];h=e[h];b.push(o);b.push(r);b.push(h);m++;h=c;for(o=c+
1;o<n;h++,o++)e[h]=e[o];n--;o=2*n}}return b}function s(a,b,n){n===e&&(n=0);var c;c=y(b);var g=CubicVR.util.repackArray(c,3,c.length/3),m=[],h=a.points.length;c=0;for(iMax=b.length;c<iMax;c++)m.push([b[c][0],b[c][1],n]);a.addPoint(m);c=0;for(iMax=g.length;c<iMax;c++)a.addFace([g[c][0]+h,g[c][1]+h,g[c][2]+h])}function o(a,b){var c=b[0]-a[0],g=b[1]-a[1];return Math.sqrt(c*c+g*g)}function r(a,b){var c,g,e=[],m=a.length,h=b.length,r=[];for(c=0;c<m;c++)for(g=0;g<h;g++){var s=o(a[c],b[g]);e.push([s,c,g])}e.sort(function(a,
d){return a[0]>d[0]});for(c=0;c<5;c++)for(g=0;g<e.length;g++)c!=g&&e[c][1]!=e[g][1]&&e[c][2]!=e[g][2]&&e[c][1]<e[g][1]&&e[c][2]<e[g][2]&&Math.abs(e[c][1]-e[g][1])<4&&Math.abs(e[c][2]-e[g][2])<4&&r.push([c,g]);r.sort(function(a,d){return e[a[0]][0]+e[a[1]][0]>e[d[0]][0]+e[d[1]][0]});if(r.length>10)r.length=10;g=[];for(c=0;c<r.length;c++)g.push([e[r[c][0]],e[r[c][1]]]);return g}function m(a,b){var c=r(a,b),g;if(!c.length)return null;g=c[0][0];var e=c[0][1],c=e[1]-g[1],e=e[2]-g[2],m=a.slice(g[1]),m=
m.concat(a.slice(0,g[1])),h=b.slice(g[2]),h=h.concat(b.slice(0,g[2])),o=[];for(g=c;g<m.length;g++)o.push(m[g]);o.push(m[0]);for(g=e;g<h.length;g++)o.push(h[g]);o.push(h[0]);var s=[];for(g=0;g<=c;g++)s.push(m[g]);for(g=0;g<=e;g++)s.push(h[g]);return[o,s]}function c(a){for(var b=[0,0],g=0;g<a.length;g++)b[0]+=a[g][0],b[1]+=a[g][1];b[0]/=a.length;b[1]/=a.length;return b}function h(a,b,g){for(var c=[],e=0;e<a.length;e++){var m=[a[e][0]-b[0],a[e][1]-b[1]],h=Math.sqrt(m[0]*m[0]+m[1]*m[1])+g,m=Math.atan2(m[1],
m[0]);c[e]=[b[0]+Math.cos(m)*h,b[1]+Math.sin(m)*h]}return c}function a(a,b,g,c,e){var m,h=a.points.length;if(b.length!=g.length)return null;var o=b.length;for(m=0;m<o;m++)a.addPoint([b[m][0],b[m][1],c]);for(m=0;m<o;m++)a.addPoint([g[m][0],g[m][1],e]);for(m=0;m<o-1;m++)a.addFace([h+m,h+m+1,h+(m+o+1),h+(m+o)]);m=o-1;a.addFace([h+m,h,h+o,h+(m+o)])}function b(a){this.points=a;this.cuts=[];this.result=[]}var e=t.undef,g=1.0E-10;b.prototype={cut:function(a){this.cuts.push(a)},toMesh:function(a){if(this.points.length!==
0){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var g=this.cuts[b].points.slice(0),g=g.reverse(),g=m(this.result[0],g);this.result[0]=g[0];this.result.push(g[1])}for(b=0;b<this.result.length;b++)s(a,this.result[b]);a.removeDoubles();return a}},toExtrudedMesh:function(b,g,c){if(this.points.length!==0){var h,o;g===e&&(g=0);c===e&&(c=0);var r=g!=c;b||(b=new CubicVR.Mesh);this.result=[this.points];for(o=0;o<this.cuts.length;o++)h=this.cuts[o].points.slice(0),
h=h.reverse(),h=m(this.result[0],h),this.result[0]=h[0],this.result.push(h[1]);h=new CubicVR.Mesh;for(o=0;o<this.result.length;o++)s(h,this.result[o],c);b.booleanAdd(h);h.flipFaces();if(r)for(o=0;o<h.points.length;o++)h.points[o][2]=g;b.booleanAdd(h);if(r){a(b,this.points,this.points,g,c);for(o=0;o<this.cuts.length;o++)h=this.cuts[o].points.slice(0),h=h.reverse(),a(b,h,h,g,c)}b.removeDoubles();return b}},toExtrudedBeveledMesh:function(b,g,e,o,r,w,t){var E=[],B=[],x,A,z,u;if(this.points.length!==0){typeof g===
"object"&&(t=g,g=t.front||0,e=t.back||0,o=t.frontDepth||0,r=t.frontShift||0,w=t.backDepth||0,t=t.backShift||0);var y=g!==e,D=w!==0,H=o!==0;b||(b=new CubicVR.Mesh);H?(A=c(this.points),A=h(this.points,A,-r),this.result=[A.slice(0)]):this.result=[this.points.slice(0)];for(u=0;u<this.cuts.length;u++)z=c(this.cuts[u].points),z=h(this.cuts[u].points,z,r),z=z.reverse(),E.push(z),z=m(this.result[0],z),this.result[0]=z[0],this.result.push(z[1]);r=new CubicVR.Mesh;for(u=0;u<this.result.length;u++)s(r,this.result[u],
g-o);r.flipFaces();b.booleanAdd(r);if(D||H){x=c(this.points);x=h(this.points,x,-t);this.result=[x.slice(0)];for(u=0;u<this.cuts.length;u++)z=c(this.cuts[u].points),z=h(this.cuts[u].points,z,t),z=z.reverse(),B.push(z),z=m(this.result[0],z),this.result[0]=z[0],this.result.push(z[1]);r=new CubicVR.Mesh;for(u=0;u<this.result.length;u++)s(r,this.result[u],e+w)}else{for(u=0;u<r.points.length;u++)r.points[u][2]=e;r.flipFaces()}b.booleanAdd(r);H&&a(b,A,this.points,g-o,g);y&&a(b,this.points,this.points,g,
e);D&&a(b,this.points,x,e,e+w);for(u=0;u<E.length;u++)z=this.cuts[u].points.slice(0).reverse(),H&&a(b,E[u],z,g-o,g),y&&a(b,z,z,g,e),D&&a(b,z,B[u],e,e+w);b.removeDoubles();return b}}};return{polygon:{triangulate2D:y,toMesh:s,findNearPair:function(a,b){for(var g=[0,0],c=o(a[0],b[0]),e=a.length,m=b.length,h=0;h<e;h++)for(var r=0;r<m;r++){var s=o(a[h],b[r]);s<c&&(g[0]=h,g[1]=r,c=s)}return g},subtract:m,addOffset:function(a,b){for(var g=[],c=0,e=a.length;c<e;c++){var m=a[c];g.push([m[0]+b[0],m[1]+b[1]])}return g}},
Polygon:b}});CubicVR.RegisterModule("Primitives",function(t){function y(g,d,c,e,m,h){var o=CubicVR.mat4,r=CubicVR.vec3,s=[],t,x=[0,1,0],A=[1,0,0],z=[0,0,0],u=g.points.length,y,D,H;for(y=t=0;y<b;y+=b/c){if(t===c)break;A=[Math.cos(y),0,Math.sin(y)];D=0;for(H=d.length;D<H;D++)z=r.add(r.multiply(A,d[D][0]),r.multiply(x,d[D][1])),s[t]===a&&(s[t]=[]),s[t].push(z);t++}H=null;m!==a&&(H=m.getResult!==a?m.getResult():m);for(D=0;D<c;D++){m=0;for(t=d.length;m<t;m++)H?g.addPoint(o.vec3_multiply(s[D][m],H)):g.addPoint(s[D][m])}g.setFaceMaterial(e);
for(m=0;m<c;m++){D=0;for(H=d.length-1;D<H;D++)o=D+d.length*m,s=D+d.length*((m+1)%c),r.equal(g.points[u+o],g.points[u+s])?g.addFace([u+o+1,u+s+1,u+s]):r.equal(g.points[u+o+1],g.points[u+s+1])?g.addFace([u+o,u+o+1,u+s]):g.addFace([u+o,u+o+1,u+s+1,u+s])}h!==a&&(d=null,h.apply!==a?d=h:h&&(d=new CubicVR.UVMapper(h)),d!==null&&(g.calcFaceNormals(),d.apply(g,e)))}function s(b,d,c,e,m){var h=CubicVR.mat4;d*=0.5;var o=b.points.length;b.setFaceMaterial(c);e!==a?(e=e.getResult!==a?e.getResult():e,b.addPoint([h.vec3_multiply([d,
-d,0],e),h.vec3_multiply([d,d,0],e),h.vec3_multiply([-d,d,0],e),h.vec3_multiply([-d,-d,0],e)])):b.addPoint([[d,-d,0],[d,d,0],[-d,d,0],[-d,-d,0]]);b.addFace([[o+0,o+1,o+2,o+3],[o+3,o+2,o+1,o+0]]);m!==a&&(h=null,m.apply!==a?h=m:m&&(h=new CubicVR.UVMapper(m)),h!==null&&(b.calcFaceNormals(),h.apply(b,c)))}function o(b,d,c,e,m){var h=CubicVR.mat4;d/=2;var o=b.points.length;b.setFaceMaterial(c);e!==a?(e=e.getResult!==a?e.getResult():e,b.addPoint([h.vec3_multiply([d,-d,d],e),h.vec3_multiply([d,d,d],e),h.vec3_multiply([-d,
d,d],e),h.vec3_multiply([-d,-d,d],e),h.vec3_multiply([d,-d,-d],e),h.vec3_multiply([d,d,-d],e),h.vec3_multiply([-d,d,-d],e),h.vec3_multiply([-d,-d,-d],e)])):b.addPoint([[d,-d,d],[d,d,d],[-d,d,d],[-d,-d,d],[d,-d,-d],[d,d,-d],[-d,d,-d],[-d,-d,-d]]);b.addFace([[o+0,o+1,o+2,o+3],[o+7,o+6,o+5,o+4],[o+4,o+5,o+1,o+0],[o+5,o+6,o+2,o+1],[o+6,o+7,o+3,o+2],[o+7,o+4,o+0,o+3]]);m!==a&&(h=null,m.apply!==a?h=m:m&&(h=new CubicVR.UVMapper(m)),h!==null&&(b.calcFaceNormals(),h.apply(b,c)))}function r(a,d,c,e,m,h,o,r){var s=
[];c-=d;d+=c/2;for(var t=b/m,x=0,A=0;A<=m;A++)s.push([d+Math.cos(x)*c,Math.sin(x)*c,0]),x+=t;CubicVR.genLatheObject(a,s,e,h,o,r)}function m(a,b,c,e,m,h,o){CubicVR.genLatheObject(a,[[0,-c/2,0],[b/2,-c/2,0],[0,c/2,0]],e,m,h,o)}function c(a,b,c,e,m,h,o){CubicVR.genLatheObject(a,[[0,-c/2,0],[b,-c/2,0],[b,c/2,0],[0,c/2,0]],e,m,h,o)}function h(a,b,c,n,m,h,o){var r=[],n=(n/=2)|0;c|=0;for(var s=Math.PI/n,t=-e,x=0;x<=n;x++)r.push([Math.cos(t)*b,Math.sin(t)*b,0]),t+=s;CubicVR.genLatheObject(a,r,c,m,h,o)}var a=
t.undef,b=2*Math.PI,e=Math.PI/2;return{genPlaneObject:s,genBoxObject:o,genLatheObject:y,genTorusObject:r,genConeObject:m,genCylinderObject:c,genSphereObject:h,primitives:{lathe:function(b){var d,c;if(b.points==a)return null;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;y(d,b.points,b.divisions!==a?b.divisions:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},box:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==
a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;o(d,b.size!==a?b.size:1,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},plane:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;s(d,b.size!==a?b.size:1,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},sphere:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;
h(d,b.radius!==a?b.radius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},torus:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;r(d,b.innerRadius!==a?b.innerRadius:0.75,b.outerRadius!==a?b.outerRadius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},cone:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==
a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;m(d,b.base!==a?b.base:1,b.height!==a?b.height:1,b.lon!==a?b.lon:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},cylinder:function(b){var d,e,n,m,h,o;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);e=b.material!==a?b.material:new CubicVR.Material;n=b.transform!==a?b.transform:a;m=b.uvmapper!==a?b.uvmapper:a;h=b.radius!==a?b.radius:1;o=b.height!==a?b.height:1;lon=b.lon!==a?b.lon:24;c(d,h,o,lon,e,n,m);return d}}}});CubicVR.RegisterModule("Renderer",function(t){var y=t.undef;return{renderObject:function(s,o,r,m){if(s.compiled!==null){var c=0,h=CubicVR.GLCore.gl,a=m===y?0:m.length,b,e=0,g,d=null,q=!1,n,v,C;h.depthFunc(h.LEQUAL);r===y&&(r=cubicvr_identity);for(var w=0,O=s.compiled.elements_ref.length;w<O;w++){var d=s.materials[w],E=0,e=!1;d.opacity!==1?(h.enable(h.BLEND),h.depthMask(0),h.blendFunc(h.SRC_ALPHA,h.ONE_MINUS_SRC_ALPHA)):(h.depthMask(1),h.disable(h.BLEND),h.blendFunc(h.ONE,h.ONE));for(var B=0,x=s.compiled.elements_ref[w].length;B<
x;B++)if(g=s.compiled.elements_ref[w][B][0],e=!1,n=s.compiled.elements_ref[w][B][1],E+=n,!s.segment_state[g])if(E>n){c+=n*2;E-=n;if(a){v=!1;for(n=0;n<a;){nLights=a-n;if(nLights>t.MAX_LIGHTS)nLights=t.MAX_LIGHTS;n>0&&!v&&(h.enable(h.BLEND),h.blendFunc(h.ONE,h.ONE),h.depthFunc(h.EQUAL),v=!0);b=m[n];C=b.light_type;for(e=0;e<nLights;e++)if(m[e+n].light_type!=C){nLights=e;break}d.use(b.light_type,nLights);b=d.shader[b.light_type][nLights];h.uniformMatrix4fv(b.uMVMatrix,!1,o.mvMatrix);h.uniformMatrix4fv(b.uPMatrix,
!1,o.pMatrix);h.uniformMatrix4fv(b.uOMatrix,!1,r);h.uniformMatrix3fv(b.uNMatrix,!1,o.nMatrix);q||(d.bindObject(s,b),q=b.aTextureCoord!=-1);for(e=0;e<nLights;e++)m[e+n].setupShader(b,e);h.drawElements(h.TRIANGLES,E,h.UNSIGNED_SHORT,c);n+=nLights}v&&(h.disable(h.BLEND),h.depthFunc(h.LEQUAL))}else d.use(0,0),h.uniformMatrix4fv(d.shader[0][0].uMVMatrix,!1,o.mvMatrix),h.uniformMatrix4fv(d.shader[0][0].uPMatrix,!1,o.pMatrix),h.uniformMatrix4fv(d.shader[0][0].uOMatrix,!1,r),h.uniformMatrix3fv(d.shader[0][0].uNMatrix,
!1,o.nMatrix),q||(d.bindObject(s,d.shader[0][0]),q=d.shader[0][0].aTextureCoord!=-1),h.drawElements(h.TRIANGLES,E,h.UNSIGNED_SHORT,c);c+=E*2;E=0;e=!0}else c+=E*2,E=0;if(!e&&s.segment_state[g]){if(a){v=!1;for(n=0;n<a;){nLights=a-n;if(nLights>t.MAX_LIGHTS)nLights=t.MAX_LIGHTS;n>0&&!v&&(h.enable(h.BLEND),h.blendFunc(h.ONE,h.ONE),h.depthFunc(h.EQUAL),v=!0);b=m[n];C=b.light_type;for(e=0;e<nLights;e++)if(m[e+n].light_type!=C){nLights=e;break}d.use(b.light_type,nLights);b=d.shader[b.light_type][nLights];
h.uniformMatrix4fv(b.uMVMatrix,!1,o.mvMatrix);h.uniformMatrix4fv(b.uPMatrix,!1,o.pMatrix);h.uniformMatrix4fv(b.uOMatrix,!1,r);h.uniformMatrix3fv(b.uNMatrix,!1,o.nMatrix);q||(d.bindObject(s,b),q=b.aTextureCoord!=-1);for(e=0;e<nLights;e++)m[e+n].setupShader(b,e);h.drawElements(h.TRIANGLES,E,h.UNSIGNED_SHORT,c);n+=nLights}v&&(h.disable(h.BLEND),h.depthFunc(h.LEQUAL))}else d.use(0,0),h.uniformMatrix4fv(d.shader[0][0].uMVMatrix,!1,o.mvMatrix),h.uniformMatrix4fv(d.shader[0][0].uPMatrix,!1,o.pMatrix),h.uniformMatrix4fv(d.shader[0][0].uOMatrix,
!1,r),h.uniformMatrix3fv(d.shader[0][0].uNMatrix,!1,o.nMatrix),q||(d.bindObject(s,d.shader[0][0]),q=d.shader[0][0].aTextureCoord!=-1),h.drawElements(h.TRIANGLES,E,h.UNSIGNED_SHORT,c);c+=E*2}}d&&b&&d.clearObject(s,b);h.depthMask(1);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null)}}}});CubicVR.RegisterModule("Scene",function(t){function y(a,b){return a.light_type-b.light_type}function s(d,c){var e=null;d!==m&&d!==null&&(e=d.compile?null:d);e?(this.morphWeight=e.morphWeight||0,this.morphSource=e.morphSource||-1,this.morphTarget=e.morphTarget||-1,this.position=e.position===m?[0,0,0]:e.position,this.rotation=e.rotation===m?[0,0,0]:e.rotation,this.scale=e.scale===m?[1,1,1]:e.scale,this.shadowCast=e.shadowCast===m?!0:e.shadowCast,this.motion=e.motion===m?null:e.motion,this.obj=e.mesh===
m?d!==m&&e.faces!==m?d:null:e.mesh,this.name=e.name===m?c!==m?c:null:e.name):(this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.motion=null,this.obj=d,this.name=c,this.shadowCast=!0);this.parent=this.children=null;this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];this.lMatrix=b.identity();this.tMatrix=b.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,
[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[]}function o(a,b,c,e,m,h){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.collect_stats=!1;typeof a==="object"?(this.octree=a.octree,this.skybox=a.skybox||null,this.camera=new CubicVR.Camera(a.width,a.height,a.fov,
a.nearclip,a.farclip),this.name=a.name||"scene"+g,this.destroy=a.destroy||function(){},this.update=a.update||function(){},this.enable=a.enable||function(){},this.disable=a.disable||function(){},a=a.setup&&a.setup(this),this.update=a.update||this.update,this.enable=a.enable||this.enable,this.disable=a.disable||this.disable,this.destroy=a.destroy||this.destroy):(this.skybox=null,this.octree=h,this.camera=new CubicVR.Camera(a,b,c,e,m),this.name="scene"+g);this.paused=!1;++g}function r(){this.meshBin=
{};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var m=t.undef,c=CubicVR.enums,h=t.GLCore,a=CubicVR.aabb,b=CubicVR.mat4,e=0;s.prototype={setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return this.obj.morphTargets!==null?this.obj.morphTargets.length:
0},doTransform:function(a){var c=CubicVR.vec3;if(!c.equal(this.lposition,this.position)||!c.equal(this.lrotation,this.rotation)||!c.equal(this.lscale,this.scale)||a!==m)a!==m?this.tMatrix=a.slice(0):b.identity(this.tMatrix),b.identity(this.lMatrix),b.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),b.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),this.scale[0]===1&&this.scale[1]===1&&this.scale[2]===1||b.scale(this.scale[0],this.scale[1],this.scale[2],
this.lMatrix),b.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0},adjust_octree:function(){var b=this.getAABB(),c=this.octree_aabb,e=b[0][0],g=b[0][1],h=b[0][2],o=b[1][0],r=b[1][1],
s=b[1][2],t=c[0][0],x=c[0][1],A=c[0][2],z=c[1][0],u=c[1][1],c=c[1][2];if(this.octree_leaves.length>0&&(e<t||g<x||h<A||o>z||r>u||s>c)){for(e=0;e<this.octree_leaves.length;++e)this.octree_leaves[e].remove(this);this.octree_leaves=[];this.static_lights=[];e=this.octree_common_root;this.octree_common_root=null;if(e!==null){for(;;)if(!e.contains_point(b[0])||!e.contains_point(b[1]))if(e._root!==m&&e._root!==null)e=e._root;else break;else break;a.reset(this.octree_aabb,this.position);e.insert(this)}}},
bindChild:function(a){if(this.children===null)this.children=[];a.parent=this;this.children.push(a)},control:function(a,b,e){a===c.motion.POS?this.position[b]=e:a===c.motion.SCL?this.scale[b]=e:a===c.motion.ROT&&(this.rotation[b]=e)},getAABB:function(){var a=CubicVR.mat4,b=CubicVR.vec3;if(this.dirty){var c=Array(8);this.doTransform();var e,g;if(this.obj){if(!this.obj.bb)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];e=this.obj.bb[0];g=this.obj.bb[1]}if(!this.obj||e===
m||g===m)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];var h=e;e=b.subtract(g,e);c[0]=[h[0],h[1],h[2]];c[1]=[h[0],h[1],h[2]+e[2]];c[2]=[h[0]+e[0],h[1],h[2]];c[3]=[h[0]+e[0],h[1],h[2]+e[2]];c[4]=[h[0],h[1]+e[1],h[2]];c[5]=[h[0],h[1]+e[1],h[2]+e[2]];c[6]=[h[0]+e[0],h[1]+e[1],h[2]];c[7]=[h[0]+e[0],h[1]+e[1],h[2]+e[2]];h=a.vec3_multiply(c[0],this.tMatrix);e=[h[0],h[1],h[2]];g=[h[0],h[1],h[2]];for(b=1;b<8;++b)h=a.vec3_multiply(c[b],this.tMatrix),e[0]>h[0]&&(e[0]=h[0]),
e[1]>h[1]&&(e[1]=h[1]),e[2]>h[2]&&(e[2]=h[2]),g[0]<h[0]&&(g[0]=h[0]),g[1]<h[1]&&(g[1]=h[1]),g[2]<h[2]&&(g[2]=h[2]);this.aabb[0]=e;this.aabb[1]=g;this.dirty=!1}return this.aabb}};var g=0;o.prototype={attachOctree:function(b){this.octree=b;b.init&&b.init(this);b=this.lights;this.lights=[];for(var c=0,g=b.length;c<g;c++)this.bindLight(b[c]);b=this.sceneObjects;if(this.octree!==m){c=0;for(g=b.length;c<g;++c){var h=b[c];if(h.obj!==null){if(h.id<0)h.id=e,++e;this.sceneObjectsById[h.id]=h;a.reset(h.octree_aabb,
h.position);this.octree.insert(h);(h.octree_common_root===void 0||h.octree_common_root===null)&&log("!!",h.name,"octree_common_root is null")}}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(b,c,g){if(this.sceneObjects.indexOf(b)==-1){this.sceneObjects.push(b);c!==m&&c&&this.pickables.push(b);b.name!==null&&(this.sceneObjectsByName[b.name]=b);if(this.octree!==m&&(g===m||g==="true")){if(b.id<0)b.id=e,++e;this.sceneObjectsById[b.id]=
b;a.reset(b.octree_aabb,b.position);this.octree.insert(b)}if(b.children)for(var h=0,o=b.children.length;h<o;h++)this.bindSceneObject(b.children[h],c,g);return b}},removeLight:function(a){a=this.lights.indexOf(a);a>=0&&this.lights.splice(a,1)},removeSceneObject:function(a){var b;b=this.sceneObjects.indexOf(a);b>=0&&this.sceneObjects.splice(b,1);b=this.pickables.indexOf(a);b>=0&&this.pickables.splice(b,1);a.name!==null&&this.sceneObjectsByName[a.name]!==m&&delete this.sceneObjectsByName[a.name];if(a.children){b=
0;for(var c=a.children.length;b<c;b++)this.removeSceneObject(a.children[b])}},bindLight:function(a,b){this.lights.push(a);if(this.octree!==m&&(b===m||b==="true"))a.method===c.light.method.GLOBAL?this.global_lights.push(a):(a.method===c.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(y)},bindCamera:function(a){this.cameras.indexOf(a)===-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){typeof a!==
"object"&&(a=this.getCamera(camName));this.cameras.indexOf(a)===-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},setCamera:function(a){if(a)typeof a!=="object"&&(a=this.getCamera(a)),this.camera=a},getCamera:function(a){if(a===m)return this.camera;return this.camerasByName[a]},evaluate:function(a){var b,c;b=0;for(c=this.sceneObjects.length;b<c;b++)this.sceneObjects[b].motion&&this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);if(this.camera.motion!==null){if(this.camera.targetSceneObject!==
null)this.camera.target=this.camera.targetSceneObject.position;this.camera.motion.apply(a,this.camera)}b=0;for(c=this.lights.length;b<c;b++){var e=this.lights[b];e.motion!==null&&e.motion.apply(a,e)}},prepareTransforms:function(a){var b,c;if(a){if(a.children){b=0;for(c=a.children.length;b<c;b++)a.children[b].doTransform(a.tMatrix),this.prepareTransforms(a.children[b])}}else if(this.sceneObjects.length!==0){b=0;for(c=this.sceneObjects.length;b<c;++b)this.prepareTransforms(this.sceneObjects[b])}},renderSceneObjectChildren:function(a,
b,c){for(var e=h.gl,g=!1,m=0,o=a.children.length;m<o;m++)if(a.children[m].visible!==!1){try{a.children[m].doTransform(a.tMatrix)}catch(r){break}var s=a.children[m],t=a.children[m].obj;if(t){a.children[m].scale[0]<0&&(g=!g);a.children[m].scale[1]<0&&(g=!g);a.children[m].scale[2]<0&&(g=!g);g&&e.cullFace(e.FRONT);if(t.morphTargets&&(s.morphSource!==-1&&t.setMorphSource(s.morphSource),s.morphTarget!==-1&&t.setMorphTarget(s.morphTarget),s.morphWeight!==null))t.morphWeight=s.morphWeight;CubicVR.renderObject(t,
b,a.children[m].tMatrix,c);g&&e.cullFace(e.BACK)}a.children[m].children&&this.renderSceneObjectChildren(a.children[m],b,c)}},updateShadows:function(){var a=h.gl,b=!1;if(t.features.lightShadows){this.updateCamera();for(var e=!1,g=a.getParameter(a.VIEWPORT),m=0,o=this.lights.length;m<o;m++){var r=this.lights[m];if(r.light_type==c.light.type.SPOT_SHADOW||r.light_type==c.light.type.SPOT_SHADOW_PROJECTOR||r.light_type==c.light.type.AREA){var e=!0,s=new CubicVR.Light(c.light.type.DEPTH_PACK);if(r.light_type===
c.light.type.AREA)r.areaCam=this.camera,r.updateAreaLight();h.shadow_near=r.dummyCam.nearclip;h.shadow_far=r.dummyCam.farclip;r.shadowBegin();for(var B=0,x=this.sceneObjects.length;B<x;B++){var A=this.sceneObjects[B];if(!A.parent&&!(A.visible===!1||A.shadowCast===!1)){A.doTransform();if(A.obj){A.scale[0]<0&&(b=!b);A.scale[1]<0&&(b=!b);A.scale[2]<0&&(b=!b);b&&a.cullFace(a.FRONT);var z=A.obj;if(z.morphTargets&&(A.morphSource!==-1&&z.setMorphSource(A.morphSource),A.morphTarget!==-1&&z.setMorphTarget(A.morphTarget),
A.morphWeight!==null))z.morphWeight=A.morphWeight;CubicVR.renderObject(z,r.dummyCam,A.tMatrix,[s]);b&&a.cullFace(a.BACK);b=!1}A.children&&this.renderSceneObjectChildren(A,r.dummyCam,[s])}}r.shadowEnd()}}e&&a.viewport(g[0],g[1],g[2],g[3])}},updateCamera:function(){this.camera.manual===!1&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());
h.depth_alpha_near=this.camera.nearclip;h.depth_alpha_far=this.camera.farclip},resize:function(a,b){this.camera&&this.camera.setDimensions(a,b)},doTransform:function(){for(var a=this.octree!==m,b=0,c=this.sceneObjects.length;b<c;b++){var e=this.sceneObjects[b];if(e.parent===null&&(e.doTransform(),a&&(lights=[],e.dirty&&e.obj!==null&&e.adjust_octree(),!(e.visible===!1||a&&(e.ignore_octree||e.drawn_this_frame===!0||e.culled===!0)))))lights=e.dynamic_lights,lights=lights.concat(e.static_lights),lights=
lights.concat(this.global_lights),this.collect_stats&&(lights_rendered=Math.max(lights.length,lights_rendered),lights_rendered===lights.length&&(lights_list=lights),++objects_rendered),lights=lights.length===0?[h.emptyLight]:lights.sort(y),e.drawn_this_frame=!0}},render:function(){++this.frames;var a=h.gl,e;e=0;if(this.octree!==m)this.octree.reset_node_visibility(),this.octree.cleanup(),e=this.octree.get_frustum_hits(this.camera),e=e.lights.length;this.doTransform();this.updateCamera();var c,g;c=
0;for(g=this.lights.length;c<g;c++)this.lights[c].prepare(this.camera);var o=!1,r=[];c=0;for(g=this.sceneObjects.length;c<g;c++){var s=this.lights,t=this.sceneObjects[c];if(!(t.visible===!1||t.parent!==null)){if(t.obj){t.scale[0]<0&&(o=!o);t.scale[1]<0&&(o=!o);t.scale[2]<0&&(o=!o);o&&a.cullFace(a.FRONT);var B=t.obj;if(B.morphTargets!==null&&(t.morphSource!==-1&&B.setMorphSource(t.morphSource),t.morphTarget!==-1&&B.setMorphTarget(t.morphTarget),t.morphWeight!==null))B.morphWeight=t.morphWeight;CubicVR.renderObject(B,
this.camera,t.tMatrix,s);o&&a.cullFace(a.BACK);o=!1}t.children&&this.renderSceneObjectChildren(t,this.camera,s)}}if(this.collect_stats)this.stats["objects.num_rendered"]=0,this.stats["lights.num_rendered"]=e,this.stats["lights.rendered"]=r,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length;if(this.skybox!==null&&this.skybox.ready===!0)a.cullFace(a.FRONT),e=this.camera.farclip*2/Math.sqrt(3),this.skybox.scene_object.position=this.camera.parent?
b.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=[e,e,e],this.skybox.scene_object.doTransform(),CubicVR.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),a.cullFace(a.BACK)},bbRayTest:function(a,b,e){var c=CubicVR.vec3,g=[],b=b.length===2?this.camera.unProject(b[0],b[1]):c.add(a,b),h;for(h in this.pickables)if(this.pickables.hasOwnProperty(h)){var m=
this.pickables[h];if(m.visible===!0){var o,r;r=m.getAABB();o=r[0];r=r[1];r[0]-o[0]<0.2&&(o[0]-=0.1,r[0]+=0.1);r[1]-o[1]<0.2&&(o[1]-=0.1,r[1]+=0.1);r[2]-o[2]<0.2&&(o[2]-=0.1,r[2]+=0.1);var s=c.multiply(c.add(o,r),0.5),t=c.getClosestTo(a,b,s),s=c.length(c.subtract(t,s));(t[0]>=o[0]&&t[0]<=r[0]?1:0)+(t[1]>=o[1]&&t[1]<=r[1]?1:0)+(t[2]>=o[2]&&t[2]<=r[2]?1:0)>=e&&g.push({dist:s,obj:m})}}g.length&&g.sort(function(a,b){if(a.dist==b.dist)return 0;return a.dist<b.dist?-1:1});return g}};r.prototype={addMesh:function(a,
b,e){this.meshBin[a]===m&&(this.meshBin[a]=[],this.meshBinPtr[a]===m&&(this.meshBinPtr[a]=0));this.meshMap[b]===m&&(this.meshMap[b]=e,this.meshBin[a].push(e))},addImage:function(a,b,e){this.imageBin[a]===m&&(this.imageBin[a]=[],this.imageBinPtr[a]===m&&(this.imageBinPtr[a]=0));this.imageMap[b]===m&&(this.imageMap[b]=e,this.imageBin[a].push(e))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=
0},getNextMesh:function(a){var b=this.meshBinPtr[a];if(b<this.meshBin[a].length)return this.meshBinPtr[a]++,this.meshBin[a][b];return null},loadNextMesh:function(a){a=this.getNextMesh(a);if(a!==null)return a.compiled===null&&(a.triangulateQuads(),a.compile(),a.clean()),!0;return!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);if(a!==null)a.src=a.deferredSrc},getNextImage:function(a){var b=this.imageBinPtr[a];if(b<this.imageBin[a].length)return this.imageBinPtr[a]++,
this.imageBin[a][b];return null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===this.imageBin[a].length}};return{Scene:o,SceneObject:s,SkyBox:function(a){var b=a.texture,a=a.mapping,e=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;var a=1/t.Images[e.texture.tex_id].width;if(e.mapping===null)e.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]];var a=new CubicVR.Material({name:"skybox",textures:{color:b}}),
d=new CubicVR.Mesh;d.sky_mapping=e.mapping;CubicVR.primitives.box({mesh:d,size:1,material:a,uvmapper:{projectionMode:CubicVR.enums.uv.projection.SKY,scale:[1,1,1]}});d.prepare();e.scene_object=new CubicVR.SceneObject(d);e.ready=!0};if(b){if(typeof b==="string")b=new CubicVR.Texture(b,null,null,null,this.onready);else if(!b.loaded)b.onready=this.onready;this.texture=b;if(a)this.mapping=a,this.onready()}},DeferredBin:r}});CubicVR.RegisterModule("ScenePhysics",function(t){function y(a){return new btVector3(a[0],a[1],a[2])}function s(a){c.fromEuler(a[0],a[1],a[2]);return new btQuaternion(c.x,c.y,c.z,c.w)}var o=t.undef,r=CubicVR.enums;r.physics={body:{STATIC:0,DYNAMIC:1,SOFT:2}};var m,c,t=function(a,b){this.properties=new CubicVR.RigidProperties(b?b:{});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.sceneObject=a;this.transform=new btTransform;
this.transform.setIdentity();this.transform.setOrigin(y(this.init_position));this.transform.setRotation(s(this.init_rotation));this.shape=null;this.motionState=new btDefaultMotionState(this.transform);this.localInertia=new btVector3(0,0,0);this.body=this.bodyInit=null};t.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=
init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=a},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body){var a=this.getCollisionShape();this.getMass()&&a.calculateLocalInertia(this.getMass(),
this.localInertia);this.bodyInit=new btRigidBodyConstructionInfo(this.getMass(),this.motionState,a,this.localInertia);this.body=new btRigidBody(this.bodyInit)}return this.body},updateSceneObject:function(){if(this.body.isActive()){this.body.getMotionState().getWorldTransform(m);var a=m.getOrigin();a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z());a=m.getRotation();c.x=a.x();c.y=a.y();c.z=a.z();c.w=a.w();
c.x!=c.x?console.log("rotation is NaN"):(a=c.toEuler(),this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]);return!0}return!1},getCollisionShape:function(){if(!this.shape){var a=this.getCollisionMap().getShapes(),b,e,c,d=[];e=0;for(c=a.length;e<c;e++){b=a[e];var h=null;if(b.type===r.collision.shape.BOX)h=new btBoxShape(new btVector3(b.size[0]/2,b.size[1]/2,b.size[2]/2));else if(b.type===r.collision.shape.SPHERE)h=new btSphereShape(b.radius);else if(b.type===
r.collision.shape.CAPSULE)h=new btCapsuleShape(b.radius,b.height);else if(b.type===r.collision.shape.CYLINDER)h=new btCylinderShape(new btVector3(b.size[0]/2,b.size[1]/2,b.size[2]/2));else if(b.type===r.collision.shape.CONE)h=new btConeShape(b.radius,b.height);else if(b.type===r.collision.shape.MESH){var h=b.mesh,n=new btTriangleMesh,o=b.size,s=new btVector3(0,0,0),t=new btVector3(0,0,0),O=new btVector3(0,0,0);f=0;for(fMax=h.faces.length;f<fMax;f++){var E=h.faces[f];E.points.length===3&&(s.setValue(h.points[E.points[0]][0]*
o[0],h.points[E.points[0]][1]*o[1],h.points[E.points[0]][2]*o[2]),t.setValue(h.points[E.points[1]][0]*o[0],h.points[E.points[1]][1]*o[1],h.points[E.points[1]][2]*o[2]),O.setValue(h.points[E.points[2]][0]*o[0],h.points[E.points[2]][1]*o[1],h.points[E.points[2]][2]*o[2]),n.addTriangle(s,t,O))}this.getMass()===0||this.getType()==r.physics.body.STATIC?(this.setMass(0),h=new btBvhTriangleMeshShape(n,!0)):h=new btConvexTriangleMeshShape(n,!0)}h&&(b.margin!==0&&h.setMargin(b.margin),d.push({cShape:b,btShape:h}))}a=
null;if(d.length===1)a=d[0].btShape;else if(d.length>1){m=new btTransform;a=new btCompoundShape(!1);e=0;for(c=d.length;e<c;e++)m.setIdentity(),m.setOrigin(y(d[e].cShape.position)),m.setRotation(y(d[e].cShape.rotation)),a.addChildShape(m,d[e].btShape)}this.shape=a}return this.shape}};var h=function(){this.rigidObjects=[];this.active_count=0;this.collisionConfiguration=new btDefaultCollisionConfiguration;this.dispatcher=new btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=
new btDbvtBroadphase;this.solver=new btSequentialImpulseConstraintSolver;this.dynamicsWorld=new btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new btVector3(0,-10,0));if(!m||!c)m=new btTransform,c=new CubicVR.Quaternion};h.prototype={bindSceneObject:function(a,b){var e=new CubicVR.RigidBody(a,b);this.rigidObjects.push(e);e.getBody().activate();this.dynamicsWorld.addRigidBody(e.getBody());return e},bindRigidBody:function(a){this.rigidObjects.indexOf(a)===
-1&&(this.rigidObjects.push(a),a=a.getBody(),a.activate(),this.dynamicsWorld.addRigidBody(a))},getActiveCount:function(){return this.active_count},stepSimulation:function(a,b){this.dynamicsWorld.stepSimulation(a,b||2);for(var e=0,c=0,d=this.rigidObjects.length;c<d;c++)this.rigidObjects[c].updateSceneObject()&&e++;this.active_count=e}};return{ScenePhysics:h,RigidProperties:function(a){this.type=a.type!==o?a.type:r.physics.body.DYNAMIC;this.mass=a.mass!==o?a.mass:this.type?1:0;this.size=a.size||[1,
1,1];this.restitution=a.restitution||(this.type?0:1);this.friction=a.friction||1;if((this.collision=a.collision)&&!this.collision.getShapes)this.collision=new CubicVR.CollisionMap(this.collision)},RigidBody:t}});CubicVR.RegisterModule("Shader",function(t){function y(a,b){var e=CubicVR.util,g,d;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];a.indexOf("\n")!==-1?g=c(o.gl,a,"x-shader/x-vertex"):(g=h(o.gl,a),g===null&&(d=e.getURL(a),g=c(o.gl,d,"x-shader/x-vertex")));b.indexOf("\n")!==-1?d=c(o.gl,b,"x-shader/x-fragment"):(d=h(o.gl,b),d===null&&(d=e.getURL(b),d=c(o.gl,d,"x-shader/x-fragment")));this.shader=o.gl.createProgram();o.gl.attachShader(this.shader,g);o.gl.attachShader(this.shader,d);o.gl.linkProgram(this.shader);
if(!o.gl.getProgramParameter(this.shader,o.gl.LINK_STATUS))throw Error("Could not initialise shader vert("+a+"), frag("+b+")");}var s=t.undef,o=t.GLCore,r=CubicVR.enums,m=t.log;r.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var c=function(a,b,e){if(e==="x-shader/x-fragment")e=a.createShader(a.FRAGMENT_SHADER);else if(e==="x-shader/x-vertex")e=a.createShader(a.VERTEX_SHADER);
else return null;a.shaderSource(e,b);a.compileShader(e);if(!a.getShaderParameter(e,a.COMPILE_STATUS))return m(a.getShaderInfoLog(e)),null;return e},h=function(a,b){var e=document.getElementById(b);if(!e)return null;for(var c="",d=e.firstChild;d;)d.nodeType===3&&(c+=d.textContent),d=d.nextSibling;if(e.type==="x-shader/x-fragment")e=a.createShader(a.FRAGMENT_SHADER);else if(e.type==="x-shader/x-vertex")e=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(e,c);a.compileShader(e);a.getShaderParameter(e,
a.COMPILE_STATUS)||m(a.getShaderInfoLog(e));return e};y.prototype={bindSelf:function(a){var b,e,c;a.indexOf(".")!==-1?a.indexOf("[")!==-1?(b=a.split("["),c=b[0],b=b[1].split("]"),e=b[0],b=b[1].split("."),b=b[1],this[c]===s&&(this[c]=[]),this[c][e]===s&&(this[c][e]={}),this[c][e][b]=this.uniforms[a]):(b=a.split("."),c=b[0],b=b[1],this[c]===s&&(this[c]={}),this[c][b]=this.uniforms[a]):a.indexOf("[")!==-1?(b=a.split("["),c=b[0],b=b[1].split("]"),e=b[0],this[c]===s&&(this[c]=[]),this[c][e]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,b){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==s&&this.setMatrix(a,b);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,b){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
b!==s&&this.setVector(a,b);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,b){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==s&&this.setFloat(a,b);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,b){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==s&&this.setInt(a,b);this.bindSelf(a);return this.uniforms[a]},use:function(){o.gl.useProgram(this.shader)},setMatrix:function(a,b){var c=this.uniforms[a];if(c!==null){var g=b.length;g===16?o.gl.uniformMatrix4fv(c,!1,b):g===9?o.gl.uniformMatrix3fv(c,!1,b):g===
4&&o.gl.uniformMatrix2fv(c,!1,b)}},setInt:function(a,b){var c=this.uniforms[a];c!==null&&o.gl.uniform1i(c,b)},setFloat:function(a,b){var c=this.uniforms[a];c!==null&&o.gl.uniform1f(c,b)},setVector:function(a,b){var c=this.uniforms[a];if(c!==null){var g=b.length;g==3?o.gl.uniform3fv(c,b):g==2?o.gl.uniform2fv(c,b):o.gl.uniform4fv(c,b)}},clearArray:function(a){a=this.uniforms[a];a!==null&&o.gl.disableVertexAttribArray(a)},bindArray:function(a,b){var c=o.gl,g=this.uniforms[a];if(g!==null){var d=this.uniform_type[a];
d===r.shader.uniform.ARRAY_VERTEX?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(g,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(g)):d===r.shader.uniform.ARRAY_UV?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(g,2,c.FLOAT,!1,0,0)):d===r.shader.uniform.ARRAY_FLOAT&&(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(g,1,c.FLOAT,!1,0,0))}}};return{Shader:y}});CubicVR.RegisterModule("UVMapper",function(t){function y(a){a!==s?(this.rotation=a.rotation===s?[0,0,0]:a.rotation,this.scale=a.scale===s?[1,1,1]:a.scale,this.center=a.center===s?[0,0,0]:a.center,this.projection_mode=a.projectionMode===s?o.uv.projection.PLANAR:a.projectionMode,this.projection_axis=a.projectionAxis===s?o.uv.axis.X:a.projectionAxis,this.wrap_w_count=a.wrapW===s?1:a.wrapW,this.wrap_h_count=a.wrapH===s?1:a.wrapH):(this.rotation=[0,0,0],this.scale=[1,1,1],this.center=[0,0,0],this.projection_mode=
o.uv.projection.PLANAR,this.projection_axis=o.uv.axis.X,this.wrap_h_count=this.wrap_w_count=1)}var s=t.undef,o=CubicVR.enums,r=2*Math.PI,m=Math.PI/2;o.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var c=function(a,b,c){return a===0&&c===0?0:c===0?a<0?m:-m:c<0?-Math.atan(a/c)+Math.PI:-Math.atan(a/c)},h=function(a,b,c){var g;a===0&&c===0?(g=0,a=b!==0?b<0?-m:m:0):(g=c===0?a<0?m:-m:c<0?-Math.atan(a/c)+Math.PI:-Math.atan(a/c),a=Math.sqrt(a*a+c*c),a=a===0?b<
0?-m:m:Math.atan(b/a));return[g,a]};y.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,b,e,g,d){var q=CubicVR.mat4,n,t,C,w,y,E=new CubicVR.Transform,B=!1,x=null;if(this.center[0]||this.center[1]||this.center[2])E.translate(-this.center[0],
-this.center[1],-this.center[2]),B=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&E.rotate(this.rotation[2],0,0,1),this.rotation[1]&&E.rotate(this.rotation[1],0,1,0),this.rotation[2]&&E.rotate(this.rotation[0],1,0,0),B=!0;B&&(x=E.getResult());typeof b==="object"&&(b=a.materials.indexOf(b));var E=0,A=a.faces.length;g&&(E=g);for(d&&(A=d+1);E<A;E++)if(a.faces[E].material===b&&!(e!==s&&a.faces[E].segment!==e)){var z,u,Q;if(this.projection_mode===o.uv.projection.CUBIC||this.projection_mode===
o.uv.projection.SKY)z=Math.abs(a.faces[E].normal[0]),u=Math.abs(a.faces[E].normal[1]),Q=Math.abs(a.faces[E].normal[2]);for(var g=[],d=0,D=a.faces[E].points.length;d<D;d++){t=a.faces[E].points[d];var H=a.faces[E].points[(d+1)%3],L=a.faces[E].points[(d+2)%3];n=a.points[t];var F=a.points[H],J=a.points[L],G;B&&(n=q.vec3_multiply(n,x));G=this.projection_mode;if(G===o.uv.projection.SKY)t=a.sky_mapping,z>=u&&z>=Q&&(C=n[2]/this.scale[2]+this.scale[2]/2,w=-n[1]/this.scale[1]+this.scale[1]/2,a.faces[E].normal[0]<
0?(C=(t[2][2]-t[2][0])*(1-C),w=1-(t[2][3]-t[2][1])*w,C+=t[2][0],w+=t[2][1]):(C*=t[3][2]-t[3][0],w=1-(t[3][3]-t[3][1])*w,C+=t[3][0],w+=t[3][1])),u>=z&&u>=Q&&(C=n[0]/this.scale[0]+this.scale[0]/2,w=-n[2]/this.scale[2]+this.scale[2]/2,a.faces[E].normal[1]<0?(C*=t[1][2]-t[1][0],w=1-(t[1][3]-t[1][1])*w,C+=t[1][0],w-=t[1][1]):(C*=t[0][2]-t[0][0],w=1-(t[0][3]-t[0][1])*w,C+=t[0][0],w-=t[0][1])),Q>=z&&Q>=u&&(C=n[0]/this.scale[0]+this.scale[0]/2,w=n[1]/this.scale[1]+this.scale[1]/2,a.faces[E].normal[2]<0?(C*=
t[4][2]-t[4][0],w=1-(t[4][3]-t[4][1])*(1-w),C+=t[4][0],w-=t[4][1]):(C=(t[5][2]-t[5][0])*(1-C),w=1-(t[5][3]-t[5][1])*(1-w),C+=t[5][0],w+=t[5][1])),a.faces[E].setUV([C,w],d);else if(G===o.uv.projection.CUBIC)z>=u&&z>=Q&&(C=n[2]/this.scale[2]+0.5,w=n[1]/this.scale[1]+0.5),u>=z&&u>=Q&&(C=-n[0]/this.scale[0]+0.5,w=n[2]/this.scale[2]+0.5),Q>=z&&Q>=u&&(C=-n[0]/this.scale[0]+0.5,w=n[1]/this.scale[1]+0.5),a.faces[E].normal[0]>0&&(C=-C),a.faces[E].normal[1]<0&&(C=-C),a.faces[E].normal[2]>0&&(C=-C),a.faces[E].setUV([C,
w],d);else if(G===o.uv.projection.PLANAR)C=this.projection_axis===o.uv.axis.X?n[2]/this.scale[2]+0.5:-n[0]/this.scale[0]+0.5,w=this.projection_axis===o.uv.axis.Y?n[2]/this.scale[2]+0.5:n[1]/this.scale[1]+0.5,a.faces[E].setUV([C,w],d);else{if(G===o.uv.projection.CYLINDRICAL)G=this.projection_axis,G===o.uv.axis.X?(y=c(n[2],n[0],-n[1]),w=-n[0]/this.scale[0]+0.5):G===o.uv.axis.Y?(y=c(-n[0],n[1],n[2]),w=-n[1]/this.scale[1]+0.5):G===o.uv.axis.Z&&(y=c(-n[0],n[2],-n[1]),w=-n[2]/this.scale[2]+0.5),y=1-y/r,
this.wrap_w_count!==1&&(y*=this.wrap_w_count),n=y,t=w;else if(G===o.uv.projection.SPHERICAL){var I,K,N;G=this.projection_axis;G===o.uv.axis.X?(I=g[t]?g[t]:h(n[2],n[0],-n[1]),g[t]||(g[t]=I),K=g[H]?g[H]:h(F[2],F[0],-F[1]),g[H]||(g[H]=K),N=g[L]?g[L]:h(J[2],J[0],-J[1]),g[L]||(g[L]=N)):G===o.uv.axis.Y?(I=g[t]?g[t]:h(n[0],-n[1],n[2]),g[t]||(g[t]=I),K=g[H]?g[H]:h(F[0],-F[1],F[2]),g[H]||(g[H]=K),N=g[L]?g[L]:h(J[0],-J[1],J[2]),g[L]||(g[L]=N)):G===o.uv.axis.Z&&(I=g[t]?g[t]:h(-n[0],n[2],-n[1]),g[t]||(g[t]=I),
K=g[H]?g[H]:h(-F[0],F[2],-F[1]),g[H]||(g[H]=K),N=g[L]?g[L]:h(-J[0],J[2],-J[1]),g[L]||(g[L]=N));Math.abs(I[0]-K[0])>m&&Math.abs(I[0]-N[0])>m&&(I[0]>K[0]&&I[0]>N[0]?I[0]-=r:I[0]+=r);Math.abs(I[1]-K[1])>m&&Math.abs(I[1]-N[1])>m&&(I[1]>K[1]&&I[1]>N[1]?I[1]-=r:I[1]+=r);y=1-I[0]/r;t=0.5-I[1]/Math.PI;this.wrap_w_count!==1&&(y*=this.wrap_w_count);this.wrap_h_count!==1&&(t*=this.wrap_h_count);n=y}else t=n=0;a.faces[E].setUV([n,t],d)}}}return this}};return{UVMapper:y}});CubicVR.RegisterModule("Utility",function(t){var y=t.undef;return{util:{getScriptContents:function(s){var o=document.getElementById(s),r="",m="";if(o){if(o.src!==""||o.attributes.srcUrl!==y)m=o.src!==""?o.src:o.attributes.srcUrl.value}else m=s;if(m.length!==0){if(s=new XMLHttpRequest,s.open("GET",m,!1),s.send(null),s.status===200||s.status===0)r=s.responseText}else for(m=o.firstChild;m;)m.nodeType===3&&(r+=m.textContent),m=m.nextSibling;return r},getURL:function(s){try{var o=new XMLHttpRequest;o.open("GET",
s,!1);o.send(null);if(o.status===200||o.status===0)if(o.responseText.length)return o.responseText;else if(o.responseXML)return o.responseXML}catch(r){alert(s+" failed to load.")}return null},getXML:function(s){try{var o=new XMLHttpRequest;o.open("GET",s,!1);o.overrideMimeType("application/xml");o.send(null);if(o.status===200||o.status===0)return o.responseXML}catch(r){try{alert(s+" failed to load.")}catch(m){throw r;}}return null},getJSON:function(s){try{var o=new XMLHttpRequest;o.open("GET",s,!1);
o.overrideMimeType("application/json");o.send(null);if(o.status===200||o.status===0)return eval("("+o.responseText+")")}catch(r){try{alert(s+" failed to load.")}catch(m){throw r;}}return null},repackArray:function(s,o,r){s.length!==parseInt(o,10)*parseInt(r,10)&&log("array repack error, data size !== stride*count: data.length="+s.length+" stride="+o+" count="+r);for(var r=[],m=0,c=0,h=s.length;c<h;c++){var a=c%o;a===0&&(r[m]=[]);r[m][a]=s[c];a===o-1&&m++}return r},collectTextNode:function(s){if(!s)return"";
for(var o="",s=s.childNodes,r=0,m=s.length;r<m;r++)o+=s[r].nodeValue;return o},floatDelimArray:function(s,o){for(var r=s.split(o?o:","),m=0,c=r.length;m<c;m++)r[m]=parseFloat(r[m]);r[r.length-1]!==r[r.length-1]&&r.pop();return r},intDelimArray:function(s,o){for(var r=s.split(o?o:","),m=0,c=r.length;m<c;m++)r[m]=parseInt(r[m],10);r[r.length-1]!==r[r.length-1]&&r.pop();return r},textDelimArray:function(s,o){for(var r=s.split(o?o:","),m=0,c=r.length;m<c;m++)r[m]=r[m];return r},xml2badgerfish:function(s){var o=
{},r=[],m,c,h,a,b,e=/^\s+|\s+$/g;s.jsonParent=o;for(r.push(s);r.length;){c=r.pop();var g=null;h=c.jsonParent;s=0;for(m=c.childNodes.length;s<m;s++)a=c.childNodes[s],b=a.tagName,b!==y&&(g=g||{},g[b]=g[b]||0,g[b]++);if(c.attributes&&c.attributes.length){s=0;for(m=c.attributes.length;s<m;s++)a=c.attributes[s],h["@"+a.name]=a.value}s=0;for(m=c.childNodes.length;s<m;s++)if(a=c.childNodes[s],b=a.tagName,a.nodeType===1)g[b]>1?(h[b]=h[b]||[],h[b].push({}),a.jsonParent=h[b][h[b].length-1]):(h[b]=h[b]||{},
a.jsonParent=h[b]),r.push(a);else if(a.nodeType===3&&a.nodeValue.replace(e,"")!=="")h.$=h.$||"",h.$+=a.nodeValue}return o}}}});CubicVR.RegisterModule("Worker",function(t){function y(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){a.data.message!=="init"&&b.message(a.data)},!1)}function s(a){function b(a){setTimeout(function(){c.send("test",a)},1E3)}a&&b(a);var c=new y({message:b})}function o(a){function b(a){a=v.getURL(a);c.send("done",a.length)}var c;c=new y({message:function(a){b(a)}});a&&b(a)}function r(a){function b(a){a=
v.getURL(a);c.send("loaded",a)}var c,d;c=new y({message:function(a){if(a.message==="parse")d=new n,CubicVR.loadCollada("","",d,a.data),c.send("parsed");else if(a.message==="getMesh"){if(a=d.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());c.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function m(b){function c(b){var e=new a,g;for(g in b)b.hasOwnProperty(g)&&(e[g]=b[g]);b=e.triangulateQuads().compileVBO(e.compileMap());
d.send("done",b)}var d;d=new y({message:function(a){c(a)}});b&&c(b)}try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(c){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var h=t.undef,a=CubicVR.Mesh,b=CubicVR.Texture,e=CubicVR.Material,g=CubicVR.SceneObject,d=CubicVR.Motion,q=CubicVR.Envelope,n=CubicVR.DeferredBin,v=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");
this.message=a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,c){b.worker.postMessage({message:a,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function c(b){var d=
b.parsed||function(){},e={},g;b.url.match(/\.dae/)&&(g=new CubicVR.Worker({type:"sceneFile",data:b.url,message:function(b){if(b.message==="loaded"){var b=(new DOMParser).parseFromString(b.data,"text/xml"),c=v.xml2badgerfish(b);console.log(b);g.send("parse",c)}else if(b.message==="getMesh"){var c=new a,h;for(h in b.data.mesh)b.data.mesh.hasOwnProperty(h)&&(c[h]=b.data.mesh[h]);c.bindBuffer(c.bufferVBO(b.data.vbo));e.getMesh&&e.getMesh(c)}else b.message==="parsed"&&d()}}));this.getSceneObject=function(a,
b){g.send("getMesh",a);e.getMesh=b}}function d(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var h=this,m={};this.createSceneFileManager=function(a){var b=new c({url:a.url,parsed:a.parsed});return m[a.url]=b};this.removeSceneFileManager=function(a){if(typeof settings==="string")delete m[settings];else for(var b in m)m[b]===a&&delete m[b]};this.createSceneObjectFromMesh=function(c){var m=c.scene,n=c.object,o=c.assetBase||"",q=h.createSceneFileManager({url:c.mesh,parsed:function(){n&&
q.getSceneObject(n,function(c){for(var c=d(c,new a),h=0,n=c.materials.length;h<n;++h){for(var q=d(c.materials[h],new e),r=0,s=q.textures.length;r<s;++r){var t=q.textures[h];q.textures[h]=new b(o+t.img_path,t.filter_type)}c.materials[h]=q}c=new g(c);m.bindSceneObject(c)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(c,m,n,o){var r;try{r=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(s){throw Error("Can't find collada.js");
}var t=[],v=[];r.onmessage=function(m){function r(a,b){for(var c in a)b[c]=a[c]}function s(a){if(a.motion){for(var b=a.motion.controllers,c=[],e=0,g=b.length;e<g;++e){var h=b[e];if(h){for(var m=[],n=0,o=h.length;n<o;++n){var t=h[n];if(t){var u=t.keys[0];if(t.keys.length>1)u.prev=null,u.next=t.keys[1],u=t.keys[1];for(var v=1,w=t.keys.length-1;v<w;++v)u.prev=t.keys[v-1],u.next=t.keys[v+1],u=t.keys[v+1];if(t.keys.length>1)u=t.keys[t.keys.length-1],u.prev=t.keys[t.keys.length-2],u.next=null;t.firstKey=
t.keys[0];t.lastKey=t.keys[t.keys.length-1];t.keys=t.firstKey;u=new q;r(t,u);m[n]=u}else h[n]=null}c[e]=m}else b[e]=null}a.motion.controllers=c;b=new d;r(a.motion,b);a.motion=b}}function x(b){var d=new g;r(b,d);if(b.obj!==null){var e=v[b.obj.id];if(e===h)if(e=new a,r(b.obj,e),d.obj=e,v[b.obj.id]=e,o){if(e.points.length>0){o.addMesh(c,c+":"+e.id,e);for(var m=0,n=e.faces.length;m<n;++m){var q=e.faces[m],s=q.material;q.material=t[s]!==h?t[s]:0}}}else d.obj.triangulateQuads(),d.obj.calcNormals(),d.obj.compile(),
d.obj.clean();else d.obj=e}d.trans=new Transform;if(b.children&&b.children.length>0&&(d.children=[],b.children)){e=0;for(m=b.children.length;e<m;++e)n=x(b.children[e]),d.bindChild(n)}return d}var w;w=m.data.message;if(w=="materials"){var y=JSON.parse(m.data.data),m=0;for(w=y.length;m<w;++m){var B=new e(y[m].name),G=B.material_id;r(y[m],B);B.material_id=G;t[y[m].material_id]=G;for(var G=0,I=y[m].textures.length;G<I;++G){var K=y[m].textures[G];if(K){var N=Texture_ref[K.img_path];N===h?(K=new b(K.img_path,
K.filter_type,o,c),B.textures[G]=K):B.textures[G]=Textures_obj[N]}else B.textures[G]=0}}}else if(w=="scene"){y=JSON.parse(m.data.data);m=0;for(w=y.sceneObjects.length;m<w;++m){B=y.sceneObjects[m];B.obj!==null&&nop();if(B.reassembled===h)s(B),B.reassembled=!0;y.sceneObjects[m]=x(B)}B=new Scene;m=B.camera;w=m.transform;r(y.camera,m);r(y.camera.transform,w);s(m);B.camera=m;B.camera.transform=w;B.camera.frustum=new Frustum;m=0;for(w=y.sceneObjects.length;m<w;++m){G=y.sceneObjects[m];B.bindSceneObject(G);
try{G.getAABB()}catch(S){}}m=0;for(w=y.lights.length;m<w;++m)G=new Light,r(y.lights[m],G),G.trans=new Transform,s(G),B.bindLight(G);n(B)}else console.log("message from collada worker:",m.data.message)};r.onerror=function(a){console.log("error from collada worker:",a.message)};r.postMessage({message:"start",params:{meshUrl:c,prefix:m,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:s,prepareMesh:m,file:o,sceneFile:r};self.addEventListener("message",function(b){if(b.data.message===
"init"){var c=b.data.data.type;if(c in a)new a[c](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
/* Auto Embed ./CubicVR_Core.vs */
window.CubicVR.CubicVRCoreVS="attribute vec3 aVertexPosition;\nattribute vec3 aNormal;\nattribute vec2 aTextureCoord;\n#if hasVertexColorMap\nattribute vec3 aColor;\nvarying vec3 cmapColor;\n#endif\n#if hasMorph\nattribute vec3 amVertexPosition;\nattribute vec3 amNormal;\nuniform float morphWeight;\n#endif\nvarying vec2 vTextureCoord;\n#if !perPixel\n#if lightPoint||lightDirectional||lightSpot||lightArea\nuniform vec3 lDir[loopCount];\nuniform vec3 lPos[loopCount];\nuniform vec3 lSpec[loopCount];\nuniform vec3 lDiff[loopCount];\nuniform float lInt[loopCount];\nuniform float lDist[loopCount];\n#if lightSpot\nuniform float lCut[loopCount];\n#endif\nvarying vec3 vColor;\nvarying vec3 vSpec;\n#endif\nuniform vec3 mDiff;\nuniform vec3 mSpec;\nuniform float mShine;\n#endif\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nuniform mat4 uOMatrix;\nuniform mat3 uNMatrix;\nvarying vec3 vNormal;\nvarying vec4 vPosition;\n#if !depthPack\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform mat4 spMatrix[loopCount];\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasBumpMap||hasNormalMap\nvarying vec3 eyeVec;\n#endif\n#endif \nvoid main(void)\n{\nmat4 uMVOMatrix = uMVMatrix * uOMatrix;\nmat4 uMVPMatrix = uPMatrix * uMVMatrix;\n#if hasMorph\nvPosition = uMVOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\n#else\nvPosition = uMVOMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition, 1.0);\n#endif\nvTextureCoord = aTextureCoord;\n#if !depthPack\n#if hasVertexColorMap\ncmapColor = aColor;\n#endif\n#if hasMorph\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal+(amNormal-aNormal)*morphWeight,0.0)).xyz;\n#else\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal,0.0)).xyz;\n#endif\n#if !perPixel\n#if lightPoint\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < loopCount; i++) {\nvec3 lDir = lPos[i]-vPosition.xyz;\nfloat dist = length(lDir);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lDir);\nfloat NdotL = max(dot(normalize(lDir),vNormal),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\naccum += att * NdotL * lDiff[i] * mDiff;\nfloat NdotHV = max(dot(vNormal, halfVector),0.0);\nvec3 spec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\nspecTotal += spec2;\n}\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#if lightDirectional\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),vNormal),0.0);\nif (NdotL > 0.0)   {\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\nNdotHV = max(dot(vNormal, halfVector),0.0);\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\nspecTotal += spec2;\n}\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#if lightSpot\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < loopCount; i++) {\nvec3 l = lPos[i]-vPosition.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lDir[i]));\nif ( spotDot < cos((lCut[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vPosition.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vNormal, normalize(l)));\nfloat NdotH = max(0.0, dot(vNormal, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, mShine);\n}\nelse {\npower = 0.0;\n}\naccum += att * lDiff[i] * mDiff * NdotL;\nspec2 = lSpec[i] * mSpec * power;\nspecTotal += spec2*spotEffect;\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#endif \n#if hasBumpMap||hasNormalMap\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( aNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( aNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(aNormal, tangent);\nbinormal = normalize(binormal);\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (aNormal, 0.0)))\n);\neyeVec = vec3(uMVOMatrix * vec4(aVertexPosition,1.0)) * TBNMatrix;\n#endif\n#if (lightSpot||lightArea) && hasShadow\nfor (int i = 0; i < loopCount; i++)\n{\n#if hasShadow\n#if hasMorph\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0));\n#else\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nu = normalize( vPosition.xyz );\n#else\nvec3 ws = (uMVMatrix * vec4(aVertexPosition,1.0)).xyz;\nvec3 u = normalize( vPosition.xyz );\nvec3 r = reflect(ws, vNormal );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvEnvTextureCoord.s = r.x/m + 0.5;\nvEnvTextureCoord.t = r.y/m + 0.5;\n#endif\n#endif\n#endif \n}\n";
/* Auto Embed ./CubicVR_Core.fs */
window.CubicVR.CubicVRCoreFS="#ifdef GL_ES\n#if perPixel\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\nuniform vec3 mAmb;\nuniform vec3 lAmb;\nuniform vec3 mColor;\n#if perPixel\nuniform vec3 mDiff;\nuniform vec3 mSpec;\nuniform float mShine;\n#if lightPoint||lightDirectional||lightSpot||lightArea\nuniform vec3 lDir[loopCount];\nuniform vec3 lPos[loopCount];\nuniform vec3 lSpec[loopCount];\nuniform vec3 lDiff[loopCount];\nuniform float lInt[loopCount];\nuniform float lDist[loopCount];\n#if lightSpot\nuniform float lCut[loopCount];\n#endif\n#endif\n#if hasProjector\nuniform sampler2D lProjTex[loopCount];\n#endif\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform sampler2D lDepthTex[loopCount];\nuniform vec3 lDepth[loopCount];\n#endif\n#else \nvarying vec3 vColor;\nvarying vec3 vSpec;\n#endif  \nvarying vec3 vNormal;\nvarying vec2 vTextureCoord;\n#if hasVertexColorMap\nvarying vec3 cmapColor;\n#endif\n#if alphaDepth||depthPack||hasShadow\nuniform vec3 depthInfo;\nfloat ConvertDepth3(float d) { return (depthInfo.x*depthInfo.y)/(depthInfo.y-d*(depthInfo.y-depthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - depthInfo.x ) / ( depthInfo.y - depthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if depthPack\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if hasShadow\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if softShadow\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !depthPack\n#if hasColorMap\nuniform sampler2D colorMap;\n#endif\n#if hasBumpMap\nvarying vec3 eyeVec;\nuniform sampler2D bumpMap;\n#endif\n#if hasEnvSphereMap\nuniform sampler2D envSphereMap;\nuniform float envAmount;\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasReflectMap\nuniform sampler2D reflectMap;\n#endif\n#if hasNormalMap\nuniform sampler2D normalMap;\n#endif\nuniform float mAlpha;\n#if hasAmbientMap\nuniform sampler2D ambientMap;\n#endif\n#if hasSpecularMap\nuniform sampler2D specularMap;\n#endif\n#endif \n#if hasAlphaMap\nuniform sampler2D alphaMap;\n#endif\nvarying vec4 vPosition;\nuniform mat4 uPMatrix;\nvoid main(void)\n{\n#if depthPack\nvec2 texCoord = vTextureCoord;\n#else\nvec3 n;\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if hasBumpMap\nfloat height = texture2D(bumpMap, vTextureCoord.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(eyeVec);\nvec2 texCoord = vTextureCoord.xy + (eye.xy * v);\n#else\nvec2 texCoord = vTextureCoord;\n#endif\n#if hasNormalMap\nvec3 bumpNorm = vec3(texture2D(normalMap, texCoord));\nn = (vec4(normalize(vNormal),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nn = normalize((n+bumpNorm)/2.0);\n#else\nn = normalize(vNormal);\n#endif\n#if hasColorMap\n#if !(lightPoint||lightDirectional||lightSpot||lightArea)\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\ncolor.rgb *= mColor;\n#else\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\ncolor.rgb *= mColor;\n#endif\nif (color.a<=0.9) discard;\n#else\n#if hasVertexColorMap\ncolor = vec4(cmapColor,1.0);\n#else\ncolor = vec4(mColor,1.0);\n#endif\n#endif\n#if hasAlphaMap\ncolor.a = texture2D(alphaMap, texCoord).r;\n#if alphaDepth\nif (color.a < 0.9) discard;\n#else\n#if !hasAlpha\nif (color.a<0.9) discard;\n#else\nif (color.a==0.0) discard;\n#endif\n#endif\n#else\n#if hasAlpha\ncolor.a = mAlpha;\n#endif\n#endif\nvec3 accum = lAmb;\n#if perPixel\n#if lightPoint\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < loopCount; i++) {\nvec3 lDir = lPos[i]-vPosition.xyz;\nfloat dist = length(lDir);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lDir);\nfloat NdotL = max(dot(normalize(lDir),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\naccum += att * NdotL * lDiff[i] * mDiff;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nvec3 spec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nvec3 spec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightDirectional\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightArea\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\naccum += shadow * lInt[i] * mDiff * lDiff[i] * NdotL;\n#else\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\n#endif\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if hasShadow\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightSpot\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < loopCount; i++) {\nvec3 l = lPos[i]-vPosition.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lDir[i]));\nif ( spotDot < cos((lCut[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !hasProjector\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vPosition.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, mShine);\n}\nelse {\npower = 0.0;\n}\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if hasProjector && hasShadow\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lProjTex[i],shadowCoord.st).rgb;\naccum += att * projTex * lInt[i] * mDiff * lDiff[i] * NdotL;\n}\n#else\naccum += att * lDiff[i] * mDiff * NdotL;\n#endif\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lSpec[i] * mSpec * power;\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if hasShadow\n#endif\n#endif\n#else\n#if lightPoint||lightDirectional||lightSpot||lightArea\ncolor.rgb *= vColor;\ncolor.rgb += vSpec;\n#endif\n#endif \n#if hasReflectMap\nfloat environmentAmount = texture2D( reflectMap, texCoord).r;\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvec3 r = reflect( u, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * envAmount;\n#endif\n#else\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb*envAmount;\n#endif\n#endif\n#endif\n#if hasAmbientMap\n#if lightPoint||lightDirectional||lightSpot||lightArea\ncolor.rgb += texture2D(ambientMap, texCoord).rgb*(vec3(1.0,1.0,1.0)+mColor*mAmb);\n#else\ncolor.rgb = color.rgb*texture2D(ambientMap, texCoord).rgb;\n#endif\n#else\n#if !hasColorMap\ncolor.rgb += mColor*mAmb;\n#else\ncolor.rgb += mAmb*texture2D(colorMap, texCoord).rgb;\n#endif\n#endif\n#if alphaDepth\n#if !hasAlpha\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\ngl_FragColor = clamp(color,0.0,1.0);\n#endif \n#if depthPack\n#if hasAlphaMap\nfloat alphaVal = texture2D(alphaMap, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\ngl_FragColor = packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n#endif\n}\n";
